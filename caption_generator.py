import random
import re
import logging

logger = logging.getLogger(__name__)

# ── 수壽 계정 고정 요소 ──

_SIGNATURE = (
    "- \n\n"
    "더 오래, 더 건강하게.\n"
    "한의사가 만든 한의 브랜드, 수壽\n"
    "@thesoo_official \n"
    "-"
)

_CTAS = [
    "지금 바로 프로필 링크를 클릭하고\n공식 홈페이지를 확인하세요.",
    "지금 프로필링크 클릭하고\n공식 홈페이지를 살펴보세요",
    "지금 바로 프로필 링크를 클릭하고\n수壽를 만나보세요.",
]

_BRAND_HASHTAGS = ["수한약", "공진단수", "경옥고수"]
_EXTRA_HASHTAGS = ["이정재공진단", "이정재경옥고"]

# ── 주제 감지 매핑 ──
# OCR 텍스트(정제 전 원본 포함)의 키워드 → 주제 카테고리 매핑
_TOPIC_KEYWORDS = {
    "뇌건강": ["뇌", "BDNF", "강글리오사이드", "신경", "뇌세포", "인지", "기억력", "집중력", "두뇌", "치매"],
    "녹용": ["녹용", "녹각", "사슴", "뿔", "성장인자", "IGF"],
    "공진단": ["공진단", "사향", "당귀", "산수유", "왕실", "보약"],
    "경옥고": ["경옥고", "생지황", "인삼", "백복령", "꿀"],
    "면역력": ["면역", "면역력", "항체", "백혈구", "감기", "바이러스", "방어", "감염", "열"],
    "활력": ["활력", "피로", "에너지", "기력", "체력", "원기", "보양", "기운", "후유증"],
    "품질": ["hGMP", "GMP", "인증", "검사", "품질", "살균", "세척", "위생", "안전"],
    "원료": ["원료", "약재", "한약재", "산지", "지리산", "구례", "의성", "엄선"],
    "기술력": ["초미립자", "분쇄", "입자", "흡수율", "기술", "균일", "미세"],
    "전통": ["동의보감", "전통", "처방", "역사", "왕", "조선", "1196년", "800년"],
    "수면": ["수면", "숙면", "불면", "잠", "밤", "멜라토닌", "수면질"],
    "혈액순환": ["혈액", "순환", "혈관", "혈류", "혈행", "어혈"],
    "소화": ["소화", "위장", "장", "소화기", "장건강"],
    "피부": ["피부", "콜라겐", "노화", "안티에이징", "탄력", "윤기"],
    "다이어트": ["다이어트", "체중", "체지방", "대사", "신진대사"],
    "호흡기": ["호흡기", "폐", "기관지", "코", "축농증", "비염", "기침", "가래"],
    "명절건강": ["명절", "설날", "추석", "연휴", "후유증", "과식", "소화불량"],
    "환절기": ["환절기", "일교차", "계절", "겨울", "봄", "가을"],
    "걷기": ["걷기", "보폭", "보행", "걸음", "산책", "걷는", "걸을", "자세", "무릎", "관절", "굳은살", "발바닥", "밑창", "스트레칭"],
    "운동": ["운동", "스쿼트", "플랭크", "근력", "유산소", "헬스", "트레이닝", "스트레칭", "요가", "필라테스"],
}

# ── 주제별 고품질 콘텐츠 라이브러리 ──
# 보도자료·논문·전문 지식 기반으로 사전 작성된 완성도 높은 본문
# 각 주제당 여러 변형을 제공하여 다양성 확보

_TOPIC_HOOKS = {
    "뇌건강": [
        "두뇌 활력의 비밀",
        "뇌 건강, 지금부터 준비하세요",
        "건강한 뇌를 위한 선택",
    ],
    "녹용": [
        "자연이 선물한 최고의 보양",
        "녹용의 진가를 경험하세요",
        "녹용, 그 특별한 효능",
    ],
    "공진단": [
        "800년 역사가 증명하는 효능",
        "왕실의 보약, 공진단",
        "기력 충전의 시작",
    ],
    "경옥고": [
        "호흡기 건강의 든든한 파트너",
        "면역력의 기본, 경옥고",
        "자연의 면역 강화제",
    ],
    "면역력": [
        "면역력이 곧 건강입니다",
        "몸의 방어력을 높이는 방법",
        "건강의 첫 번째 조건, 면역력",
        "감기 이기는 몸을 만드는 법",
    ],
    "활력": [
        "오늘의 활력을 위한 선택",
        "지치지 않는 하루의 비결",
        "활력 넘치는 일상을 위해",
    ],
    "품질": [
        "자신있게 권할 수 있는 퀄리티",
        "안전함이 기본입니다",
        "한 번 더 검증하는 품질 관리",
    ],
    "원료": [
        "원료의 차이가 결과의 차이",
        "자연 그대로, 깨끗하게",
        "엄선된 약재의 힘",
    ],
    "기술력": [
        "일반 분말보다 15배 더 미세하게",
        "기술력이 만드는 차이",
        "과학이 증명하는 효과",
    ],
    "전통": [
        "전통과 현대의 융합",
        "800년이라는 시간 그 이상의 가치",
        "동의보감의 지혜를 잇다",
    ],
    "호흡기": [
        "호흡기 건강, 예방이 최선입니다",
        "숨 쉬는 것이 편안해지는 방법",
        "호흡기 면역력을 높이는 선택",
    ],
    "명절건강": [
        "명절 후 몸이 보내는 신호",
        "연휴 후유증, 가볍게 넘기는 법",
        "명절 피로, 방치하지 마세요",
    ],
    "환절기": [
        "환절기, 면역력이 답입니다",
        "계절이 바뀔 때 몸이 필요로 하는 것",
        "일교차가 클수록 건강 관리가 중요합니다",
    ],
    "걷기": [
        "당신의 보폭은 건강을 말해줍니다",
        "걷기, 가장 쉬운 건강 습관",
        "올바른 보행이 건강의 시작입니다",
        "걷기만 잘해도 달라집니다",
    ],
    "운동": [
        "운동, 꾸준함이 최고의 보약입니다",
        "건강한 몸은 움직임에서 시작됩니다",
        "매일 30분, 몸이 달라집니다",
    ],
    "수면": [
        "깊은 잠이 건강의 시작입니다",
        "숙면의 비밀",
        "잠이 보약이라는 말, 사실입니다",
    ],
    "혈액순환": [
        "혈액순환이 건강의 기본입니다",
        "막힘 없는 혈관, 활력 있는 하루",
    ],
    "소화": [
        "편안한 소화가 건강의 시작입니다",
        "위장 건강을 지키는 방법",
    ],
    "피부": [
        "안에서부터 빛나는 피부",
        "건강한 피부는 몸 안에서 시작됩니다",
    ],
}

# 주제별 본문 라이브러리 (보도자료·논문·전문 지식 기반)
# 각 주제당 2~3개 변형, 수壽 스타일로 작성
_TOPIC_BODIES = {
    "면역력": [
        (
            "면역력은 우리 몸의 방어 체계입니다.\n"
            "외부 바이러스와 세균으로부터\n"
            "몸을 보호하는 가장 기본적인 힘입니다.\n\n"
            "면역력이 약해지면 감기에 걸리기 쉽고\n"
            "회복 속도도 느려집니다.\n\n"
            "수壽는 면역력 강화에 도움이 되는\n"
            "검증된 한약재로 몸의 방어력을 높입니다."
        ),
        (
            "환절기에 감기가 반복된다면\n"
            "면역력 저하를 의심해 볼 필요가 있습니다.\n\n"
            "충분한 수면, 균형 잡힌 식사와 함께\n"
            "한약으로 면역 기능을 보충하면\n"
            "계절 변화에도 끄떡없는 몸을 만들 수 있습니다.\n\n"
            "수壽가 제안하는 건강한 면역 관리를\n"
            "지금 시작해 보세요."
        ),
        (
            "대한한의학회 연구에 따르면\n"
            "한약재에 포함된 다당류와 사포닌 성분이\n"
            "면역세포의 활성화에 도움을 줍니다.\n\n"
            "수壽는 이러한 과학적 근거를 바탕으로\n"
            "면역력 강화에 최적화된 처방을 제공합니다."
        ),
    ],
    "뇌건강": [
        (
            "뇌세포는 한 번 손상되면\n"
            "회복이 어렵기 때문에\n"
            "예방이 무엇보다 중요합니다.\n\n"
            "녹용에 함유된 강글리오사이드와\n"
            "뇌유래신경영양인자(BDNF)는\n"
            "뇌세포 보호와 인지 기능 유지에\n"
            "도움을 주는 것으로 알려져 있습니다.\n\n"
            "수壽는 최상급 녹용을 엄선하여\n"
            "두뇌 건강을 위한 최선의 선택을 제공합니다."
        ),
        (
            "기억력과 집중력은\n"
            "나이가 들수록 관리가 필요합니다.\n\n"
            "녹용의 핵심 성분인 강글리오사이드는\n"
            "신경세포 성장을 촉진하고\n"
            "인지 기능을 지원하는 것으로\n"
            "다수의 연구를 통해 확인되었습니다.\n\n"
            "수壽와 함께 두뇌 건강을\n"
            "지금부터 준비하세요."
        ),
    ],
    "녹용": [
        (
            "녹용은 예로부터\n"
            "기력 회복과 성장에 도움을 주는\n"
            "대표적인 보양 약재입니다.\n\n"
            "녹용에는 콘드로이틴, 콜라겐,\n"
            "강글리오사이드 등 유효 성분이 풍부하여\n"
            "면역력 강화와 체력 증진에 탁월합니다.\n\n"
            "수壽는 뉴질랜드산 최상급 녹용만을\n"
            "엄선하여 사용합니다."
        ),
        (
            "녹용의 효능은\n"
            "수천 년간의 임상 경험과\n"
            "현대 과학 연구로 모두 입증되었습니다.\n\n"
            "기력 보충, 면역 강화, 성장 촉진까지\n"
            "남녀노소 누구에게나\n"
            "도움이 되는 천연 보양제입니다.\n\n"
            "수壽의 녹용은 원료 선별부터 가공까지\n"
            "한의사가 직접 관리합니다."
        ),
    ],
    "공진단": [
        (
            "1196년부터 시작된 공진단의 역사,\n"
            "단순한 한약을 넘어 조선의 왕들이 아끼고 사랑했던\n"
            "'왕실 대표 보약'입니다.\n\n"
            "사향, 녹용, 당귀, 산수유 등\n"
            "귀한 약재의 조합이\n"
            "기력 회복과 면역력 강화에 탁월합니다.\n\n"
            "수壽가 그 전통을 이어갑니다."
        ),
        (
            "공진단은 동의보감에도 기록된\n"
            "대표적인 보양 처방으로\n"
            "몸의 원기를 근본적으로 보충합니다.\n\n"
            "피로감이 지속되거나\n"
            "잦은 감기로 고생하신다면\n"
            "공진단으로 기력을 회복해 보세요.\n\n"
            "수壽는 CITES 인증 정품 사향만을 사용하여\n"
            "효과와 안전성을 모두 보장합니다."
        ),
    ],
    "경옥고": [
        (
            "경옥고는 생지황, 인삼, 백복령, 꿀로\n"
            "구성된 전통 보양 처방입니다.\n\n"
            "폐와 호흡기 건강을 돕고\n"
            "면역력을 강화하는 데\n"
            "탁월한 효과가 있습니다.\n\n"
            "수壽의 경옥고는 전통 처방 그대로\n"
            "정성을 다해 조제합니다."
        ),
        (
            "호흡기가 건조해지는 계절,\n"
            "경옥고가 그 해답입니다.\n\n"
            "경옥고의 주재료인 생지황은\n"
            "폐에 윤기를 더하고\n"
            "인삼은 기력을 보충합니다.\n\n"
            "수壽는 최상급 원료만을 사용하여\n"
            "경옥고 본연의 효과를 극대화했습니다."
        ),
    ],
    "활력": [
        (
            "하루의 활력은\n"
            "좋은 원료에서 시작됩니다.\n\n"
            "만성 피로와 무기력함은\n"
            "단순한 휴식만으로는 해결되지 않습니다.\n"
            "근본적인 기력 보충이 필요합니다.\n\n"
            "수壽와 함께 활기찬 일상을 만들어보세요."
        ),
        (
            "아침에 일어나기 힘들고\n"
            "오후만 되면 피로가 밀려온다면\n"
            "몸이 보내는 신호입니다.\n\n"
            "한의학에서는 이를 '기허(氣虛)'라 하며\n"
            "기력을 보충하는 처방으로\n"
            "근본적인 회복을 도모합니다.\n\n"
            "수壽가 제안하는 기력 충전을\n"
            "지금 경험해 보세요."
        ),
    ],
    "품질": [
        (
            "한약의 퀄리티를 결정하는 것은 좋은 약재,\n"
            "깨끗하고 엄격한 조제 과정입니다.\n\n"
            "한의사와 한약사의 관리 아래\n"
            "엄선된 한약재를 깨끗이 세척하고\n"
            "모든 공정에 살균 처리 과정을 도입했습니다."
        ),
        (
            "식품의약품안전처의\n"
            "hGMP 인증을 받은 한약재만을 사용합니다.\n\n"
            "자체 성분 유전자 검사를 통과한\n"
            "엄선된 재료로 만들고\n\n"
            "사향과 침향은\n"
            "국제거래협약(CITES)에 따라\n"
            "허가받은 정품만을 사용합니다."
        ),
    ],
    "원료": [
        (
            "동의보감에 기록된 전통 처방을 바탕으로\n"
            "구례, 의성, 지리산 등\n"
            "전국 각지에서 엄선된 한약재로\n"
            "믿을 수 있는 한약을 조제합니다."
        ),
        (
            "전국 각지에서 엄선된 최상급 한약재로\n"
            "한의사가 직접 관리하며\n"
            "믿을 수 있는 한약을 만듭니다.\n\n"
            "원료의 품질이 곧\n"
            "한약의 효과를 결정합니다."
        ),
    ],
    "기술력": [
        (
            "초미립자 균일 분쇄 기술을 통해\n"
            "일반 분말보다 최대 15배 더 미세한 입자를 구현했습니다.\n\n"
            "입자가 작아질수록 체내 흡수율은 높아지고,\n"
            "입안에 남는 거친 느낌 없이 목 넘김은 더욱 부드러워집니다."
        ),
    ],
    "전통": [
        (
            "수는 전통의 지혜와 현대의 기술을\n"
            "조화롭게 결합하는 것이\n"
            "중요하다고 믿습니다.\n\n"
            "조제과정에서 효과적인 부분을 선별하고,\n"
            "최신 기술을 접목하여 최고의 효과를 내면서도\n"
            "안전한 한약을 제공합니다.\n\n"
            "고유의 노하우와 기술이 결합된\n"
            "현대 한약을 경험해 보세요."
        ),
    ],
    "호흡기": [
        (
            "호흡기 건강은\n"
            "외부 바이러스를 막는 첫 번째 방어선입니다.\n\n"
            "코와 기관지의 점막이 건조해지면\n"
            "감기와 비염에 취약해집니다.\n\n"
            "경옥고에 함유된 생지황과 인삼은\n"
            "폐에 윤기를 더하고 호흡기 면역력을 높여\n"
            "건조한 계절에도 건강을 지켜줍니다."
        ),
        (
            "기침이 오래가거나\n"
            "코가 자주 막힌다면\n"
            "호흡기 면역력을 점검해 볼 때입니다.\n\n"
            "한의학에서는 폐(肺)를 보하는 처방으로\n"
            "호흡기 건강의 근본을 다스립니다.\n\n"
            "수壽가 제안하는 호흡기 건강 관리,\n"
            "지금 시작하세요."
        ),
    ],
    "명절건강": [
        (
            "명절 연휴 동안 불규칙한 생활과\n"
            "과식, 스트레스가 쌓이면\n"
            "몸의 기력이 급격히 떨어집니다.\n\n"
            "소화 불량, 피로감, 면역력 저하는\n"
            "명절 후유증의 대표 증상입니다.\n\n"
            "연휴 후 빠른 회복을 위해\n"
            "수壽와 함께 기력을 충전하세요."
        ),
        (
            "명절이 끝나면 찾아오는 피로감,\n"
            "그냥 지나치지 마세요.\n\n"
            "연휴 동안 쌓인 피로는\n"
            "충분한 수면과 함께\n"
            "기력 보충이 필요합니다.\n\n"
            "공진단으로 기력을 회복하고\n"
            "활기찬 일상으로 돌아가세요."
        ),
    ],
    "환절기": [
        (
            "환절기에는 큰 일교차로 인해\n"
            "면역력이 약해지기 쉽습니다.\n\n"
            "감기, 비염, 기침 등\n"
            "호흡기 질환이 급증하는 시기입니다.\n\n"
            "수壽는 면역력 강화에 도움이 되는\n"
            "검증된 한약재로\n"
            "환절기 건강을 지켜드립니다."
        ),
    ],
    "걷기": [
        (
            "걷기는 누구나 할 수 있는\n"
            "가장 기본적인 운동이지만\n"
            "잘못된 보행 습관은 오히려\n"
            "무릎과 허리에 부담을 줄 수 있습니다.\n\n"
            "신발 밑창이 한쪽으로 닳거나\n"
            "걷고 난 후 통증이 있다면\n"
            "보행 자세를 점검해 볼 필요가 있습니다.\n\n"
            "올바른 걷기 습관과 함께\n"
            "관절과 근골격 건강을 챙기세요.\n"
            "수壽가 건강한 걸음을 응원합니다."
        ),
        (
            "하루 30분 걷기만으로도\n"
            "심폐 기능 향상, 혈액순환 개선,\n"
            "체중 관리에 효과가 있습니다.\n\n"
            "보폭은 자신의 키에 맞게,\n"
            "속도는 약간 빠르게 걷는 것이\n"
            "가장 효율적인 걷기 방법입니다.\n\n"
            "걷기만으로도 피로가 느껴진다면\n"
            "한약으로 체력을 보강해 보세요.\n"
            "수壽가 활력 있는 걸음을 도와드립니다."
        ),
        (
            "대한스포츠의학회에 따르면\n"
            "올바른 보행 자세는\n"
            "관절 건강뿐 아니라\n"
            "전신 건강에 큰 영향을 줍니다.\n\n"
            "적당한 보폭을 유지하고\n"
            "자신의 리듬에 맞춰 걸으면\n"
            "부상 없이 건강을 지킬 수 있습니다.\n\n"
            "걷기와 함께 체력까지 챙기고 싶다면\n"
            "수壽의 경옥고를 만나보세요."
        ),
    ],
    "운동": [
        (
            "운동은 면역력을 높이고\n"
            "체력을 유지하는 가장 확실한 방법입니다.\n\n"
            "무리한 운동보다는\n"
            "자신에게 맞는 강도와 빈도로\n"
            "꾸준히 실천하는 것이 중요합니다.\n\n"
            "운동 후 회복이 느리다면\n"
            "한약으로 기력을 보충해 보세요.\n"
            "수壽가 건강한 운동 생활을 함께합니다."
        ),
        (
            "규칙적인 운동은\n"
            "심혈관 건강, 근력 유지, 스트레스 해소에\n"
            "효과적입니다.\n\n"
            "하루 30분 이상의 유산소 운동과\n"
            "주 2-3회 근력 운동을 병행하면\n"
            "건강한 몸을 유지할 수 있습니다.\n\n"
            "운동과 함께 수壽로\n"
            "체력까지 챙겨보세요."
        ),
    ],
    "수면": [
        (
            "깊은 수면은 면역 회복의 핵심입니다.\n"
            "잠이 부족하면 면역세포의 활동이 저하되고\n"
            "감기에 걸릴 확률이 높아집니다.\n\n"
            "한의학에서는 심신의 안정을 돕는 처방으로\n"
            "수면의 질을 개선합니다.\n\n"
            "수壽와 함께 건강한 수면 습관을\n"
            "만들어 보세요."
        ),
    ],
}

# ── 실제 게시물에서 추출한 헤드라인 패턴 (폴백용) ──
_HOOKS = {
    "정보성": [
        "자신있게 권할 수 있는 퀄리티",
        "hGMP 인증으로 더욱 안전하게",
        "일반 분말보다 15배 더 미세하게",
        "자연 그대로, 깨끗하게",
        "전통과 현대의 융합",
        "800년이라는 시간 그 이상의 가치",
        "{kw}의 차이를 만드는 기술력",
        "{kw}, 안전함이 기본입니다",
        "한 번 더 검증하는 품질 관리",
        "{kw}의 핵심은 원료에 있습니다",
    ],
    "감성": [
        "당신의 건강을 지키는 한 알의 정성",
        "오래도록 건강하게, 수壽와 함께",
        "소중한 분에게 전하는 건강",
        "{kw}로 시작하는 건강한 일상",
        "매일의 작은 실천이 큰 변화를 만듭니다",
        "건강한 내일을 위한 오늘의 선택",
        "가족의 건강을 생각하는 마음",
        "{kw}, 진심을 담아 만듭니다",
    ],
    "유머": [
        "{kw} 안 하면 손해인 거 아시죠?",
        "이거 보고도 {kw} 안 하실 건가요?",
        "{kw}, 한 번 시작하면 멈출 수 없습니다",
        "친구한테 알려주면 고마워할 {kw} 이야기",
        "아직도 {kw}의 진가를 모르신다면",
    ],
    "전문적": [
        "근거 기반 {kw} 가이드",
        "데이터로 증명된 {kw}의 실질적 효과",
        "{kw}: 최신 연구가 말하는 효과와 방법",
        "임상 데이터로 보는 {kw}의 진실",
        "{kw}에 대한 전문가 분석",
    ],
}

# 키워드 폴백용 본문 템플릿
_BODY_TEMPLATES = [
    (
        "{kw1}은(는) 예로부터\n"
        "기력 보충과 면역력 강화에\n"
        "탁월한 효과가 있는 것으로 알려져 있습니다.\n\n"
        "수壽는 최상급 원료만을 엄선하여\n"
        "그 효과를 더욱 높였습니다."
    ),
    (
        "{kw1}의 품질은 원료에서 결정됩니다.\n\n"
        "수壽는 원료 선별부터 완성까지\n"
        "한의사가 직접 관리하며\n"
        "모든 과정을 투명하게 공개합니다."
    ),
    (
        "바쁜 일상 속에서도\n"
        "건강을 놓치지 않는 방법.\n\n"
        "{kw1}으로 하루를 시작하면\n"
        "몸이 먼저 변화를 느낍니다.\n\n"
        "수壽가 그 첫걸음을 함께합니다."
    ),
]


# ── 주제 감지 (OCR 원본에서 키워드 매칭) ──

def _detect_topics_from_raw(raw_texts):
    """OCR 원본 텍스트(정제 전)에서 주제를 감지합니다.
    정제 전 원본을 사용하여 노이즈 속에서도 키워드를 잡아냅니다.
    """
    all_text = " ".join(raw_texts).lower()
    # 특수문자 제거하여 키워드 매칭률 향상
    all_text_clean = re.sub(r"[^가-힣a-zA-Z0-9\s]", " ", all_text)

    topic_scores = {}
    for topic, keywords in _TOPIC_KEYWORDS.items():
        count = sum(1 for kw in keywords if kw.lower() in all_text_clean)
        if count > 0:
            topic_scores[topic] = count
    return sorted(topic_scores.items(), key=lambda x: -x[1])


# ── 캡션 조합 ──

def _build_hashtags(top_hashtags, topics=None):
    """주제와 인사이트를 기반으로 해시태그 리스트를 구성합니다."""
    tags = list(_BRAND_HASHTAGS)
    topic_hashtag_map = {
        "뇌건강": "뇌건강", "녹용": "녹용", "공진단": "공진단",
        "경옥고": "경옥고", "면역력": "면역력", "활력": "활력충전",
        "품질": "한약품질", "기술력": "한약기술", "전통": "전통한약",
        "호흡기": "호흡기건강", "명절건강": "명절후유증", "환절기": "환절기건강",
        "수면": "숙면", "혈액순환": "혈액순환", "소화": "소화건강",
        "피부": "피부건강", "걷기": "걷기운동", "운동": "운동건강",
    }
    if topics:
        for topic, _ in topics[:2]:
            tag = topic_hashtag_map.get(topic)
            if tag and tag not in tags and len(tags) < 5:
                tags.append(tag)
    if top_hashtags:
        for t in top_hashtags:
            tag = t.lstrip("#")
            if tag not in tags and len(tags) < 5:
                tags.append(tag)
    for t in _EXTRA_HASHTAGS:
        if t not in tags and len(tags) < 5:
            tags.append(t)
    return tags


def _assemble_caption(hook, body, top_hashtags=None, topics=None):
    """수壽 스타일로 캡션을 조합합니다."""
    cta = random.choice(_CTAS)
    caption = f"{hook}\n\n{body} \n\n{cta} \n\n{_SIGNATURE}"
    tags = _build_hashtags(top_hashtags, topics)
    hashtags = " ".join(f"#{t}" for t in tags)
    full = f"{caption}\n\n{hashtags}"
    return {"caption": caption, "hashtags": hashtags, "full": full}


def _build_from_image_texts(image_texts, top_hashtags=None, tone="정보성"):
    """이미지에서 추출한 텍스트를 분석하여 수壽 스타일 캡션을 생성합니다.

    핵심 전략: OCR 텍스트는 '주제 감지' 전용으로 사용하고,
    캡션 본문은 주제별로 사전 작성된 고품질 콘텐츠에서 가져옵니다.
    이를 통해 OCR 노이즈가 캡션에 직접 노출되는 문제를 근본적으로 해결합니다.
    """
    # ① 원본 텍스트에서 주제 감지 (정제 전 원본 사용 → 키워드 감지율 극대화)
    topics = _detect_topics_from_raw(image_texts)

    if not topics:
        logger.info("주제를 감지할 수 없습니다. 템플릿 모드로 전환합니다.")
        return None

    main_topic = topics[0][0]
    logger.info(f"감지된 주제: {topics[:3]}")

    # ② 주제별 헤드라인 선택
    hook_options = _TOPIC_HOOKS.get(main_topic)
    if not hook_options:
        return None
    hook = random.choice(hook_options)

    # ③ 주제별 본문 선택 (고품질 사전 작성 콘텐츠)
    body_options = _TOPIC_BODIES.get(main_topic)
    if not body_options:
        return None
    body = random.choice(body_options)

    # ④ 조합
    return _assemble_caption(hook, body, top_hashtags, topics)


def generate_caption(
    image_texts=None,
    account_name="",
    past_top_captions=None,
    top_keywords=None,
    top_hashtags=None,
    tone="정보성",
    **kwargs,
):
    """수壽 계정 스타일에 맞는 Instagram 캡션과 해시태그를 생성합니다.

    Args:
        image_texts: 이미지에서 추출한 텍스트 리스트
        account_name: 계정 이름
        past_top_captions: 과거 성과 좋은 캡션 리스트
        top_keywords: 성과 좋은 키워드 리스트
        top_hashtags: 성과 좋은 해시태그 리스트
        tone: 캡션 톤 ("정보성", "감성", "유머", "전문적")

    Returns:
        dict: {"caption": str, "hashtags": str, "full": str}
    """
    # 이미지 텍스트가 있으면 주제 감지 → 고품질 콘텐츠 매칭
    if image_texts:
        result = _build_from_image_texts(image_texts, top_hashtags, tone)
        if result:
            return result

    # 키워드 준비 (이미지 텍스트 없거나 주제 감지 실패 시 템플릿 모드)
    keywords = list(top_keywords) if top_keywords else []
    if not keywords:
        keywords = ["공진단", "경옥고", "한약", "면역력", "활력"]
    random.shuffle(keywords)
    kw1 = keywords[0]
    kw2 = keywords[1 % len(keywords)]

    # 1) 후킹 헤드라인
    hooks = _HOOKS.get(tone, _HOOKS["정보성"])
    hook = random.choice(hooks).format(kw=kw1)

    # 2) 본문
    body = random.choice(_BODY_TEMPLATES).format(kw1=kw1, kw2=kw2)

    # 3) 조합
    return _assemble_caption(hook, body, top_hashtags)
