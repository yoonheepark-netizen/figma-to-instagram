"""10-ì—ì´ì „íŠ¸ ê²½ìŸ ì¹´ë“œë‰´ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ ìƒì„± ëª¨ë“ˆ

5ê°œ ì „ë¬¸ ì—ì´ì „íŠ¸ê°€ ê° 2ê°œ ì•„ì´ë””ì–´ = 10ê°œ ì•„ì´ë””ì–´ ìƒì„± í›„
5ê°œ ê¸°ì¤€ ê²½ìŸ í‰ê°€ â†’ Top 2 ì„ ì • â†’ í’€ ìŠ¤í¬ë¦½íŠ¸ + ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ + Description Mention ìƒì„±
"""
from __future__ import annotations

import json
import logging
import os
import re
import time
import xml.etree.ElementTree as ET
from concurrent.futures import ThreadPoolExecutor, as_completed
from datetime import datetime
from difflib import SequenceMatcher
from pathlib import Path

import requests as _requests

try:
    from dotenv import load_dotenv
    load_dotenv()
except ImportError:
    pass

logger = logging.getLogger(__name__)

# â”€â”€ íˆìŠ¤í† ë¦¬ íŒŒì¼ â”€â”€
HISTORY_FILE = Path(__file__).parent / "cardnews_history.json"

# â”€â”€ ì—ì´ì „íŠ¸ ì •ì˜ â”€â”€
AGENTS = [
    {
        "id": "health",
        "name": "ê±´ê°•ì •ë³´ ì—ì´ì „íŠ¸",
        "domain": "ê±´ê°• ìƒì‹, ì˜ì–‘, ìˆ˜ë©´, ë©´ì—­, ìš´ë™, ì§ˆí™˜ ì˜ˆë°©",
        "search_hint": "ê±´ê°• íŠ¸ë Œë“œ, ì˜ì–‘ ì •ë³´, ìˆ˜ë©´ ë©´ì—­",
    },
    {
        "id": "celeb",
        "name": "ì—°ì˜ˆíŠ¸ë Œë“œ ì—ì´ì „íŠ¸",
        "domain": "ì…€ëŸ½ ë·°í‹°Â·ë‹¤ì´ì–´íŠ¸Â·ë¼ì´í”„ìŠ¤íƒ€ì¼ íŠ¸ë Œë“œ, ë°©ì†¡ ê±´ê°• ì´ìŠˆ",
        "search_hint": "ì—°ì˜ˆì¸ ê±´ê°• ë‹¤ì´ì–´íŠ¸ ë·°í‹° íŠ¸ë Œë“œ",
    },
    {
        "id": "lifestyle",
        "name": "ìƒí™œê±´ê°• ì—ì´ì „íŠ¸",
        "domain": "ì¼ìƒ ìƒí™œ ì† ê±´ê°• íŒ, ì‹í’ˆ ì •ë³´, ê³„ì ˆ ìƒí™œ, í™ˆì¼€ì–´",
        "search_hint": "ìƒí™œ ê±´ê°• íŒ, ê³„ì ˆ ìŒì‹, í™ˆì¼€ì–´",
    },
    {
        "id": "women",
        "name": "ì—¬ì„±ë¼ì´í”„ ì—ì´ì „íŠ¸",
        "domain": "ì—¬ì„± ê±´ê°•, í˜¸ë¥´ëª¬, ì´ë„ˆë·°í‹°, ê°±ë…„ê¸°, í”¼ë¶€ ê´€ë¦¬",
        "search_hint": "ì—¬ì„± ê±´ê°• ë·°í‹° í˜¸ë¥´ëª¬ ì´ë„ˆë·°í‹°",
    },
    {
        "id": "worker",
        "name": "ì§ì¥ì¸ìƒí™œ ì—ì´ì „íŠ¸",
        "domain": "ì§ì¥ì¸ í”¼ë¡œ, ë²ˆì•„ì›ƒ, ìˆ˜ë©´ ë¶€ì¡±, ì‚¬ë¬´ì§ ê±´ê°•, ì ì‹¬ ì‹ë‹¨",
        "search_hint": "ì§ì¥ì¸ ê±´ê°• ë²ˆì•„ì›ƒ ìˆ˜ë©´ ì‹ë‹¨",
    },
]

# â”€â”€ ì¹´í…Œê³ ë¦¬ â”€â”€
CATEGORIES = [
    {"id": "health", "name": "ê±´ê°•", "desc": "ê±´ê°• ìƒì‹, ì˜ì–‘, ìˆ˜ë©´, ë©´ì—­, ìš´ë™, ì§ˆí™˜ ì˜ˆë°©"},
    {"id": "entertainment", "name": "ì—°ì˜ˆ", "desc": "ì…€ëŸ½ íŠ¸ë Œë“œ, ë·°í‹°, ë‹¤ì´ì–´íŠ¸, ë°©ì†¡ ê±´ê°• ì´ìŠˆ"},
    {"id": "lifestyle", "name": "ìƒí™œ", "desc": "ì¼ìƒ ê±´ê°• íŒ, ê³„ì ˆ ìƒí™œ, ì‹í’ˆ ì •ë³´, í™ˆì¼€ì–´"},
]

# â”€â”€ íŒ¨í„´ â”€â”€
PATTERNS = [
    {"id": "question", "name": "ì§ˆë¬¸í˜•", "template": "[ì˜ë¬¸ì‚¬] + [êµ¬ì²´ì  ìƒí™©]?", "tone": "í˜¸ê¸°ì‹¬ ìœ ë°œ"},
    {"id": "surprise", "name": "ë†€ë¼ì›€í˜•", "template": "[ì¹œìˆ™í•œ ì†Œì¬] + [ì¶©ê²©ì  ìˆ˜ì¹˜]!", "tone": "ì¶©ê²©, ë°˜ì „"},
    {"id": "historical", "name": "ì—­ì‚¬í˜•", "template": "[ì—­ì‚¬ ì¸ë¬¼/ì‹œëŒ€] + [ê±´ê°• ì´ì•¼ê¸°]", "tone": "ê¶Œìœ„, ìŠ¤í† ë¦¬í…”ë§"},
    {"id": "fear", "name": "ê³µí¬í˜•", "template": "[í˜„ì¬ ì¦ìƒ] + [ë¯¸ë˜ ìœ„í—˜]ì„ ë¶€ë¥¸ë‹¤?", "tone": "ê²½ê°ì‹¬"},
    {"id": "practical", "name": "ì‹¤ìš©í˜•", "template": "[ìƒí™©] + [ì‹¤í–‰ ë°©ë²•]!", "tone": "ì¹œì ˆ, ì‹¤ìš©ì„±"},
    {"id": "doubt", "name": "ì˜ë¬¸í˜•", "template": "[í†µë…] + ì‚¬ì‹¤ì€ [ì§„ì‹¤]?", "tone": "í˜¸ê¸°ì‹¬, ë°˜ì „"},
    {"id": "plan", "name": "ê³„íší˜•", "template": "[ê¸°ê°„] + [ê±´ê°• ëª©í‘œ] í”„ë¡œì íŠ¸", "tone": "ë™ê¸°ë¶€ì—¬"},
    {"id": "statistics", "name": "í†µê³„í˜•", "template": "[ëŒ€ìƒ] [%]ê°€ ê²ªëŠ” + [ì´ìŠˆ]", "tone": "ì‹ ë¢°, ê°ê´€ì„±"},
]

# â”€â”€ ê³„ì ˆ/ì ˆê¸° â”€â”€
SEASONS = {
    "spring": {"months": [3, 4, 5], "kr": "ë´„", "theme": "í•´ë…ê³¼ í™œë ¥"},
    "summer": {"months": [6, 7, 8], "kr": "ì—¬ë¦„", "theme": "ë³´ì–‘ê³¼ ìˆ˜ë¶„"},
    "autumn": {"months": [9, 10, 11], "kr": "ê°€ì„", "theme": "ë©´ì—­ê³¼ ê±´ì¡° ëŒ€ë¹„"},
    "winter": {"months": [12, 1, 2], "kr": "ê²¨ìš¸", "theme": "ë³´ì˜¨ê³¼ í˜ˆì•¡ìˆœí™˜"},
}

SOLAR_TERMS = [
    ("02-04", "ì…ì¶˜"), ("02-19", "ìš°ìˆ˜"), ("03-06", "ê²½ì¹©"), ("03-21", "ì¶˜ë¶„"),
    ("04-05", "ì²­ëª…"), ("04-20", "ê³¡ìš°"), ("05-06", "ì…í•˜"), ("05-21", "ì†Œë§Œ"),
    ("06-06", "ë§ì¢…"), ("06-21", "í•˜ì§€"), ("07-07", "ì†Œì„œ"), ("07-23", "ëŒ€ì„œ"),
    ("08-08", "ì…ì¶”"), ("08-23", "ì²˜ì„œ"), ("09-08", "ë°±ë¡œ"), ("09-23", "ì¶”ë¶„"),
    ("10-08", "í•œë¡œ"), ("10-24", "ìƒê°•"), ("11-07", "ì…ë™"), ("11-22", "ì†Œì„¤"),
    ("12-07", "ëŒ€ì„¤"), ("12-22", "ë™ì§€"), ("01-06", "ì†Œí•œ"), ("01-20", "ëŒ€í•œ"),
]

# â”€â”€ ì‹ì•½ì²˜ ê·œì œ ë¸”ë™ë¦¬ìŠ¤íŠ¸ â”€â”€
REGULATORY_BLACKLIST = [
    "ì¹˜ë£Œ", "ì™„ì¹˜", "íŠ¹íš¨ì•½", "ë§Œë³‘í†µì¹˜", "ê¸°ì ì˜",
    "ì•” ì˜ˆë°©", "ì•” ì¹˜ë£Œ", "ë‹¹ë‡¨ ì¹˜ë£Œ", "ê³ í˜ˆì•• ì¹˜ë£Œ",
    "100% íš¨ê³¼", "ë¶€ì‘ìš© ì—†ëŠ”", "FDA ìŠ¹ì¸",
    "ì•½íš¨", "ì²˜ë°©ì „", "ì§„ë‹¨", "ìˆ˜ìˆ  ëŒ€ì‹ ",
]

# â”€â”€ ë¸Œëœë“œ í´ë¡œì§• (ê³ ì •) â”€â”€
BRAND_CLOSING = "ë” ì˜¤ë˜, ë” ê±´ê°•í•˜ê²Œ. í•œì˜ì‚¬ê°€ ë§Œë“œëŠ” í•œì˜ ë¸Œëœë“œ"


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ê³„ì ˆ/ì ˆê¸° ê°ì§€
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def detect_season():
    """í˜„ì¬ ë‚ ì§œ ê¸°ë°˜ ê³„ì ˆ + ì ˆê¸° ê°ì§€"""
    now = datetime.now()
    month = now.month
    md = now.strftime("%m-%d")

    season_id = "winter"
    for sid, info in SEASONS.items():
        if month in info["months"]:
            season_id = sid
            break

    solar_term = None
    for date_str, term in SOLAR_TERMS:
        if md >= date_str:
            solar_term = term
        else:
            break

    return {
        "season": season_id,
        "season_kr": SEASONS[season_id]["kr"],
        "theme": SEASONS[season_id]["theme"],
        "solar_term": solar_term,
    }


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ì‹œì¦Œ/íŠ¸ë Œë“œ ê¸°ë°˜ ì£¼ì œ ì œì•ˆ
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# â”€â”€ ì›”ë³„ ì‹œì¦Œ ì´ë²¤íŠ¸Â·íŠ¸ë Œë“œ (í”¼ê·¸ë§ˆ 2024 ì½˜í…ì¸  ìˆ˜ì¤€) â”€â”€
# í—ˆì¤€ëŸ°, ë°¤í‹°ë¼ë¯¸ìˆ˜ ê°™ì€ ì‹œì˜ì„± ë†’ì€ ì´ìŠˆ + ê±´ê°• ì ‘ì 
_MONTHLY_EVENTS = {
    1: [  # 1ì›”
        {"topic": "ì‘ì‹¬ì‚¼ì¼ë¡œ ëë‚˜ì§€ ì•ŠëŠ” ìƒˆí•´ ê±´ê°• ê³„íš", "tag": "ìƒˆí•´", "product": "ê³µì§„ë‹¨"},
        {"topic": "ì •ì›”ëŒ€ë³´ë¦„ ì˜¤ê³¡ë°¥, ì¡°ì„ ì‹œëŒ€ ì™•ì‹¤ë„ ì±™ê¸´ ê±´ê°•ì‹?", "tag": "ëª…ì ˆ", "product": "ê²½ì˜¥ê³ "},
        {"topic": "ì‹ ë…„ í•´ë‹ì´ ë“±ì‚°, ê²¨ìš¸ ì‚°í–‰ì´ ëª¸ì— ë¯¸ì¹˜ëŠ” íš¨ê³¼", "tag": "ì´ë²¤íŠ¸", "product": "ë…¹ìš©í•œì•½"},
        {"topic": "ê²¨ìš¸ ì˜¨ì²œ vs ì¡±ìš•, ì²´ì˜¨ 1ë„ê°€ ë©´ì—­ë ¥ì„ ë°”ê¾¼ë‹¤?", "tag": "ì‹œì¦Œ", "product": "ê²½ì˜¥ê³ "},
        {"topic": "ìƒˆí•´ ì²« ë‹¬, ê³µì§„ë‹¨ìœ¼ë¡œ ì‹œì‘í•˜ëŠ” 365ì¼ í™œë ¥ í”„ë¡œì íŠ¸", "tag": "ìƒˆí•´", "product": "ê³µì§„ë‹¨"},
        {"topic": "1ì›” í•œíŒŒ ê²½ë³´, í˜ˆê´€ì´ ê°€ì¥ ìœ„í—˜í•œ ë‹¬ì˜ ìƒì¡´ë²•", "tag": "ì‹œì¦Œ", "product": "ìš°í™©ì²­ì‹¬ì›"},
        {"topic": "ì„¸ë±ƒëˆ ëŒ€ì‹  ê±´ê°•? ë¶€ëª¨ë‹˜ê»˜ ë“œë¦¬ëŠ” ìµœê³ ì˜ ì„ ë¬¼", "tag": "ëª…ì ˆ", "product": "ê²½ì˜¥ê³ "},
        {"topic": "ì‹ ë…„ ë‹¤ì´ì–´íŠ¸, êµ¶ì§€ ì•Šê³  ì‚´ ë¹ ì§€ëŠ” ë™ì˜ë³´ê° ì²˜ë°©", "tag": "ìƒˆí•´", "product": "ì—†ìŒ"},
        {"topic": "ê²¨ìš¸ ìŠ¤í‚¤ì¥ì—ì„œ ì‚” ë¬´ë¦, ê´€ì ˆ íšŒë³µì˜ ê³¨ë“ íƒ€ì„", "tag": "ì‹œì¦Œ", "product": "ë…¹ìš©í•œì•½"},
        {"topic": "ìƒˆí•´ ê¸ˆì—° ë„ì „ 72ì‹œê°„, ëª¸ì— ì¼ì–´ë‚˜ëŠ” ë³€í™” íƒ€ì„ë¼ì¸", "tag": "ìƒˆí•´", "product": "ì—†ìŒ"},
        {"topic": "ì •ì´ˆ ë³µë‚  ë–¡êµ­, ì¡°ìƒë‹˜ì´ ì±™ê¸´ 1ì›” ë³´ì–‘ì‹ì˜ ë¹„ë°€", "tag": "ëª…ì ˆ", "product": "ê²½ì˜¥ê³ "},
        {"topic": "ìˆ˜ëŠ¥ ì´í›„ ìˆ˜í—˜ìƒ, 1ì›” ì»¨ë””ì…˜ íšŒë³µ ê³¨ë“ íƒ€ì„", "tag": "ì‹œì¦Œ", "product": "ê³µì§„ë‹¨"},
    ],
    2: [  # 2ì›”
        {"topic": "ë°œë Œíƒ€ì¸ ì´ˆì½œë¦¿, ì¹´ì¹´ì˜¤ê°€ ë‡Œì— ë¯¸ì¹˜ëŠ” ë†€ë¼ìš´ íš¨ê³¼", "tag": "ë°œë Œíƒ€ì¸", "product": "ê³µì§„ë‹¨"},
        {"topic": "ì„¤ ì—°íœ´ ê³¼ì‹ í›„ìœ ì¦, ì¡°ì„ ì‹œëŒ€ í•´ë…ë²•ì€?", "tag": "ì„¤ë‚ ", "product": "ê²½ì˜¥ê³ "},
        {"topic": "ê½ƒìƒ˜ì¶”ìœ„ì— ë©´ì—­ë ¥ ëš, í™˜ì ˆê¸° ì²« ë²ˆì§¸ ì ì‹ í˜¸", "tag": "ì‹œì¦Œ", "product": "ê²½ì˜¥ê³ "},
        {"topic": "ì¡¸ì—… ì‹œì¦Œ, 20ëŒ€ ì²« ê±´ê°•ê²€ì§„ì—ì„œ ê¼­ ë´ì•¼ í•  ìˆ˜ì¹˜", "tag": "ì¡¸ì—…", "product": "ì—†ìŒ"},
        {"topic": "ì¼êµì°¨ 10ë„ ì´ìƒ, ì‹¬ì¥ì´ ë³´ë‚´ëŠ” ìœ„í—˜ ì‹ í˜¸ 3ê°€ì§€", "tag": "ì‹œì¦Œ", "product": "ìš°í™©ì²­ì‹¬ì›"},
        {"topic": "ì„¤ ëª…ì ˆ ì°¨ë¡€ìƒ, ì „ ê¸°ë¦„ì´ ê°„ì— ë¯¸ì¹˜ëŠ” ì˜í–¥ì€?", "tag": "ì„¤ë‚ ", "product": "ê³µì§„ë‹¨"},
        {"topic": "2ì›” í•œíŒŒ ì† ê°ê¸° vs ë…ê°, êµ¬ë¶„ ëª»í•˜ë©´ ìœ„í—˜í•œ ì´ìœ ", "tag": "ì‹œì¦Œ", "product": "ì½œë“œí€µ"},
        {"topic": "ê²¨ìš¸ ê±´ì¡°í•œ í”¼ë¶€, ì•ˆì—ì„œë¶€í„° ì´‰ì´‰í•´ì§€ëŠ” ë³´ìŠµ ì•½ì¬", "tag": "ì‹œì¦Œ", "product": "ê²½ì˜¥ê³ "},
        {"topic": "ì…í•™ ì‹œì¦Œ ì•„ì´ ì²´ë ¥, ì„±ì¥ê¸° ë©´ì—­ë ¥ ì„¸ìš°ëŠ” ê³¨ë“ íƒ€ì„", "tag": "ì¡¸ì—…", "product": "ë…¹ìš©í•œì•½"},
        {"topic": "ì„¤ ì—°íœ´ ì¥ê±°ë¦¬ ìš´ì „, í—ˆë¦¬ ë””ìŠ¤í¬ ìœ„í—˜ ìì„¸ TOP 3", "tag": "ì„¤ë‚ ", "product": "ì—†ìŒ"},
        {"topic": "2ì›” ì œì²  ë”¸ê¸°, ë¹„íƒ€ë¯¼C í­íƒ„ì´ í”¼ë¶€ì— ë¯¸ì¹˜ëŠ” íš¨ê³¼", "tag": "ì‹œì¦Œ", "product": "ì—†ìŒ"},
        {"topic": "ê²¨ìš¸ì ì—ì„œ ê¹¨ì–´ë‚˜ëŠ” ëª¸, ë´„ ë§ì´ í•´ë…ì´ í•„ìš”í•œ ì´ìœ ", "tag": "ì‹œì¦Œ", "product": "ê²½ì˜¥ê³ "},
    ],
    3: [  # 3ì›”
        {"topic": "ì‚¼ê²¹ì‚´ë°ì´, ê³ ê¸°ì™€ í•¨ê»˜ ë¨¹ìœ¼ë©´ ê°„ì´ ì¢‹ì•„í•˜ëŠ” ì¡°í•©?", "tag": "ì‚¼ê²¹ì‚´ë°ì´", "product": "ê³µì§„ë‹¨"},
        {"topic": "ë´„ ë‚˜ë¬¼ ìºê¸° ì—´í’, ë…ì´ˆ êµ¬ë³„ë²• ì•Œê³  ê°€ì„¸ìš”", "tag": "ì‹œì¦Œ", "product": "ì—†ìŒ"},
        {"topic": "ë²šê½ƒ ë§ˆë¼í†¤ ì‹œì¦Œ, ì´ˆë³´ ëŸ¬ë„ˆê°€ ë†“ì¹˜ëŠ” ì‹¬ë°•ìˆ˜ ê´€ë¦¬", "tag": "ë§ˆë¼í†¤", "product": "ë…¹ìš©í•œì•½"},
        {"topic": "ë¯¸ì„¸ë¨¼ì§€ ë¹¨ê°„ë¶ˆ, íë¥¼ ì§€í‚¤ëŠ” ë™ì˜ë³´ê° ì²˜ë°©ì „", "tag": "ì‹œì¦Œ", "product": "ê²½ì˜¥ê³ "},
        {"topic": "3ì›” í™©ì‚¬ ì‹œì¦Œ, ë¯¸ì„¸ë¨¼ì§€ê°€ ë‡Œê¹Œì§€ ê³µê²©í•œë‹¤?", "tag": "ì‹œì¦Œ", "product": "ê³µì§„ë‹¨"},
        {"topic": "ê°œí•™ í›„ ì•„ì´ ê°ê¸° í­ë°œ, ì†Œì•„ ë©´ì—­ë ¥ ì„¸ìš°ëŠ” ë²•", "tag": "ì‹œì¦Œ", "product": "ì½œë“œí€µ"},
        {"topic": "ë´„ì²  ì¡¸ìŒìš´ì „ ì‚¬ê³  ê¸‰ì¦, 15ë¶„ ë‚®ì ì˜ ê³¼í•™ì  íš¨ê³¼", "tag": "ì‹œì¦Œ", "product": "ê³µì§„ë‹¨"},
        {"topic": "í™”ì´íŠ¸ë°ì´ ì‚¬íƒ•, ì„¤íƒ•ì´ ë‡Œì— ë¯¸ì¹˜ëŠ” 48ì‹œê°„ì˜ ì—¬ì •", "tag": "ì´ë²¤íŠ¸", "product": "ì—†ìŒ"},
        {"topic": "ë´„ ì•Œë ˆë¥´ê¸° ì½”ë§‰í˜, ì•½ ì—†ì´ 10ì´ˆ í•´ê²°í•˜ëŠ” ì§€ì••ë²•", "tag": "ì‹œì¦Œ", "product": "ì—†ìŒ"},
        {"topic": "3ì›” ìƒˆ í•™ê¸° ì‹œí—˜ ìŠ¤íŠ¸ë ˆìŠ¤, ì§‘ì¤‘ë ¥ ë†’ì´ëŠ” í•œì•½ì¬ 3ê°€ì§€", "tag": "ì‹œì¦Œ", "product": "ì´ëª…ê³µì§„ë‹¨"},
        {"topic": "ë´„ í”¼í¬ë‹‰ ë„ì‹œë½, ì‹ì¤‘ë… ì˜ˆë°©í•˜ëŠ” ì˜¨ë„ ê´€ë¦¬ë²•", "tag": "ì‹œì¦Œ", "product": "ê¹ŒìŠ¤í€µ"},
        {"topic": "ê²¨ìš°ë‚´ êµ³ì€ ê´€ì ˆ, ë´„ ìŠ¤íŠ¸ë ˆì¹­ 5ë¶„ ë£¨í‹´", "tag": "ì‹œì¦Œ", "product": "ë…¹ìš©í•œì•½"},
    ],
    4: [  # 4ì›”
        {"topic": "ì‹ëª©ì¼ì— ì‹¬ëŠ” ê±´ ë‚˜ë¬´ë§Œ? ì¥ ê±´ê°•ì„ ì‹¬ëŠ” ë´„ ì‹ë‹¨", "tag": "ì‹ëª©ì¼", "product": "ê²½ì˜¥ê³ "},
        {"topic": "ì¶˜ê³¤ì¦ì˜ ì§„ì§œ ë²”ì¸, ë‡Œê°€ ë³´ë‚´ëŠ” SOS ì‹ í˜¸", "tag": "ì‹œì¦Œ", "product": "ê³µì§„ë‹¨"},
        {"topic": "ë´„ ë“±ì‚° ì‹œì¦Œ, ì¡°ì„  ì„ ë¹„ë“¤ì˜ ì‚°í–‰ ê±´ê°•ë²•", "tag": "ì‹œì¦Œ", "product": "ë…¹ìš©í•œì•½"},
        {"topic": "4ì›” ê³¼í•™ì˜ ë‹¬, í•œì•½ì˜ íš¨ëŠ¥ì„ ë°íŒ ë…¼ë¬¸ TOP 3", "tag": "ê³¼í•™ì˜ë‹¬", "product": "ê³µì§„ë‹¨"},
        {"topic": "ë´„ë¹„ ì˜¤ëŠ” ë‚  ê´€ì ˆ í†µì¦, ê¸°ì••ê³¼ ê´€ì ˆì˜ ìˆ¨ê²¨ì§„ ê´€ê³„", "tag": "ì‹œì¦Œ", "product": "ë…¹ìš©í•œì•½"},
        {"topic": "ê½ƒê°€ë£¨ í­íƒ„ 4ì›”, ëˆˆÂ·ì½”Â·ëª© 3ë‹¨ ë°©ì–´ ì „ëµ", "tag": "ì‹œì¦Œ", "product": "ì—†ìŒ"},
        {"topic": "4ì›” ë²šê½ƒ ë‚˜ë“¤ì´, ê±·ê¸° ìš´ë™ì´ ìš°ìš¸ì¦ì„ ì´ê¸°ëŠ” ì›ë¦¬", "tag": "ì‹œì¦Œ", "product": "ì—†ìŒ"},
        {"topic": "ë´„ì²  ë‚˜ë¥¸í•¨ vs ë§Œì„±í”¼ë¡œ, êµ¬ë¶„í•˜ëŠ” ì²´í¬ë¦¬ìŠ¤íŠ¸ 5ê°€ì§€", "tag": "ì‹œì¦Œ", "product": "ê³µì§„ë‹¨"},
        {"topic": "4ì›” ì œì²  ì‘¥, ë™ì˜ë³´ê° ìµœê³ ì˜ í•´ë… ì•½ì¬ë¥¼ ë¨¹ëŠ” ë²•", "tag": "ì‹œì¦Œ", "product": "ê²½ì˜¥ê³ "},
        {"topic": "ì¤‘ê°„ê³ ì‚¬ ì‹œì¦Œ, ë‡Œì— ì‚°ì†Œ ê³µê¸‰í•˜ëŠ” 10ë¶„ ë£¨í‹´", "tag": "ì‹œì¦Œ", "product": "ì´ëª…ê³µì§„ë‹¨"},
        {"topic": "ì¥ë§ˆ ì „ ë§ˆì§€ë§‰ ìº í•‘ ì‹œì¦Œ, ì•¼ì™¸ í™œë™ ê´€ì ˆ ê´€ë¦¬ë²•", "tag": "ì‹œì¦Œ", "product": "ë…¹ìš©í•œì•½"},
        {"topic": "í™˜ì ˆê¸° íƒˆëª¨ ê¸‰ì¦, ë‘í”¼ê°€ ë³´ë‚´ëŠ” SOS ì‹ í˜¸ ì½ëŠ” ë²•", "tag": "ì‹œì¦Œ", "product": "ê²½ì˜¥ê³ "},
    ],
    5: [  # 5ì›”
        {"topic": "ì–´ë²„ì´ë‚  ê±´ê°• ì„ ë¬¼, ì¡°ì„ ì‹œëŒ€ íš¨ë„ ë³´ì–‘ ë¬¸í™”", "tag": "ì–´ë²„ì´ë‚ ", "product": "ê³µì§„ë‹¨"},
        {"topic": "ê°€ì •ì˜ ë‹¬ ìº í•‘ ë¶, ìˆ²ì´ ë‡Œë¥¼ ì¹˜ìœ í•˜ëŠ” ê³¼í•™ì  ì´ìœ ", "tag": "ê°€ì •ì˜ë‹¬", "product": "ì—†ìŒ"},
        {"topic": "ìŠ¤ìŠ¹ì˜ ë‚ , í—ˆì¤€ì´ ìŠ¤ìŠ¹ì—ê²Œ ë°°ìš´ ê±´ê°• ì² í•™", "tag": "ìŠ¤ìŠ¹ì˜ë‚ ", "product": "ê²½ì˜¥ê³ "},
        {"topic": "ì¥ë¯¸ ì¶•ì œ ì‹œì¦Œ, ê½ƒ í–¥ê¸°ê°€ ìŠ¤íŠ¸ë ˆìŠ¤ë¥¼ ì¤„ì´ëŠ” ì›ë¦¬", "tag": "ì‹œì¦Œ", "product": "ì—†ìŒ"},
        {"topic": "5ì›” ê°€ì •ì˜ ë‹¬, ë¶€ëª¨ë‹˜ ê±´ê°•ê²€ì§„ ê¼­ ì±™ê²¨ì•¼ í•  í•­ëª© 5ê°€ì§€", "tag": "ê°€ì •ì˜ë‹¬", "product": "ê³µì§„ë‹¨"},
        {"topic": "ì–´ë¦°ì´ë‚  ì•„ì´ ê°„ì‹, ì„±ì¥ì— ë…ì´ ë˜ëŠ” ì²¨ê°€ë¬¼ ì²´í¬", "tag": "ê°€ì •ì˜ë‹¬", "product": "ë…¹ìš©í•œì•½"},
        {"topic": "5ì›” ìì™¸ì„  ê¸‰ì¦, ë´„ í–‡ì‚´ì´ ì—¬ë¦„ë³´ë‹¤ ìœ„í—˜í•œ ì´ìœ ", "tag": "ì‹œì¦Œ", "product": "ì—†ìŒ"},
        {"topic": "ê°€ì •ì˜ ë‹¬ íš¨ë„ ì—¬í–‰, ë¶€ëª¨ë‹˜ ë¬´ë¦ ê´€ì ˆ ì§€í‚¤ëŠ” ì—¬í–‰ë²•", "tag": "ê°€ì •ì˜ë‹¬", "product": "ë…¹ìš©í•œì•½"},
        {"topic": "5ì›” ì œì²  ë‘ë¦…, ì‚°ì‚¼ ëª»ì§€ì•Šì€ ë´„ ë³´ì•½ì˜ íš¨ëŠ¥", "tag": "ì‹œì¦Œ", "product": "ê²½ì˜¥ê³ "},
        {"topic": "ì„ê°€íƒ„ì‹ ì¼ ì‚¬ì°°ìŒì‹, ì±„ì‹ì´ ì¥ ê±´ê°•ì— ë¯¸ì¹˜ëŠ” 72ì‹œê°„", "tag": "ì´ë²¤íŠ¸", "product": "ê¹ŒìŠ¤í€µ"},
        {"topic": "5ì›” í™©ì‚¬ 2ì°¨ ê³µìŠµ, ê¸°ê´€ì§€ ì•½í•œ ì‚¬ëŒì´ ê¼­ ë¨¹ì–´ì•¼ í•  ê²ƒ", "tag": "ì‹œì¦Œ", "product": "ê²½ì˜¥ê³ "},
        {"topic": "ë´„ ì†Œí’ ë„ì‹œë½ ì‹ì¤‘ë…, 30ë„ ë„˜ìœ¼ë©´ 2ì‹œê°„ì´ í•œê³„", "tag": "ì‹œì¦Œ", "product": "ê¹ŒìŠ¤í€µ"},
    ],
    6: [  # 6ì›”
        {"topic": "ë‹¨ì˜¤ì— ë¨¸ë¦¬ ê°ëŠ” ì°½í¬ë¬¼, ê³¼í•™ì ìœ¼ë¡œ íš¨ê³¼ ìˆì„ê¹Œ?", "tag": "ë‹¨ì˜¤", "product": "ì—†ìŒ"},
        {"topic": "ì—¬ë¦„ ë§¥ì£¼ ì‹œì¦Œ, 'ë§¥ì£¼ í•œ ì”'ì´ ê°„ì— ë¯¸ì¹˜ëŠ” 72ì‹œê°„", "tag": "ì‹œì¦Œ", "product": "ê³µì§„ë‹¨"},
        {"topic": "ì¥ë§ˆì²  ê³°íŒ¡ì´ê°€ íì— ë¯¸ì¹˜ëŠ” ì˜í–¥, ì•Œê³  ê³„ì…¨ë‚˜ìš”?", "tag": "ì¥ë§ˆ", "product": "ê²½ì˜¥ê³ "},
        {"topic": "ì›”ë“œì»µ ë°¤ìƒ˜ ì‘ì›, ìˆ˜ë©´ ë¶€ì±„ê°€ ìŒ“ì´ë©´ ìƒê¸°ëŠ” ì¼", "tag": "ì´ë²¤íŠ¸", "product": "ê³µì§„ë‹¨"},
        {"topic": "6ì›” ì¥ë§ˆ ì‹œì‘, ìŠµê¸°ê°€ ê´€ì ˆì„ ê³µê²©í•˜ëŠ” ë©”ì»¤ë‹ˆì¦˜", "tag": "ì¥ë§ˆ", "product": "ë…¹ìš©í•œì•½"},
        {"topic": "í˜„ì¶©ì¼ ë“±ì‚°, 6ì›” ë”ìœ„ ì† ë“±ì‚° ì•ˆì „ ìˆ˜ì¹™ 5ê°€ì§€", "tag": "ì´ë²¤íŠ¸", "product": "ë…¹ìš©í•œì•½"},
        {"topic": "ì—¬ë¦„ ì•ë‘” ë‹¤ì´ì–´íŠ¸, êµ¶ëŠ” ê²ƒë³´ë‹¤ íš¨ê³¼ì ì¸ ë°©ë²• 3ê°€ì§€", "tag": "ì‹œì¦Œ", "product": "ì—†ìŒ"},
        {"topic": "ì¥ë§ˆì²  ë¹¨ë˜ ê³°íŒ¡ì´, í˜¸í¡ê¸°ì— ë¯¸ì¹˜ëŠ” ìˆ¨ì€ ìœ„í—˜", "tag": "ì¥ë§ˆ", "product": "ê²½ì˜¥ê³ "},
        {"topic": "6ì›” ì œì²  ë§¤ì‹¤, ì—¬ë¦„ ë°°íƒˆ ì˜ˆë°©í•˜ëŠ” í• ë¨¸ë‹ˆ ì§€í˜œì˜ ê³¼í•™", "tag": "ì‹œì¦Œ", "product": "ê¹ŒìŠ¤í€µ"},
        {"topic": "ê¸°ë§ê³ ì‚¬ ì‹œì¦Œ, ì‹œí—˜ ë¶ˆì•ˆì´ ë°°ë¥¼ ì•„í”„ê²Œ í•˜ëŠ” ì´ìœ ", "tag": "ì‹œì¦Œ", "product": "ê¹ŒìŠ¤í€µ"},
        {"topic": "ì—¬ë¦„ ì—ì–´ì»¨ í‹€ê¸° ì „, íë¥¼ ì§€í‚¤ëŠ” í•„í„° ê´€ë¦¬ë²•", "tag": "ì‹œì¦Œ", "product": "ê²½ì˜¥ê³ "},
        {"topic": "6ì›” ëª¨ê¸° ì¶œëª°, ëª¨ê¸° ë¬¼ë¦° í›„ ê¸ìœ¼ë©´ ì•ˆ ë˜ëŠ” ê³¼í•™ì  ì´ìœ ", "tag": "ì‹œì¦Œ", "product": "ì—†ìŒ"},
    ],
    7: [  # 7ì›”
        {"topic": "ì´ˆë³µ ì‚¼ê³„íƒ•, ë‹­ ì†ì— ë“¤ì–´ê°€ëŠ” í•œì•½ì¬ì˜ ë¹„ë°€", "tag": "ì‚¼ë³µ", "product": "ê²½ì˜¥ê³ "},
        {"topic": "ì›Œí„°íŒŒí¬ ì‹œì¦Œ, ë¬¼ë†€ì´ í›„ ê·€ ê±´ê°• ì²´í¬ë¦¬ìŠ¤íŠ¸", "tag": "ì‹œì¦Œ", "product": "ì—†ìŒ"},
        {"topic": "ì—´ëŒ€ì•¼ ë¶ˆë©´ì¦, ì¡°ì„  ì™•ì‹¤ì€ ì–´ë–»ê²Œ ì—¬ë¦„ë°¤ì„ ë‚¬ì„ê¹Œ?", "tag": "ì‹œì¦Œ", "product": "ê³µì§„ë‹¨"},
        {"topic": "ì—¬ë¦„ ë¹™ìˆ˜ ì—´í’, íŒ¥ì´ ì˜ì™¸ë¡œ ì•½ì¬ì˜€ë‹¤ê³ ?", "tag": "íŠ¸ë Œë“œ", "product": "ì—†ìŒ"},
        {"topic": "7ì›” í­ì—¼ ê²½ë³´, ì—´ì‚¬ë³‘ vs ì¼ì‚¬ë³‘ êµ¬ë³„ê³¼ ì‘ê¸‰ ëŒ€ì²˜ë²•", "tag": "ì‹œì¦Œ", "product": "ì—†ìŒ"},
        {"topic": "ë³µë‚  ì‚¼ê³„íƒ• ì™¸ì—ë„? ë™ì˜ë³´ê° ì—¬ë¦„ ë³´ì–‘ì‹ ë² ìŠ¤íŠ¸ 5", "tag": "ì‚¼ë³µ", "product": "ê²½ì˜¥ê³ "},
        {"topic": "ì—¬ë¦„ ìˆ˜ì˜ì¥ ë¬¼, ëˆˆÂ·ê·€Â·í”¼ë¶€ê°€ ìœ„í—˜í•œ ì´ìœ ", "tag": "ì‹œì¦Œ", "product": "ì—†ìŒ"},
        {"topic": "ëƒ‰ë©´ í•œ ê·¸ë¦‡ ì¹¼ë¡œë¦¬, ì—¬ë¦„ êµ­ìˆ˜ì˜ ë°°ì‹ ", "tag": "ì‹œì¦Œ", "product": "ì—†ìŒ"},
        {"topic": "7ì›” ìì™¸ì„  í”¼í¬, SPF 50ë„ ëª» ë§‰ëŠ” ìì™¸ì„ ì˜ ì •ì²´", "tag": "ì‹œì¦Œ", "product": "ì—†ìŒ"},
        {"topic": "ì—¬ë¦„ ê³¼ì¼ ìˆ˜ë°•, ë¨¹ê¸° ì „ ì•Œì•„ì•¼ í•  ë‹¹ë‡¨ ìœ„í—˜ ìˆ˜ì¹˜", "tag": "ì‹œì¦Œ", "product": "ì—†ìŒ"},
        {"topic": "7ì›” ëƒ‰ë°©ë³‘ ì£¼ì˜ë³´, ì—ì–´ì»¨ ì˜¨ë„ 1ë„ ì°¨ì´ì˜ ê±´ê°• ì˜í–¥", "tag": "ì‹œì¦Œ", "product": "ì½œë“œí€µ"},
        {"topic": "ì—¬ë¦„ ìº í•‘ ì‹ì¤‘ë…, ë°”ë² í ê³ ê¸° ì˜¨ë„ê³„ê°€ í•„ìˆ˜ì¸ ì´ìœ ", "tag": "ì‹œì¦Œ", "product": "ê¹ŒìŠ¤í€µ"},
    ],
    8: [  # 8ì›”
        {"topic": "ë§ë³µ ë³´ì–‘ì‹, ë™ì˜ë³´ê°ì´ ì¶”ì²œí•œ ì—¬ë¦„ ì›ê¸° íšŒë³µë²•", "tag": "ì‚¼ë³µ", "product": "ê²½ì˜¥ê³ "},
        {"topic": "íœ´ê°€ í›„ìœ ì¦, ì—¬í–‰ í”¼ë¡œê°€ 2ì£¼ë‚˜ ê°€ëŠ” ì´ìœ ", "tag": "íœ´ê°€", "product": "ê³µì§„ë‹¨"},
        {"topic": "ìˆ˜ë°• í•œ í†µì˜ ì˜ì–‘ì†Œ, ì•Œê³  ë¨¹ìœ¼ë©´ ì•½ì´ ëœë‹¤?", "tag": "ì‹œì¦Œ", "product": "ì—†ìŒ"},
        {"topic": "ê´‘ë³µì ˆ íƒœê·¹ê¸° ì† ê±´ê³¤ê°ë¦¬, í•œì˜í•™ê³¼ì˜ ë†€ë¼ìš´ ì—°ê²°", "tag": "ê´‘ë³µì ˆ", "product": "ì—†ìŒ"},
        {"topic": "8ì›” ì”ì—¬ ë”ìœ„, ëŠ¦ë”ìœ„ì— ì§€ì¹œ ëª¸ íšŒë³µí•˜ëŠ” ë³´ì–‘ ì „ëµ", "tag": "ì‹œì¦Œ", "product": "ê²½ì˜¥ê³ "},
        {"topic": "ì—¬ë¦„ í•´ìˆ˜ìš• í›„ ê·€ í†µì¦, ì™¸ì´ë„ì—¼ ì˜ˆë°© 3ë‹¨ê³„", "tag": "íœ´ê°€", "product": "ì—†ìŒ"},
        {"topic": "8ì›” ì•¼ì™¸ í™œë™, ë²Œ ì˜ì„ ì‘ê¸‰ì²˜ì¹˜ì™€ ì•Œë ˆë¥´ê¸° ì‡¼í¬ ëŒ€ë¹„ë²•", "tag": "ì‹œì¦Œ", "product": "ì—†ìŒ"},
        {"topic": "ê°œí•™ ì•ë‘” ì•„ì´ ìˆ˜ë©´ ë¦¬ë“¬, 2ì£¼ ì „ë¶€í„° ì¤€ë¹„í•´ì•¼ í•˜ëŠ” ì´ìœ ", "tag": "ì‹œì¦Œ", "product": "ê³µì§„ë‹¨"},
        {"topic": "ì—¬ë¦„ ëìë½ ì‹ì¤‘ë… ì£¼ì˜, 8ì›”ì´ ê°€ì¥ ìœ„í—˜í•œ ë‹¬", "tag": "ì‹œì¦Œ", "product": "ê¹ŒìŠ¤í€µ"},
        {"topic": "íƒœí’ ì‹œì¦Œ, ê¸°ì•• ë³€í™”ê°€ ë‘í†µì„ ì¼ìœ¼í‚¤ëŠ” ê³¼í•™ì  ì´ìœ ", "tag": "ì‹œì¦Œ", "product": "ì—†ìŒ"},
        {"topic": "8ì›” ëŠ¦ë”ìœ„ ë¶ˆë©´ì¦, ìˆ˜ë©´ ì§ˆì„ ë†’ì´ëŠ” 5ê°€ì§€ í™˜ê²½ ì„¸íŒ…", "tag": "ì‹œì¦Œ", "product": "ê³µì§„ë‹¨"},
        {"topic": "ë°©í•™ ë ì•„ì´ ì²´ë ¥ ì ê²€, ì„±ì¥ê¸° ë³´ì•½ íƒ€ì´ë°ì€?", "tag": "ì‹œì¦Œ", "product": "ë…¹ìš©í•œì•½"},
    ],
    9: [  # 9ì›”
        {"topic": "ì¶”ì„ ì†¡í¸ ì† ì†”ì, ë™ì˜ë³´ê°ì´ ë§í•˜ëŠ” íš¨ëŠ¥", "tag": "ì¶”ì„", "product": "ê²½ì˜¥ê³ "},
        {"topic": "9ì›” 21ì¼ ì¹˜ë§¤ê·¹ë³µì˜ ë‚ , ê¸°ì–µì„ ì§€í‚¤ëŠ” ë‡Œ ê±´ê°• ìŠµê´€", "tag": "ê¸°ë…ì¼", "product": "ê³µì§„ë‹¨"},
        {"topic": "ê°€ì„ ë‹¨í’ë†€ì´, ê±·ê¸°ê°€ ë‡Œì— ì£¼ëŠ” ì„ ë¬¼", "tag": "ì‹œì¦Œ", "product": "ë…¹ìš©í•œì•½"},
        {"topic": "í—ˆì¤€ëŸ°(RUN), ë‹¬ë¦¬ë©´ì„œ ë§Œë‚˜ëŠ” ë™ì˜ë³´ê° ì´ì•¼ê¸°", "tag": "ì´ë²¤íŠ¸", "product": "ê²½ì˜¥ê³ "},
        {"topic": "ì¶”ì„ ì°¨ë¡€ìƒ ë‚˜ë¬¼, ê³ ì‚¬ë¦¬Â·ë„ë¼ì§€Â·ì‹œê¸ˆì¹˜ì˜ ì•½íš¨", "tag": "ì¶”ì„", "product": "ê²½ì˜¥ê³ "},
        {"topic": "9ì›” í™˜ì ˆê¸°, ì¼êµì°¨ 10ë„ê°€ ë©´ì—­ë ¥ì— ë¯¸ì¹˜ëŠ” ì˜í–¥", "tag": "ì‹œì¦Œ", "product": "ì½œë“œí€µ"},
        {"topic": "ì¶”ì„ ì—°íœ´ ê³¼ì‹, ëª…ì ˆ ì†Œí™”ë¶ˆëŸ‰ íƒˆì¶œ 3ë‹¨ê³„", "tag": "ì¶”ì„", "product": "ê¹ŒìŠ¤í€µ"},
        {"topic": "ê°€ì„ ë“±ì‚° ì‹œì¦Œ, ë‹¨í’ ì‚°í–‰ ì „ ì²´í¬í•´ì•¼ í•  ê´€ì ˆ ìƒíƒœ", "tag": "ì‹œì¦Œ", "product": "ë…¹ìš©í•œì•½"},
        {"topic": "9ì›” ì œì²  ëŒ€ì¶”, ë™ì˜ë³´ê°ì´ ë§í•˜ëŠ” 'ëŒ€ì¶” 3ì•Œì˜ ê¸°ì '", "tag": "ì‹œì¦Œ", "product": "ê²½ì˜¥ê³ "},
        {"topic": "í™˜ì ˆê¸° ê°ê¸° vs ì½”ë¡œë‚˜, 2024 êµ¬ë¶„ë²• ì´ì •ë¦¬", "tag": "ì‹œì¦Œ", "product": "ì½œë“œí€µ"},
        {"topic": "ê°€ì„ ìš°ìš¸ì¦ ì‹œì‘ë˜ëŠ” 9ì›”, ì„¸ë¡œí† ë‹Œì„ ì˜¬ë¦¬ëŠ” ì‹í’ˆ 5ê°€ì§€", "tag": "ì‹œì¦Œ", "product": "ì—†ìŒ"},
        {"topic": "ì¶”ì„ ê·€ì„±ê¸¸ ì¥ì‹œê°„ ìš´ì „, í—ˆë¦¬Â·ëª© ì§€í‚¤ëŠ” ìŠ¤íŠ¸ë ˆì¹­", "tag": "ì¶”ì„", "product": "ì—†ìŒ"},
    ],
    10: [  # 10ì›”
        {"topic": "10ì›” ê°„ì˜ ë‚ , ë‚´ ê°„ì€ ëª‡ ì‚´ì¼ê¹Œ?", "tag": "ê¸°ë…ì¼", "product": "ê³µì§„ë‹¨"},
        {"topic": "ë°¤í‹°ë¼ë¯¸ìˆ˜ ì—´í’, ë°¤ì´ ë³´ì•½ì´ë¼ ë¶ˆë¦° ì´ìœ ", "tag": "íŠ¸ë Œë“œ", "product": "ê²½ì˜¥ê³ "},
        {"topic": "í• ë¡œìœˆ í˜¸ë°•, ì¡°ì„ ì‹œëŒ€ì—ëŠ” ì•½ì¬ì˜€ë‹¤ê³ ?", "tag": "í• ë¡œìœˆ", "product": "ì—†ìŒ"},
        {"topic": "ê°€ì„ ì¶•ì œ ì‹œì¦Œ, ì§€ê¸ˆ ê°€ê¸° ë”± ì¢‹ì€ ê±´ê°• í•«í”Œ 5ê³³", "tag": "ì‹œì¦Œ", "product": "ì—†ìŒ"},
        {"topic": "ê³ ì–‘ì´ê°€ ì½œë ˆë¼ ì˜ˆë°©ì„? ì¡°ì„ ì‹œëŒ€ ì—­ë³‘ ì´ì•¼ê¸°", "tag": "ì‹œì¦Œ", "product": "ì—†ìŒ"},
        {"topic": "10ì›” ë‹¨í’ ë“±ì‚°, ë°œëª© ì ‘ì§ˆë ¸ì„ ë•Œ RICE ì‘ê¸‰ì²˜ì¹˜", "tag": "ì‹œì¦Œ", "product": "ë…¹ìš©í•œì•½"},
        {"topic": "ê°€ì„ ê±´ì¡° ì‹œì¦Œ, ê¸°ì¹¨ì´ 3ì£¼ ì´ìƒì´ë©´ ì˜ì‹¬í•´ì•¼ í•  ê²ƒ", "tag": "ì‹œì¦Œ", "product": "ê²½ì˜¥ê³ "},
        {"topic": "10ì›” ë…ê° ì˜ˆë°©ì ‘ì¢… ì‹œì¦Œ, ë§ì•„ì•¼ í•  ì‚¬ëŒ vs ì£¼ì˜í•  ì‚¬ëŒ", "tag": "ì‹œì¦Œ", "product": "ì½œë“œí€µ"},
        {"topic": "ê°€ì„ ì „ì–´ ì‹œì¦Œ, ì˜¤ë©”ê°€3ê°€ í’ë¶€í•œ ì œì²  ìƒì„ ì˜ íš¨ëŠ¥", "tag": "ì‹œì¦Œ", "product": "ì—†ìŒ"},
        {"topic": "10ì›” í•‘í¬ë¦¬ë³¸ ìœ ë°©ì•” ì¸ì‹ì˜ ë‹¬, ìê°€ê²€ì§„ ë°©ë²• ì´ì •ë¦¬", "tag": "ê¸°ë…ì¼", "product": "ì—†ìŒ"},
        {"topic": "í• ë¡œìœˆ ì‚¬íƒ• ëŒ€ë€, ì•„ì´ ì¶©ì¹˜ ì˜ˆë°©í•˜ëŠ” ê°„ì‹ ëŒ€ì²´ë²•", "tag": "í• ë¡œìœˆ", "product": "ì—†ìŒ"},
        {"topic": "ê°€ì„ ë‚™ì—½ ì‚°ì±…, 30ë¶„ ê±·ê¸°ê°€ í˜ˆë‹¹ì„ ì¡ëŠ” ì›ë¦¬", "tag": "ì‹œì¦Œ", "product": "ì—†ìŒ"},
    ],
    11: [  # 11ì›”
        {"topic": "ìˆ˜ëŠ¥ D-day, ìˆ˜í—˜ìƒ ë‡Œë¥¼ ê¹¨ìš°ëŠ” ë§ˆì§€ë§‰ ì»¨ë””ì…˜ ê´€ë¦¬", "tag": "ìˆ˜ëŠ¥", "product": "ê³µì§„ë‹¨"},
        {"topic": "ë¹¼ë¹¼ë¡œë°ì´, ë¬´ì‹¬ì½” ë¨¹ì€ ë¹¼ë¹¼ë¡œê°€ ê³µê¹ƒë°¥ ì¹¼ë¡œë¦¬?", "tag": "ë¹¼ë¹¼ë¡œë°ì´", "product": "ì—†ìŒ"},
        {"topic": "ê¹€ì¥ ì‹œì¦Œ, ë°œíš¨ ìŒì‹ì´ ì¥ ê±´ê°•ì„ ë°”ê¾¸ëŠ” ê³¼í•™", "tag": "ê¹€ì¥", "product": "ê²½ì˜¥ê³ "},
        {"topic": "11ì›” 11ì¼ ë†ì—…ì¸ì˜ ë‚ , ì•½ì¬ ë†ë¶€ê°€ ì „í•˜ëŠ” í•œì•½ ì´ì•¼ê¸°", "tag": "ê¸°ë…ì¼", "product": "ë…¹ìš©í•œì•½"},
        {"topic": "ìˆ˜ëŠ¥ ë ìˆ˜í—˜ìƒ, ì‹œí—˜ í›„ ë©´ì—­ë ¥ ë¶•ê´´ë¥¼ ë§‰ëŠ” íšŒë³µë²•", "tag": "ìˆ˜ëŠ¥", "product": "ê³µì§„ë‹¨"},
        {"topic": "11ì›” ì²« í•œíŒŒ, ê°‘ì‘ìŠ¤ëŸ° ì¶”ìœ„ì— í˜ˆê´€ì´ ë°˜ì‘í•˜ëŠ” ë°©ì‹", "tag": "ì‹œì¦Œ", "product": "ìš°í™©ì²­ì‹¬ì›"},
        {"topic": "ê¹€ì¥ í—ˆë¦¬ í†µì¦, ìª¼ê·¸ë ¤ ì•‰ëŠ” ìì„¸ê°€ ë””ìŠ¤í¬ë¥¼ ë¶€ë¥¸ë‹¤", "tag": "ê¹€ì¥", "product": "ë…¹ìš©í•œì•½"},
        {"topic": "ê°€ì„ ëìë½ ë¹„íƒ€ë¯¼D ë¶€ì¡±, 11ì›”ë¶€í„° ì±™ê²¨ì•¼ í•˜ëŠ” ì´ìœ ", "tag": "ì‹œì¦Œ", "product": "ì—†ìŒ"},
        {"topic": "11ì›” ì œì²  í™ì‹œ, ìˆ™ì·¨ í•´ì†Œì— ê°ì´ ì¢‹ì€ ê³¼í•™ì  ì´ìœ ", "tag": "ì‹œì¦Œ", "product": "ì—†ìŒ"},
        {"topic": "ìˆ˜ëŠ¥ ì „ ê¸´ì¥ê³¼ ë³µí†µ, ìŠ¤íŠ¸ë ˆìŠ¤ê°€ ì¥ì— ë¯¸ì¹˜ëŠ” ì˜í–¥", "tag": "ìˆ˜ëŠ¥", "product": "ê¹ŒìŠ¤í€µ"},
        {"topic": "11ì›” ë‚œë°© ì‹œì‘, ê±´ì¡°í•œ ì‹¤ë‚´ ê³µê¸°ê°€ í˜¸í¡ê¸°ì— ë¯¸ì¹˜ëŠ” ì˜í–¥", "tag": "ì‹œì¦Œ", "product": "ê²½ì˜¥ê³ "},
        {"topic": "ë¸”ë™í”„ë¼ì´ë°ì´ ê±´ê°•ì‹í’ˆ ì‡¼í•‘, ê¼­ ì²´í¬í•  ì„±ë¶„í‘œ ì½ê¸°ë²•", "tag": "ì´ë²¤íŠ¸", "product": "ì—†ìŒ"},
    ],
    12: [  # 12ì›”
        {"topic": "ì—°ë§ ëª¨ì„ ìˆ™ì·¨ ìƒì¡´ë²•, 46ë…„ìƒ íŠ¸ëŸ¼í”„ì˜ ê±´ê°• ë¹„ê²°", "tag": "ì—°ë§", "product": "ê³µì§„ë‹¨"},
        {"topic": "íŒ¥ë¶• vs ìŠˆë¶•, ë‹¹ì‹ ì˜ ì„ íƒì€? ê²¨ìš¸ ê°„ì‹ ê±´ê°• ë¹„êµ", "tag": "íŠ¸ë Œë“œ", "product": "ì—†ìŒ"},
        {"topic": "í¬ë¦¬ìŠ¤ë§ˆìŠ¤ ì¼€ì´í¬ ì† ìˆ¨ì€ ì¹¼ë¡œë¦¬, ì•Œê³  ë¨¹ì", "tag": "í¬ë¦¬ìŠ¤ë§ˆìŠ¤", "product": "ì—†ìŒ"},
        {"topic": "ë™ì§€ íŒ¥ì£½, ì¡°ì„  ì™•ì‹¤ì˜ ê²¨ìš¸ ë³´ì–‘ ì˜ì‹", "tag": "ë™ì§€", "product": "ê²½ì˜¥ê³ "},
        {"topic": "ê²¨ìš¸ ì¡±ìš•ì˜ ê³¼í•™, ë°œì„ ë”°ëœ»í•˜ê²Œ í•˜ë©´ ìˆ™ë©´ì´ ì˜¨ë‹¤?", "tag": "ì‹œì¦Œ", "product": "ì—†ìŒ"},
        {"topic": "12ì›” í•œíŒŒ ì† ì‹¬ì¥ë§ˆë¹„ ê¸‰ì¦, ìƒˆë²½ ìš´ë™ì´ ìœ„í—˜í•œ ì´ìœ ", "tag": "ì‹œì¦Œ", "product": "ìš°í™©ì²­ì‹¬ì›"},
        {"topic": "ì—°ë§ íšŒì‹ í­íƒ„, ê°„ì´ ì²˜ë¦¬í•  ìˆ˜ ìˆëŠ” ì•Œì½”ì˜¬ì˜ í•œê³„", "tag": "ì—°ë§", "product": "ê³µì§„ë‹¨"},
        {"topic": "í¬ë¦¬ìŠ¤ë§ˆìŠ¤ ì„ ë¬¼ ì¶”ì²œ, ë¶€ëª¨ë‹˜ ê±´ê°• ì„ ë¬¼ ë² ìŠ¤íŠ¸ 5", "tag": "í¬ë¦¬ìŠ¤ë§ˆìŠ¤", "product": "ê²½ì˜¥ê³ "},
        {"topic": "ê²¨ìš¸ ë…¸ë¡œë°”ì´ëŸ¬ìŠ¤ ì£¼ì˜ë³´, êµ´Â·ì¡°ê°œ ì•ˆì „í•˜ê²Œ ë¨¹ëŠ” ë²•", "tag": "ì‹œì¦Œ", "product": "ê¹ŒìŠ¤í€µ"},
        {"topic": "ì—°ë§ ë²ˆì•„ì›ƒ, 1ë…„ì˜ í”¼ë¡œê°€ í•œêº¼ë²ˆì— ëª°ë ¤ì˜¤ëŠ” ì´ìœ ", "tag": "ì—°ë§", "product": "ê³µì§„ë‹¨"},
        {"topic": "12ì›” ì œì²  ê·¤, ê»ì§ˆê¹Œì§€ ì•½ì¬ë¡œ ì“°ëŠ” ë™ì˜ë³´ê° í™œìš©ë²•", "tag": "ì‹œì¦Œ", "product": "ê²½ì˜¥ê³ "},
        {"topic": "ìƒˆí•´ ì „ì•¼ ë¶ˆë©´ì¦, ì—°ë§ í¥ë¶„ì´ ìˆ˜ë©´ ë¦¬ë“¬ì„ ê¹¨ëŠ” ì›ë¦¬", "tag": "ì—°ë§", "product": "ì—†ìŒ"},
    ],
}

# ì ˆê¸°Â·ì‹œì¦Œë³„ ì£¼ì œ í’€ (ì›”ë³„ ì´ë²¤íŠ¸ì—ì„œ ë™ì  ìƒì„±)
_SEASONAL_TOPICS = {
    "winter": [
        "í˜¹ì‹œ ì—˜ì‚¬? ì†ë°œì´ ì°¨ê°€ìš´ ë‹¹ì‹ ì—ê²Œ",
        "ì˜¬ ê²¨ìš¸, ìƒê°• ì—†ìœ¼ë©´ ì†í•´",
        "ê²¨ìš¸ì²  ë°œ ê±´ê°•, ì¡±ìš•ì´ ìˆ™ë©´ê¹Œì§€ ë°”ê¾¼ë‹¤?",
        "ê²¨ìš¸ì  ìëŠ” ë™ë¬¼ vs ë¶ˆë©´ì¦ í˜„ëŒ€ì¸",
        "ë¹„íƒ€ë¯¼D ë¶€ì¡±ì´ ê²¨ìš¸ ìš°ìš¸ì¦ì„ ë¶€ë¥¸ë‹¤?",
        "ê²¨ìš¸ í•œíŒŒ ì† í˜ˆì•• ê¸‰ë“±, ì•„ì¹¨ ê¸°ìƒ ì‹œ ì£¼ì˜í•  ì ",
        "í•«ì´ˆì½” í•œ ì”ì˜ ê³¼í•™, ì¹´ì¹´ì˜¤ê°€ í˜ˆê´€ì— ë¯¸ì¹˜ëŠ” íš¨ê³¼",
        "ê²¨ìš¸ ì‹¤ë‚´ ê±´ì¡°, ê°€ìŠµê¸° ì—†ì´ ìŠµë„ ì˜¬ë¦¬ëŠ” ìƒí™œ ê¿€íŒ",
        "ìŠ¤í‚¤Â·ë³´ë“œ ì‹œì¦Œ, ë¬´ë¦ ë¶€ìƒ ì˜ˆë°©í•˜ëŠ” ì¤€ë¹„ ìš´ë™ 5ê°€ì§€",
        "ê²¨ìš¸ ê°ê¸° vs ë…ê° vs ì½”ë¡œë‚˜, ì´ˆê¸° ì¦ìƒ êµ¬ë³„ë²•",
        "ë”°ëœ»í•œ êµ­ë¬¼ ìš”ë¦¬, ê²¨ìš¸ ë©´ì—­ë ¥ ì˜¬ë¦¬ëŠ” ì•½ì„  ë ˆì‹œí”¼ 3ê°€ì§€",
        "ê²¨ìš¸ì²  ì •ì „ê¸°, ê±´ì¡°í•œ í”¼ë¶€ê°€ ë³´ë‚´ëŠ” ìˆ˜ë¶„ SOS",
        "ì¶”ìš´ ë‚  ë”°ëœ»í•œ ì°¨ í•œì”, ëŒ€ì¶”ì°¨Â·ìƒê°•ì°¨Â·ê³„í”¼ì°¨ íš¨ëŠ¥ ë¹„êµ",
        "ê²¨ìš¸ ìš´ë™ ë”œë ˆë§ˆ, ì‹¤ë‚´ vs ì‹¤ì™¸ ì¹¼ë¡œë¦¬ ì†Œëª¨ ì°¨ì´",
        "ì—°ë§ ê³¼ìŒ ì‹œì¦Œ, ê°„ì´ íšŒë³µí•˜ëŠ” ë° ê±¸ë¦¬ëŠ” ì‹œê°„ì€?",
    ],
    "spring": [
        "ë²šê½ƒì€ ì˜ˆìœë° ì™œ ëˆˆë¬¼ì´? ê½ƒê°€ë£¨ ì•Œë ˆë¥´ê¸°ì˜ ì§„ì§œ ì›ì¸",
        "ë´„ë‚˜ë¬¼ì´ ìŠˆí¼í‘¸ë“œ? ëƒ‰ì´ í•œ ì¤Œì˜ ì˜ì–‘ ì„±ë¶„ ë¶„ì„",
        "í™©ì‚¬ ë§ˆìŠ¤í¬ë¡œëŠ” ë¶€ì¡±í•´, íë¥¼ ì§€í‚¤ëŠ” ë™ì˜ë³´ê° ì²˜ë°©",
        "3ì›” ìƒˆ í•™ê¸°, ì•„ì´ í‚¤ ì„±ì¥ì˜ ê³¨ë“ íƒ€ì„ì€ ì–¸ì œ?",
        "ì¶˜ê³¤ì¦ ë•Œë¬¸ì— ì¡¸ë¦° ê²Œ ì•„ë‹™ë‹ˆë‹¤ â€” ë‡Œì˜ SOS ì‹ í˜¸",
        "ë´„ í”¼í¬ë‹‰ ì‹œì¦Œ, ì•¼ì™¸ í™œë™ì´ ì„¸ë¡œí† ë‹Œì„ ì˜¬ë¦¬ëŠ” ì›ë¦¬",
        "ë´„ì²  ë¯¸ì„¸ë¨¼ì§€ vs ì´ˆë¯¸ì„¸ë¨¼ì§€, ì§„ì§œ ìœ„í—˜í•œ ê±´ ì–´ëŠ ìª½?",
        "í™˜ì ˆê¸° í”¼ë¶€ íŠ¸ëŸ¬ë¸”, ì•ˆì—ì„œë¶€í„° ì¡ëŠ” í•œë°© ìŠ¤í‚¨ì¼€ì–´",
        "ë´„ ì œì²  ë”¸ê¸°, ë¹„íƒ€ë¯¼C í•¨ëŸ‰ì´ ë ˆëª¬ë³´ë‹¤ ë†’ë‹¤?",
        "4ì›” ë²šê½ƒ ì‚°ì±…, í•˜ë£¨ 30ë¶„ ê±·ê¸°ê°€ ë‡Œë¥¼ ë°”ê¾¸ëŠ” ê³¼í•™",
        "ë´„ ìƒˆì‹¹ ë¹„ë¹”ë°¥, ë°œì•„ ì‹ë¬¼ì˜ ìˆ¨ê²¨ì§„ ì˜ì–‘ì†Œ ë¶„ì„",
        "ê½ƒê°€ë£¨+í™©ì‚¬ ë”ë¸” í€ì¹˜, ë´„ì²  í˜¸í¡ê¸° ì§€í‚¤ëŠ” 3ë‹¨ê³„",
        "ë´„ ë‹¤ì´ì–´íŠ¸, ê¸°ì´ˆëŒ€ì‚¬ëŸ‰ì„ ì˜¬ë¦¬ëŠ” ì‹ì´ìš”ë²• vs ìš´ë™",
        "í™˜ì ˆê¸° ë©´ì—­ë ¥ ì €í•˜, ë¹„íƒ€ë¯¼CÂ·DÂ·ì•„ì—° ìµœì  ì¡°í•©ì€?",
        "ë´„ ë‚ ì”¨ ë“¤ì­‰ë‚ ì­‰, ê¸°ì˜¨ ë³€í™”ì— ììœ¨ì‹ ê²½ì´ ë°˜ì‘í•˜ëŠ” ë²•",
    ],
    "summer": [
        "ì‚¼ê³„íƒ• ë§ê³ ë„ ìˆë‹¤, ë™ì˜ë³´ê° ì—¬ë¦„ ë³´ì–‘ì‹ 3ì„ ",
        "ì—ì–´ì»¨ í‹€ë©´ ì™œ ë¨¸ë¦¬ê°€ ì•„í”Œê¹Œ? ëƒ‰ë°©ë³‘ì˜ ì •ì²´",
        "ì—´ëŒ€ì•¼ì— ì  ëª» ë“œëŠ” ë°¤, ì¡°ì„  ì™•ì‹¤ì˜ ì—¬ë¦„ë‚˜ê¸°",
        "ë¬¼ë§Œ ë§ˆì‹œë©´ ì•ˆ ëœë‹¤? ì—¬ë¦„ ìˆ˜ë¶„ ë³´ì¶©ì˜ ê³¼í•™",
        "ì—¬ë¦„ ë§¥ì£¼ í•œ ì”ì´ ê°„ì— ë¯¸ì¹˜ëŠ” 72ì‹œê°„ì˜ ì—¬ì •",
        "ì¥ë§ˆì²  ìŠµí•œ ë‚ , ê´€ì ˆì´ ì•„í”ˆ ì§„ì§œ ì´ìœ ëŠ” ê¸°ì••?",
        "ì—¬ë¦„ ìì™¸ì„ ì´ í”¼ë¶€ ë…¸í™”ì˜ 80%ë¥¼ ì°¨ì§€í•œë‹¤?",
        "ì•„ì´ìŠ¤ ì•„ë©”ë¦¬ì¹´ë…¸ 3ì”, ì¹´í˜ì¸ì´ ì—¬ë¦„ íƒˆìˆ˜ë¥¼ ë¶€ë¥¸ë‹¤",
        "ë°”ë‹¤ ìˆ˜ì˜ vs ìˆ˜ì˜ì¥, ìš´ë™ íš¨ê³¼ê°€ ë‹¤ë¥¸ ê³¼í•™ì  ì´ìœ ",
        "ì—¬ë¦„ íšŒÂ·ì´ˆë°¥ ì‹ì¤‘ë…, ë¹„ë¸Œë¦¬ì˜¤ê·  ì˜ˆë°©í•˜ëŠ” ì˜¨ë„ ê´€ë¦¬ë²•",
        "í­ì—¼ ì† ì•¼ì™¸ ìš´ë™, ì—´ì‚¬ë³‘ ì „ì¡°ì¦ìƒ ì•Œì•„ì±„ëŠ” ì²´í¬ë¦¬ìŠ¤íŠ¸",
        "ì—¬ë¦„ ì œì²  ë³µìˆ­ì•„, í•œì˜í•™ì—ì„œ ë§í•˜ëŠ” ì˜ì™¸ì˜ íš¨ëŠ¥",
        "ëƒ‰ë°©ë³‘ vs ê°ê¸°, ì¦ìƒì€ ë¹„ìŠ·í•œë° ì¹˜ë£Œë²•ì´ ë‹¤ë¥¸ ì´ìœ ",
        "ì—¬ë¦„ ë¶ˆë©´ì¦, ì¹¨ì‹¤ ì˜¨ë„ 1ë„ê°€ ìˆ˜ë©´ ì§ˆì„ ì¢Œìš°í•œë‹¤",
        "ì¥ë§ˆ í›„ í­ì—¼, ìŠµë„+ì˜¨ë„ ì¡°í•©ì´ ì²´ê°ì˜¨ë„ë¥¼ ì˜¬ë¦¬ëŠ” ë²•",
    ],
    "autumn": [
        "ê³µì§„ë‹¨ì²˜ëŸ¼ ê½‰ ì°¬ ì¶”ì„ ë³´ë‚´ì„¸ìš”!",
        "í™˜ì ˆê¸°ë§ˆë‹¤ ê°ê¸° ê±¸ë¦°ë‹¤ë©´? ë©´ì—­ë ¥ì˜ ì§„ì§œ ë¹„ë°€",
        "ê°€ì„ ìš°ìš¸ì¦, ì¼ì¡°ëŸ‰ê³¼ ì„¸ë¡œí† ë‹Œì˜ ìˆ¨ì€ ê´€ê³„",
        "10ì›” ê°„ì˜ ë‚ , ë‚´ ê°„ì€ í”¼ê³¤í•˜ë‹¤",
        "ë‹¨í’ ì‚°ì±…ì´ ë‡Œì— ì£¼ëŠ” ì„ ë¬¼, ê±·ê¸°ì˜ ê³¼í•™",
        "ê°€ì„ ë…ì„œ ì‹œì¦Œ, ì±… ì½ê¸°ê°€ ì¹˜ë§¤ ì˜ˆë°©ì— íš¨ê³¼ì ì¸ ì´ìœ ",
        "í™˜ì ˆê¸° ì½”ë§‰í˜, ë¹„ì—¼ vs ê°ê¸° êµ¬ë³„í•˜ëŠ” 3ê°€ì§€ í¬ì¸íŠ¸",
        "ê°€ì„ ì œì²  ë°°, ê¸°ì¹¨Â·ê°€ë˜ì— ë°°ì¦™ì´ í†µí•˜ëŠ” ê³¼í•™ì  ê·¼ê±°",
        "10ì›” ì¼êµì°¨ 15ë„, ì‹¬í˜ˆê´€ ì‚¬ê³ ê°€ ê¸‰ì¦í•˜ëŠ” ê³„ì ˆ",
        "ê°€ì„ í”¼ë¶€ ê±´ì¡°, ë³´ìŠµì œë§Œìœ¼ë¡  ë¶€ì¡±í•œ ì´ìœ ì™€ ëŒ€ì•ˆ",
        "í™˜ì ˆê¸° íƒˆëª¨ ì‹œì¦Œ, í•˜ë£¨ 100ê°œ ì´ìƒ ë¹ ì§€ë©´ ì˜ì‹¬í•´ì•¼ í•  ê²ƒ",
        "ê°€ì„ ìº í•‘ ì‹œì¦Œ, ì•¼ì™¸ ì·¨ì¹¨ ì‹œ ì €ì²´ì˜¨ì¦ ì˜ˆë°©ë²•",
        "ì¶”ì„ ì´í›„ ì²´ì¤‘ ì¦ê°€, 3kg ë¹¼ëŠ” ë° í•„ìš”í•œ í˜„ì‹¤ì  ê¸°ê°„",
        "ê°€ì„ ìš´ë™ì˜ í™©ê¸ˆê¸°, ì„ ì„ í•œ ë‚ ì”¨ê°€ ìš´ë™ íš¨ìœ¨ì„ ë†’ì´ëŠ” ì´ìœ ",
        "11ì›”ë¡œ ê°€ëŠ” í™˜ì ˆê¸°, ìˆ˜ë©´ ë¦¬ë“¬ì´ ííŠ¸ëŸ¬ì§€ëŠ” ê³¼í•™ì  ì´ìœ ",
    ],
}

# ì ˆê¸°ë³„ íŠ¹í™” ì£¼ì œ
_SOLAR_TERM_TOPICS = {
    "ì…ì¶˜": "ì…ì¶˜ì— ë¨¹ëŠ” ì˜¤ì‹ ì±„, ë™ì˜ë³´ê°ì´ ë§í•˜ëŠ” ë´„ í•´ë… ì•½ì¬",
    "ìš°ìˆ˜": "ìš°ìˆ˜(é›¨æ°´) ì ˆê¸°, ë´„ë¹„ê°€ í”¼ë¶€ ê±´ì¡°ë¥¼ ë¶€ë¥´ëŠ” ì´ìœ ",
    "ê²½ì¹©": "ê²½ì¹©ì— ê¹¨ì–´ë‚˜ëŠ” ê±´ ë²Œë ˆë¿? ìš°ë¦¬ ëª¸ë„ ë¦¬ì…‹í•´ì•¼ í•  ë•Œ",
    "ì¶˜ë¶„": "ë‚®ë°¤ ê°™ì•„ì§€ëŠ” ì¶˜ë¶„, ìˆ˜ë©´ ë¦¬ë“¬ ë§ì¶”ëŠ” í™©ê¸ˆ íƒ€ì´ë°",
    "ì²­ëª…": "ì²­ëª…ì— ì°¨ë¥¼ ë§ˆì‹œëŠ” ì´ìœ ? 1000ë…„ ëœ ê±´ê°• ì˜ì‹",
    "ê³¡ìš°": "ê³¡ìš°(ç©€é›¨)ì— ëœ¯ëŠ” ì‘¥, ì¡°ì„  ì™•ì‹¤ ìµœê³ ì˜ ì•½ì¬ì˜€ë‹¤",
    "ì…í•˜": "ì…í•˜, ë™ì˜ë³´ê°ì´ ë§í•˜ëŠ” ì—¬ë¦„ ì²´ë ¥ ë¹„ì¶•ë²•",
    "ì†Œë§Œ": "ì†Œë§Œ ì ˆê¸°, ë³´ë¦¬ë°¥ì´ ë³´ì•½ì¸ ì´ìœ  â€” ì˜ì–‘ ì„±ë¶„ ë¶„ì„",
    "ë§ì¢…": "ë§ì¢…(èŠ’ç¨®), ì”¨ ë¿Œë¦¬ëŠ” ì ˆê¸°ì— ì œì²  ì•½ì¬ë„ ì‹¬ëŠ”ë‹¤",
    "í•˜ì§€": "í•˜ì§€, ê°€ì¥ ê¸´ ë‚®ì˜ ìì™¸ì„ ì´ í”¼ë¶€ì— ë¯¸ì¹˜ëŠ” ì˜í–¥",
    "ì†Œì„œ": "ì†Œì„œë¶€í„° ì‹œì‘ë˜ëŠ” ë”ìœ„, ì—´ì‚¬ë³‘ê³¼ ì¼ì‚¬ë³‘ì˜ ì°¨ì´ëŠ”?",
    "ëŒ€ì„œ": "ëŒ€ì„œ í­ì—¼ ì† ì¡°ì„  ì™•ì‹¤ì˜ í”¼ì„œë²•, í˜„ëŒ€ì—ë„ í†µí• ê¹Œ?",
    "ì…ì¶”": "ì…ì¶”, ê°€ì„ ëŒ€ë¹„ ë©´ì—­ë ¥ ì¶©ì „ â€” ê²½ì˜¥ê³ ì˜ ê³„ì ˆ",
    "ì²˜ì„œ": "ì²˜ì„œì— ë”ìœ„ ë³´ë‚´ê¸°, ì ì´ ë³´ì•½ì¸ ì§„ì§œ ì´ìœ ",
    "ë°±ë¡œ": "ë°±ë¡œ(ç™½éœ²) ì´ìŠ¬ ì ˆê¸°, í˜¸í¡ê¸°ê°€ ì·¨ì•½í•´ì§€ëŠ” ì‹œê¸°",
    "ì¶”ë¶„": "ì¶”ë¶„ì˜ ë°¤ì´ ê¸¸ì–´ì§€ë©´, ë©œë¼í† ë‹Œì´ ë‹¬ë¼ì§„ë‹¤",
    "í•œë¡œ": "í•œë¡œ(å¯’éœ²), ì°¬ ì´ìŠ¬ì´ ê´€ì ˆì— ë¯¸ì¹˜ëŠ” ì˜í–¥",
    "ìƒê°•": "ìƒê°•ì— ì„œë¦¬ ë‚´ë¦¬ë©´, í˜ˆê´€ì´ ìˆ˜ì¶•í•˜ëŠ” ì´ìœ ",
    "ì…ë™": "ì…ë™, ê¹€ì¹˜ ë‹´ê·¸ëŠ” ë‚  â€” ë°œíš¨ ì‹í’ˆì˜ ê³¼í•™",
    "ì†Œì„¤": "ì†Œì„¤(å°é›ª), ì²«ëˆˆ ì˜¤ëŠ” ì ˆê¸°ì˜ ë©´ì—­ ê°•í™” ì•½ì¬",
    "ëŒ€ì„¤": "ëŒ€ì„¤ ê²¨ìš¸ ì‚°í–‰, ì¶”ìœ„ ì† ìš´ë™ì´ ì¹¼ë¡œë¦¬ë¥¼ 2ë°° íƒœìš´ë‹¤?",
    "ë™ì§€": "ë™ì§€ íŒ¥ì£½ì˜ ë¹„ë°€, íŒ¥ì´ ë³´ì•½ì´ë¼ ë¶ˆë¦° ì´ìœ ",
    "ì†Œí•œ": "ì†Œí•œ, 1ë…„ ì¤‘ ê°€ì¥ ì¶”ìš´ ë‚  â€” ì²´ì˜¨ 1ë„ì˜ ê³¼í•™",
    "ëŒ€í•œ": "ëŒ€í•œ ê°•ì¶”ìœ„, í˜ˆì•¡ì´ ëˆì í•´ì§€ëŠ” ê²¨ìš¸ì˜ ìœ„í—˜",
}

# ì‹œì˜ì„± ìˆëŠ” íŠ¸ë Œë“œ/íŒì»¬ì³ ì£¼ì œ (ì—°ì¤‘ ì‚¬ìš©)
_TRENDING_TOPICS = [
    "ë°”ì´ì˜¤í•´í‚¹ê³¼ ì²´ì§ˆì˜í•™ì˜ ë†€ë¼ìš´ ê³µí†µì ",
    "ìŠ¬ë¡œìš°ì¡°ê¹…, ëŠë¦¬ì§€ë§Œ ê°•ë ¥í•œ ìš´ë™ì˜ í˜",
    "ë„·í”Œë¦­ìŠ¤ ë³´ë©´ì„œ ë¨¹ëŠ” ì•¼ì‹, ë‡Œì— ë¬´ìŠ¨ ì¼ì´?",
    "MZì„¸ëŒ€ ì´ë„ˆë·°í‹° ì—´í’, ì½œë¼ê² ìŒë£Œ ì§„ì§œ íš¨ê³¼ëŠ”?",
    "ë‹¹ì‹ ì€ ê³¨ë£¸ì…ë‹ˆê¹Œ? ê±°ë¶ëª©ì´ ìˆ˜ë©´ì„ ë§ì¹˜ëŠ” ê³¼ì •",
    "ì…€ëŸ½ë“¤ì˜ í”¼ë¡œ íšŒë³µí…œ, ê³µì§„ë‹¨ì´ ì™œ ê±°ê¸°ì„œ ë‚˜ì™€?",
    "SNS í•«í•œ 'ì•„ì¹¨ ë£¨í‹´', ì „ë¬¸ê°€ê°€ ë³¸ ì§„ì§œ íš¨ê³¼",
    "í•˜ë£¨ 1ë§Œë³´ ì‹ í™”, ì§„ì§œ í•„ìš”í•œ ê±´ 4000ë³´?",
    "ì»¤í”¼ 3ì” ì´ìƒ ë§ˆì‹œë©´ ìƒê¸°ëŠ” ëª¸ì˜ ë³€í™” íƒ€ì„ë¼ì¸",
    "ë””ì§€í„¸ ë””í†¡ìŠ¤ê°€ ë‡Œì— ë¯¸ì¹˜ëŠ” 72ì‹œê°„ì˜ ë³€í™”",
    "ê°„í—ì  ë‹¨ì‹ 16:8, ì •ë§ ì‚´ì´ ë¹ ì§€ëŠ” ê±´ ì–¸ì œë¶€í„°?",
    "í•„ë¼í…ŒìŠ¤ vs ìš”ê°€, ì–´ë–¤ ìš´ë™ì´ ë‚´ ëª¸ì— ë§ì„ê¹Œ?",
    "ChatGPT ì‹œëŒ€, AIê°€ ì˜ì‚¬ë¥¼ ëŒ€ì²´í•  ìˆ˜ ìˆì„ê¹Œ?",
    "5ë¶„ ëª…ìƒì´ ë‡Œ êµ¬ì¡°ë¥¼ ë°”ê¾¼ë‹¤? MRIë¡œ ë³¸ ê³¼í•™ì  ì¦ê±°",
    "ì˜¤ë©”ê°€3 vs í¬ë¦´ì˜¤ì¼, ì§„ì§œ íš¨ê³¼ ì°¨ì´ ì´ì •ë¦¬",
    "ë¹„ê±´ ì—´í’, ì±„ì‹ë§Œìœ¼ë¡œ ì¶©ë¶„í•œ ë‹¨ë°±ì§ˆì„ ì–»ì„ ìˆ˜ ìˆë‚˜?",
    "10ì´ˆ ìŠ¤ì¿¼íŠ¸ ì±Œë¦°ì§€, SNS ìœ í–‰ ìš´ë™ì˜ ì§„ì§œ íš¨ê³¼",
    "í”„ë¡œë°”ì´ì˜¤í‹±ìŠ¤ ì „ìŸ, ìœ ì‚°ê·  ìˆ«ìê°€ ì¤‘ìš”í•œ ê²Œ ì•„ë‹ˆë‹¤?",
    "ìˆ˜ë©´ ì•± ì‹œëŒ€, ìˆ˜ë©´ ì¶”ì ì´ ì˜¤íˆë ¤ ë¶ˆë©´ì¦ì„ ìœ ë°œí•œë‹¤?",
    "ì• í”Œì›Œì¹˜ ì‹¬ì „ë„, ì›¨ì–´ëŸ¬ë¸”ì´ ìƒëª…ì„ êµ¬í•œ ì‹¤ì œ ì‚¬ë¡€",
    "ê¸€ë£¨í…í”„ë¦¬ ì—´í’, ë°€ê°€ë£¨ë¥¼ ëŠìœ¼ë©´ ì •ë§ ê±´ê°•í•´ì§ˆê¹Œ?",
    "ëƒ‰ìˆ˜ ìƒ¤ì›Œ ì±Œë¦°ì§€, ì°¬ë¬¼ì´ ë©´ì—­ë ¥ì„ ë†’ì´ëŠ” ê³¼í•™ì  ì›ë¦¬",
    "íƒ•í›„ë£¨ ì—´í’ ê·¸ ì´í›„, ì„¤íƒ• ì½”íŒ…ì´ ì¹˜ì•„ì— ë¯¸ì¹˜ëŠ” ì˜í–¥",
    "ëŸ°ë‹í¬ë£¨ ë¬¸í™”, ê°™ì´ ë›°ë©´ í˜¼ìë³´ë‹¤ 30% ë” ê±´ê°•í•´ì§„ë‹¤?",
    "ë§ˆë¼íƒ• ì¤‘ë…ì˜ ê³¼í•™, ë§¤ìš´ë§›ì´ ë‡Œì— ë¯¸ì¹˜ëŠ” ë„íŒŒë¯¼ íš¨ê³¼",
    "ì†í¥ë¯¼ì˜ ì²´ë ¥ ë¹„ê²°, í”„ë¡œ ì„ ìˆ˜ ì»¨ë””ì…˜ ê´€ë¦¬ë²•ì—ì„œ ë°°ìš°ë‹¤",
    "ì œë¡œìŠˆê±° ìŒë£Œì˜ í•¨ì •, ì¸ê³µê°ë¯¸ë£Œê°€ ì¥ë‚´ ì„¸ê· ì„ ë°”ê¾¼ë‹¤?",
    "í™ˆíŠ¸ ìœ íŠœë¸Œ ì‹œëŒ€, ì˜ëª»ëœ ìì„¸ê°€ ë¶€ìƒì„ ë¶€ë¥´ëŠ” 5ê°€ì§€ ë™ì‘",
    "ì•„ì¹¨í˜• ì¸ê°„ vs ì €ë…í˜• ì¸ê°„, ìœ ì „ìê°€ ìˆ˜ë©´ íŒ¨í„´ì„ ê²°ì •í•œë‹¤?",
    "K-ë·°í‹° ê¸€ë¡œë²Œ ì—´í’, í•œë°© í™”ì¥í’ˆì´ í•´ì™¸ì—ì„œ ì£¼ëª©ë°›ëŠ” ì´ìœ ",
]


def _calc_topic_score(topic: str, tag: str, product: str, source_type: str) -> int:
    """ì¶”ì²œ ì£¼ì œ ì ìˆ˜ ì‚°ì • (100ì  ë§Œì )

    - ì‹œì¦Œ ì í•©ì„± 30ì , ì œí’ˆ ì—°ê²° 20ì , í›„í‚¹ ìš”ì†Œ 20ì ,
      íŠ¸ë Œë“œ ì‹ ì„ ë„ 15ì , ì¶œì²˜ ì‹ ë¢°ë„ 15ì 
    """
    score = 0

    # 1) ì‹œì¦Œ ì í•©ì„± (30ì )
    if source_type == "monthly":
        score += 28  # ì›”ë³„ ì´ë²¤íŠ¸ëŠ” ì‹œì¦Œ ìµœê³ 
    elif source_type == "solar":
        score += 25
    elif source_type in ("google_trend", "x_trend", "naver_trend"):
        score += 24  # ì‹¤ì‹œê°„ íŠ¸ë Œë“œ = ë†’ì€ ì‹œì˜ì„±
    elif source_type == "naver_trend_general":
        score += 24  # ë„¤ì´ë²„ ì‹¤ê²€ = í•œêµ­ ì‚¬ìš©ì ê´€ì‹¬ ìµœê³ 
    elif source_type == "google_trend_general":
        score += 22  # êµ¬ê¸€ ì¼ë°˜ íŠ¸ë Œë“œ
    elif source_type == "news":
        score += 22  # ì‹¤ì‹œê°„ ë‰´ìŠ¤ë„ ì‹œì˜ì„± ë†’ìŒ
    elif source_type == "season":
        score += 20
    else:
        score += 15  # íŠ¸ë Œë“œ (ì—°ì¤‘)

    # 2) ìˆ˜å£½ ì œí’ˆ ì—°ê²° (20ì )
    if product and product != "ì—†ìŒ":
        score += 18
    elif any(kw in topic for kw in ["ê³µì§„ë‹¨", "ê²½ì˜¥ê³ ", "ë…¹ìš©", "í•œì•½", "ë™ì˜ë³´ê°", "í•œì˜"]):
        score += 14
    else:
        score += 6

    # 3) í›„í‚¹ ìš”ì†Œ (20ì )
    hook_score = 8  # ê¸°ë³¸
    if "?" in topic:
        hook_score += 5  # ì§ˆë¬¸í˜•
    if any(c.isdigit() for c in topic):
        hook_score += 4  # ìˆ«ì í¬í•¨
    pop_refs = ["ì—˜ì‚¬", "ê³¨ë£¸", "íŠ¸ëŸ¼í”„", "ì…€ëŸ½", "ë„·í”Œë¦­ìŠ¤", "MZ", "SNS",
                "ë°”ì´ì˜¤í•´í‚¹", "ìŠ¬ë¡œìš°ì¡°ê¹…", "í‹°ë¼ë¯¸ìˆ˜", "ë¹¼ë¹¼ë¡œ"]
    if any(ref in topic for ref in pop_refs):
        hook_score += 3  # íŒì»¬ì³
    score += min(hook_score, 20)

    # 4) íŠ¸ë Œë“œ ì‹ ì„ ë„ (15ì )
    if source_type in ("google_trend", "naver_trend"):
        score += 15  # ì‹¤ì‹œê°„ ê±´ê°• íŠ¸ë Œë“œ = ìµœê³  ì‹ ì„ ë„
    elif source_type == "x_trend":
        score += 14  # X ê±´ê°• íŠ¸ë Œë“œ
    elif source_type == "news":
        score += 13
    elif source_type == "naver_trend_general":
        score += 13  # ë„¤ì´ë²„ ì‹¤ê²€ = ë†’ì€ ì‹¤ì‹œê°„ì„±
    elif source_type == "google_trend_general":
        score += 10  # êµ¬ê¸€ ì¼ë°˜ íŠ¸ë Œë“œ
    elif source_type == "monthly":
        score += 11
    elif source_type in ("solar", "season"):
        score += 9
    else:
        score += 7

    # 5) ì¶œì²˜ ì‹ ë¢°ë„ (15ì )
    trust_kw = ["ë™ì˜ë³´ê°", "ë…¼ë¬¸", "ì—°êµ¬", "ìŠ¹ì •ì›", "ì¡°ì„ ", "ì™•ì‹¤", "ì„¸ì¢…", "ì˜ì¡°", "í—ˆì¤€"]
    if any(kw in topic for kw in trust_kw):
        score += 14
    elif any(kw in topic for kw in ["ê³¼í•™", "íš¨ê³¼", "ì„±ë¶„", "ì¹¼ë¡œë¦¬", "ì‹¬ë°•ìˆ˜"]):
        score += 11
    else:
        score += 8

    return min(score, 100)


# íƒœê·¸ë³„ ì‚¬ìœ  ë§¤í•‘
_REASON_MAP = {
    # ì›”ë³„ ì´ë²¤íŠ¸ íƒœê·¸
    "ìƒˆí•´": "{month}ì›” ì‹œì¦Œ ì´ìŠˆ Â· ìƒˆí•´ ê±´ê°• íŠ¸ë Œë“œ",
    "ëª…ì ˆ": "{month}ì›” ì‹œì¦Œ ì´ìŠˆ Â· ëª…ì ˆ ê±´ê°• ê´€ì‹¬ ê¸‰ì¦",
    "ì„¤ë‚ ": "{month}ì›” ì‹œì¦Œ ì´ìŠˆ Â· ì„¤ ì—°íœ´ ê±´ê°• ê´€ì‹¬",
    "ë°œë Œíƒ€ì¸": "{month}ì›” ì‹œì¦Œ ì´ìŠˆ Â· ë°œë Œíƒ€ì¸ ì‹œì¦Œ",
    "ì¡¸ì—…": "{month}ì›” ì‹œì¦Œ ì´ìŠˆ Â· ì¡¸ì—…Â·ì…í•™ ì‹œì¦Œ",
    "ì‚¼ê²¹ì‚´ë°ì´": "{month}ì›” ê¸°ë…ì¼ Â· ì¸ìŠ¤íƒ€ê·¸ë¨ ì¸ê¸° í•´ì‹œíƒœê·¸",
    "ë§ˆë¼í†¤": "{month}ì›” ì´ë²¤íŠ¸ Â· ë§ˆë¼í†¤Â·ëŸ¬ë‹ ì‹œì¦Œ",
    "ì‹ëª©ì¼": "{month}ì›” ê¸°ë…ì¼ Â· ë´„ ê±´ê°• ê´€ì‹¬",
    "ê³¼í•™ì˜ë‹¬": "{month}ì›” ê¸°ë…ì¼ Â· í•œì˜í•™ ê³¼í•™ ê·¼ê±°",
    "ì–´ë²„ì´ë‚ ": "{month}ì›” ì‹œì¦Œ ì´ìŠˆ Â· ê°€ì •ì˜ ë‹¬ ê±´ê°• ì„ ë¬¼",
    "ê°€ì •ì˜ë‹¬": "{month}ì›” ì‹œì¦Œ ì´ìŠˆ Â· ê°€ì •ì˜ ë‹¬ íŠ¸ë Œë“œ",
    "ìŠ¤ìŠ¹ì˜ë‚ ": "{month}ì›” ê¸°ë…ì¼ Â· í—ˆì¤€ ìŠ¤í† ë¦¬ ì‹œì˜ì„±",
    "ë‹¨ì˜¤": "{month}ì›” ê¸°ë…ì¼ Â· ì „í†µ ê±´ê°• ë¬¸í™”",
    "ì¥ë§ˆ": "{month}ì›” ì‹œì¦Œ ì´ìŠˆ Â· ì¥ë§ˆì²  ê±´ê°• ê´€ì‹¬",
    "ì‚¼ë³µ": "{month}ì›” ì‹œì¦Œ ì´ìŠˆ Â· ë³µë‚  ë³´ì–‘ì‹ íŠ¸ë Œë“œ",
    "íœ´ê°€": "{month}ì›” ì‹œì¦Œ ì´ìŠˆ Â· ì—¬ë¦„ íœ´ê°€ ì‹œì¦Œ",
    "ê´‘ë³µì ˆ": "{month}ì›” ê¸°ë…ì¼ Â· ë¬¸í™” ì½˜í…ì¸ ",
    "ì¶”ì„": "{month}ì›” ì‹œì¦Œ ì´ìŠˆ Â· ì¶”ì„ ëª…ì ˆ ê±´ê°•",
    "ê¸°ë…ì¼": "{month}ì›” ê¸°ë…ì¼ Â· ê±´ê°• ì¸ì‹ ì œê³ ",
    "í• ë¡œìœˆ": "{month}ì›” ì‹œì¦Œ ì´ìŠˆ Â· í• ë¡œìœˆ íŠ¸ë Œë“œ",
    "ìˆ˜ëŠ¥": "{month}ì›” ì‹œì¦Œ ì´ìŠˆ Â· ìˆ˜ëŠ¥ ì‹œì¦Œ ê±´ê°• ê´€ì‹¬ ê¸‰ì¦",
    "ë¹¼ë¹¼ë¡œë°ì´": "{month}ì›” ê¸°ë…ì¼ Â· ì¸ìŠ¤íƒ€ê·¸ë¨ ì¸ê¸° í•´ì‹œíƒœê·¸",
    "ê¹€ì¥": "{month}ì›” ì‹œì¦Œ ì´ìŠˆ Â· ê¹€ì¥ ì‹œì¦Œ ê±´ê°•",
    "ì—°ë§": "{month}ì›” ì‹œì¦Œ ì´ìŠˆ Â· ì—°ë§ ëª¨ì„ ê±´ê°• ê´€ì‹¬",
    "í¬ë¦¬ìŠ¤ë§ˆìŠ¤": "{month}ì›” ì‹œì¦Œ ì´ìŠˆ Â· í¬ë¦¬ìŠ¤ë§ˆìŠ¤ íŠ¸ë Œë“œ",
    "ë™ì§€": "{month}ì›” ê¸°ë…ì¼ Â· ë™ì§€ ì „í†µ ê±´ê°• ë¬¸í™”",
    # ì¼ë°˜
    "ì´ë²¤íŠ¸": "{month}ì›” ì´ë²¤íŠ¸ Â· ì‹œì˜ì„± ë†’ì€ ì´ìŠˆ",
    "ì‹œì¦Œ": "{month}ì›” ì‹œì¦Œ Â· ê³„ì ˆ ê±´ê°• ê´€ì‹¬",
    "íŠ¸ë Œë“œ": "SNS ì¸ê¸° ì£¼ì œ Â· ì¸ìŠ¤íƒ€ê·¸ë¨ ê±´ê°• íŠ¸ë Œë“œ",
}


def _build_reason(tag: str, source_type: str, month: int, extra: str = "") -> str:
    """ì¶”ì²œ ì‚¬ìœ  í…ìŠ¤íŠ¸ ìƒì„±"""
    if source_type == "google_trend":
        base = "ğŸ” êµ¬ê¸€ ì‹¤ì‹œê°„ ê²€ìƒ‰ íŠ¸ë Œë“œ"
        if extra:
            return f"{base} Â· {extra[:20]}"
        return base
    if source_type == "google_trend_general":
        base = "ğŸ” êµ¬ê¸€ ì¸ê¸° ê²€ìƒ‰ì–´ â†’ ê±´ê°• ì—°ê²°"
        if extra:
            return f"{base} Â· {extra[:25]}"
        return base
    if source_type == "x_trend":
        base = "ğ• ì‹¤ì‹œê°„ íŠ¸ë Œë“œ"
        if extra:
            return f"{base} Â· {extra[:25]}"
        return f"{base} Â· ê±´ê°• ì´ìŠˆ"
    if source_type == "naver_trend":
        base = "ğŸ…½ ë„¤ì´ë²„ ì‹¤ì‹œê°„ ê²€ìƒ‰ íŠ¸ë Œë“œ"
        if extra:
            return f"{base} Â· {extra[:20]}"
        return base
    if source_type == "naver_trend_general":
        base = "ğŸ…½ ë„¤ì´ë²„ ì¸ê¸° ê²€ìƒ‰ì–´ â†’ ê±´ê°• ì—°ê²°"
        if extra:
            return f"{base} Â· {extra[:25]}"
        return base
    if source_type == "news":
        base = "ğŸ“° ì‹¤ì‹œê°„ êµ¬ê¸€ ë‰´ìŠ¤ íŠ¸ë Œë“œ"
        if extra:
            return f"{base} Â· {extra[:20]}"
        return base
    if source_type == "solar":
        return f"{tag} Â· ì ˆê¸° ê±´ê°• ì´ìŠˆ"
    template = _REASON_MAP.get(tag, "{month}ì›” ì‹œì¦Œ Â· ê±´ê°• ì½˜í…ì¸ ")
    return template.format(month=month)


def _fetch_news_fast() -> list[dict]:
    """RSS í—¤ë“œë¼ì¸ë§Œ ë¹ ë¥´ê²Œ ê°€ì ¸ì™€ í‚¤ì›Œë“œ ë§¤ì¹­ìœ¼ë¡œ ì£¼ì œ í›„ë³´ ìƒì„± (LLM ë¶ˆí•„ìš”)

    - 30ë¶„ ìºì‹œ ì¬ì‚¬ìš©
    - ì‹¤íŒ¨ ì‹œ ë¹ˆ ë¦¬ìŠ¤íŠ¸ ë°˜í™˜ (íë ˆì´ì…˜ ì£¼ì œì— ì˜í–¥ ì—†ìŒ)
    """
    global _news_cache
    now_ts = time.time()

    # ìºì‹œ ìœ íš¨í•˜ë©´ ê¸°ì¡´ ë°ì´í„° ì‚¬ìš©
    if _news_cache.get("fast_topics") and (now_ts - _news_cache["timestamp"]) < _NEWS_CACHE_TTL:
        return _news_cache["fast_topics"]

    month = datetime.now().month
    results = []
    all_headlines: dict[str, list[str]] = {}

    for feed in _NEWS_FEEDS:
        try:
            headlines = _fetch_rss_headlines(feed["url"], max_items=8)
        except Exception:
            continue
        if not headlines:
            continue
        all_headlines[feed["tag"]] = headlines

        # í‚¤ì›Œë“œ ë§¤ì¹­ìœ¼ë¡œ ìƒìœ„ 2ê°œ ì„ ë³„ (LLM ì—†ì´)
        picked = 0
        for h in headlines:
            if picked >= 2:
                break
            # 30ì ì´ë‚´ë¡œ ì •ë¦¬
            short = h[:35].rstrip() + ("..." if len(h) > 35 else "")
            results.append({
                "label": f"ğŸ“° {short}",
                "topic": h[:50],
                "tag": feed["tag"],
                "product": "ì—†ìŒ",
                "source_type": "news",
                "news_ref": h[:25],
            })
            picked += 1

    # ìºì‹œ ì—…ë°ì´íŠ¸ (í—¤ë“œë¼ì¸ë„ ì €ì¥ â€” ì—ì´ì „íŠ¸ ì»¨í…ìŠ¤íŠ¸ìš©)
    _news_cache["fast_topics"] = results
    if all_headlines:
        _news_cache["headlines"] = all_headlines
    _news_cache["timestamp"] = now_ts

    return results


_HEALTH_KEYWORDS = [
    "ê±´ê°•", "ì˜ë£Œ", "ì•½", "ë³‘ì›", "ìš´ë™", "ë‹¤ì´ì–´íŠ¸", "ì˜ì–‘", "ìˆ˜ë©´",
    "ë©´ì—­", "í”¼ë¶€", "ë¹„íƒ€ë¯¼", "ìŠ¤íŠ¸ë ˆìŠ¤", "ì²´ì¤‘", "í˜ˆì••", "ë‹¹ë‡¨",
    "ê°ê¸°", "ë…ê°", "ì½”ë¡œë‚˜", "ë°±ì‹ ", "ì¹˜ë£Œ", "ì§ˆë³‘", "ì‹í’ˆ",
    "ì•Œë ˆë¥´ê¸°", "ì¼êµì°¨", "í—¬ìŠ¤", "ìš”ê°€", "í•„ë¼í…ŒìŠ¤", "í•œì˜",
    "ë³´ì•½", "ê³µì§„ë‹¨", "ê²½ì˜¥ê³ ", "ë…¹ìš©", "í•œì•½", "ë³´ì–‘", "ë©´ì—­ë ¥",
    "í”¼ë¡œ", "ìˆ˜ë©´ì§ˆ", "ë…¸í™”", "ì½œë ˆìŠ¤í…Œë¡¤", "í˜ˆë‹¹", "ê´€ì ˆ",
]

# â”€â”€ íŠ¸ë Œë“œ í‚¤ì›Œë“œ â†’ ê±´ê°• ì£¼ì œ ë³€í™˜ ìºì‹œ â”€â”€
_trend_convert_cache: dict = {}


def _convert_trends_to_health(keywords: list[str]) -> dict[str, str]:
    """íŠ¸ë Œë“œ í‚¤ì›Œë“œ ë¦¬ìŠ¤íŠ¸ë¥¼ ê±´ê°•/ì›°ë¹™ ê´€ì ì˜ ì¹´ë“œë‰´ìŠ¤ ì£¼ì œë¡œ ë³€í™˜ (LLM ë°°ì¹˜ í˜¸ì¶œ).

    Returns: {ì›ë³¸ í‚¤ì›Œë“œ: ë³€í™˜ëœ ì£¼ì œ} ë§¤í•‘
    """
    global _trend_convert_cache
    # ì´ë¯¸ ë³€í™˜ëœ ê²ƒ ì œì™¸
    to_convert = [kw for kw in keywords if kw not in _trend_convert_cache]
    if not to_convert:
        return {kw: _trend_convert_cache[kw] for kw in keywords if kw in _trend_convert_cache}

    system = """ë‹¹ì‹ ì€ ì¸ìŠ¤íƒ€ê·¸ë¨ ê±´ê°• ì¹´ë“œë‰´ìŠ¤ í¸ì§‘ìì…ë‹ˆë‹¤.
ì‹¤ì‹œê°„ íŠ¸ë Œë“œ í‚¤ì›Œë“œë¥¼ ë°›ì•„, ê° í‚¤ì›Œë“œì™€ ì—°ê²°ë˜ëŠ” ê±´ê°•/ì›°ë¹™ ì¹´ë“œë‰´ìŠ¤ ì£¼ì œë¥¼ ë§Œë“¤ì–´ì£¼ì„¸ìš”.

## ê·œì¹™
- íŠ¸ë Œë“œ í‚¤ì›Œë“œì˜ ë§¥ë½ì„ ì‚´ë ¤ ìì—°ìŠ¤ëŸ½ê²Œ ê±´ê°• ì£¼ì œë¡œ ì—°ê²°
- ì–µì§€ ì—°ê²° ê¸ˆì§€. ìì—°ìŠ¤ëŸ½ê³  í¥ë¯¸ë¡œìš´ ì—°ê²°ì´ì–´ì•¼ í•¨
- 15~30ì ì´ë‚´ì˜ í›„í‚¹ í—¤ë“œë¼ì¸ í˜•íƒœ
- ì§ˆë¬¸í˜• ë˜ëŠ” ìˆ«ì í¬í•¨ ê¶Œì¥
- í•´ìš”ì²´ ê¸ˆì§€ (í—¤ë“œë¼ì¸ì´ë¯€ë¡œ ëª…ì‚¬í˜•/ì²´ì–¸í˜•)
- ë°˜ë“œì‹œ JSONë§Œ ì¶œë ¥: {"í‚¤ì›Œë“œ1": "ë³€í™˜ ì£¼ì œ1", "í‚¤ì›Œë“œ2": "ë³€í™˜ ì£¼ì œ2"}

## ì˜ˆì‹œ
- "í‡´ì‚¬" â†’ "ë²ˆì•„ì›ƒ ì¦í›„êµ°, í•œì˜í•™ì´ ë§í•˜ëŠ” ê¸°ë ¥ íšŒë³µ 3ë‹¨ê³„"
- "ì¸ì²œëŒ€" â†’ "ëŒ€í•™ìƒ ì‹œí—˜ê¸°ê°„, ë‡Œ í”¼ë¡œ í‘¸ëŠ” 5ë¶„ ì§€ì••ë²•"
- "ë´„ë™ë¹„ë¹”ë°¥" â†’ "ë´„ë™ì˜ ìˆ¨ì€ ì˜ì–‘ì†Œ, ê°„ í•´ë…ì— ì¢‹ì€ ì´ìœ "
- "ìœ„ë²„ìŠ¤ì½˜" â†’ "ì½˜ì„œíŠ¸ í›„ ì„±ëŒ€ ê´€ë¦¬ë²•, ëª© ë³´í˜¸í•˜ëŠ” 3ê°€ì§€ ìŠµê´€"
- "ê°œì¸ì´ë™" â†’ "ì¶œí‡´ê·¼ ê±·ê¸° vs ìì „ê±°, ì¹¼ë¡œë¦¬ ì†Œëª¨ ë¹„êµ"
"""
    user = f"ë‹¤ìŒ íŠ¸ë Œë“œ í‚¤ì›Œë“œë“¤ì„ ê±´ê°• ì£¼ì œë¡œ ë³€í™˜í•´ì£¼ì„¸ìš”:\n{json.dumps(to_convert, ensure_ascii=False)}"

    raw = _call_llm(system, user, temperature=0.7, max_tokens=1000)
    if raw:
        try:
            match = re.search(r"\{[\s\S]*\}", raw)
            if match:
                result = json.loads(match.group(0))
                for kw, topic in result.items():
                    # LLM ì¶œë ¥ì—ì„œ ë§ˆí¬ë‹¤ìš´ ê¸°í˜¸ ì œê±°
                    clean = topic.replace("**", "").replace("*", "").replace("__", "").strip()
                    _trend_convert_cache[kw] = clean
        except (json.JSONDecodeError, AttributeError):
            logger.warning("íŠ¸ë Œë“œâ†’ê±´ê°• ì£¼ì œ ë³€í™˜ íŒŒì‹± ì‹¤íŒ¨")

    # ë³€í™˜ ì‹¤íŒ¨í•œ ê²ƒì€ ê¸°ë³¸ íŒ¨í„´ ì ìš©
    for kw in to_convert:
        if kw not in _trend_convert_cache:
            _trend_convert_cache[kw] = f"{kw}, ê±´ê°•ê³¼ì˜ ì˜ì™¸ì˜ ì—°ê²°ê³ ë¦¬"

    return {kw: _trend_convert_cache[kw] for kw in keywords if kw in _trend_convert_cache}


def _fetch_naver_trends() -> list[dict]:
    """ë„¤ì´ë²„ ì‹¤ì‹œê°„ ê²€ìƒ‰ íŠ¸ë Œë“œ (signal.bz API, ì¸ì¦ ë¶ˆí•„ìš”)

    Returns: [{"keyword": str, "rank": int, "state": str}, ...]
    """
    global _news_cache
    now_ts = time.time()

    cached = _news_cache.get("naver_trends")
    if cached and (now_ts - _news_cache.get("ntrend_ts", 0)) < _NEWS_CACHE_TTL:
        return cached

    try:
        resp = _requests.get(
            "https://api.signal.bz/news/realtime",
            timeout=10,
            headers={"User-Agent": "Mozilla/5.0"},
        )
        resp.raise_for_status()
        data = resp.json()
        results = []
        for item in data.get("top10", []):
            kw = item.get("keyword", "").strip()
            if not kw:
                continue
            is_health = any(h in kw for h in _HEALTH_KEYWORDS)
            results.append({
                "keyword": kw,
                "rank": item.get("rank", 0),
                "state": item.get("state", ""),
                "is_health": is_health,
            })
        _news_cache["naver_trends"] = results
        _news_cache["ntrend_ts"] = now_ts
        return results
    except Exception as e:
        logger.warning(f"ë„¤ì´ë²„ íŠ¸ë Œë“œ(signal.bz) ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: {e}")
        return _news_cache.get("naver_trends", [])


def _fetch_google_trends() -> list[dict]:
    """êµ¬ê¸€ íŠ¸ë Œë“œ RSSì—ì„œ í•œêµ­ ì‹¤ì‹œê°„ ì¸ê¸° ê²€ìƒ‰ì–´ ê°€ì ¸ì˜¤ê¸° (ì¸ì¦ ë¶ˆí•„ìš”)"""
    global _news_cache
    now_ts = time.time()

    cached = _news_cache.get("google_trends")
    if cached and (now_ts - _news_cache.get("gtrend_ts", 0)) < _NEWS_CACHE_TTL:
        return cached

    try:
        url = "https://trends.google.com/trending/rss?geo=KR"
        ns = {"ht": "https://trends.google.com/trending/rss"}
        resp = _requests.get(url, timeout=10, headers={"User-Agent": "Mozilla/5.0"})
        resp.raise_for_status()
        root = ET.fromstring(resp.content)

        results = []
        for item in root.findall(".//item"):
            title_el = item.find("title")
            title = title_el.text if title_el is not None else ""
            if not title:
                continue

            traffic_el = item.find("ht:approx_traffic", ns)
            traffic = traffic_el.text if traffic_el is not None else ""

            # ê´€ë ¨ ë‰´ìŠ¤ ì œëª© ìˆ˜ì§‘
            news_texts = []
            for ni in item.findall("ht:news_item", ns):
                ni_title = ni.find("ht:news_item_title", ns)
                if ni_title is not None and ni_title.text:
                    news_texts.append(ni_title.text)

            # ê±´ê°• í‚¤ì›Œë“œ ë§¤ì¹­ (ì œëª© + ë‰´ìŠ¤ ì „ì²´)
            all_text = title + " " + " ".join(news_texts)
            is_health = any(kw in all_text for kw in _HEALTH_KEYWORDS)

            results.append({
                "keyword": title,
                "traffic": traffic,
                "is_health": is_health,
                "news_ref": news_texts[0][:25] if news_texts else "",
            })

        _news_cache["google_trends"] = results
        _news_cache["gtrend_ts"] = now_ts
        return results
    except Exception as e:
        logger.warning(f"êµ¬ê¸€ íŠ¸ë Œë“œ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: {e}")
        return _news_cache.get("google_trends", [])


def _fetch_x_trends() -> list[str]:
    """X(íŠ¸ìœ„í„°) í•œêµ­ ì‹¤ì‹œê°„ íŠ¸ë Œë“œ ê°€ì ¸ì˜¤ê¸° (trends24.in ìŠ¤í¬ë˜í•‘, ì¸ì¦ ë¶ˆí•„ìš”)"""
    global _news_cache
    now_ts = time.time()

    cached = _news_cache.get("x_trends")
    if cached and (now_ts - _news_cache.get("xtrend_ts", 0)) < _NEWS_CACHE_TTL:
        return cached

    try:
        url = "https://trends24.in/korea/"
        resp = _requests.get(url, timeout=10, headers={
            "User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) "
                          "AppleWebKit/537.36 (KHTML, like Gecko) "
                          "Chrome/120.0.0.0 Safari/537.36",
        })
        resp.raise_for_status()
        resp.encoding = "utf-8"
        raw = re.findall(r"<li[^>]*>\s*<a[^>]*>([^<]+)</a>", resp.text)

        seen = set()
        trends = []
        for t in raw:
            t = t.strip()
            if t and t not in seen and len(t) > 1:
                seen.add(t)
                trends.append(t)

        trends = trends[:30]
        _news_cache["x_trends"] = trends
        _news_cache["xtrend_ts"] = now_ts
        return trends
    except Exception as e:
        logger.warning(f"X íŠ¸ë Œë“œ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: {e}")
        return _news_cache.get("x_trends", [])


def suggest_topics(include_news: bool = True, refresh_seed: int = 0) -> list[dict]:
    """í˜„ì¬ ì‹œì¦Œ/ì ˆê¸°/íŠ¸ë Œë“œ + ì›”ë³„ ì´ë²¤íŠ¸ + ë‰´ìŠ¤ ê¸°ë°˜ ì£¼ì œ ì¶”ì²œ

    Args:
        include_news: ë‰´ìŠ¤/íŠ¸ë Œë“œ ìë™ ë¡œë“œ
        refresh_seed: ìƒˆë¡œê³ ì¹¨ ì‹œ ë‹¬ë¼ì§€ëŠ” ì‹œë“œê°’ (0ì´ë©´ ì‹œê°„ ê¸°ë°˜)
    Returns: score ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬ëœ ì¶”ì²œ ì£¼ì œ ë¦¬ìŠ¤íŠ¸
    """
    season = detect_season()
    now = datetime.now()
    month = now.month
    suggestions = []

    import random
    # ìƒˆë¡œê³ ì¹¨í•  ë•Œë§ˆë‹¤ ë‹¤ë¥¸ íë ˆì´ì…˜ ì£¼ì œê°€ ë‚˜ì˜¤ë„ë¡ ì‹œë“œ ë³€ê²½
    seed = f"{now.strftime('%Y-%m-%d-%H')}-{refresh_seed}"
    rng = random.Random(seed)

    # 1) ì›”ë³„ ì´ë²¤íŠ¸/íŠ¸ë Œë“œ ì£¼ì œ (ìµœìš°ì„ ) â€” í™•ì¥ëœ í’€ì—ì„œ 4ê°œ ìƒ˜í”Œ
    monthly = list(_MONTHLY_EVENTS.get(month, []))
    if now.day >= 20:
        next_month = (month % 12) + 1
        monthly = monthly + list(_MONTHLY_EVENTS.get(next_month, []))
    for evt in rng.sample(monthly, min(4, len(monthly))):
        suggestions.append({
            "topic": evt["topic"],
            "tag": evt["tag"],
            "product": evt.get("product", "ì—†ìŒ"),
            "source_type": "monthly",
        })

    # 2) ì ˆê¸° íŠ¹í™” ì£¼ì œ
    solar = season.get("solar_term")
    if solar and solar in _SOLAR_TERM_TOPICS:
        suggestions.append({
            "topic": _SOLAR_TERM_TOPICS[solar],
            "tag": f"ì ˆê¸°({solar})",
            "product": "ì—†ìŒ",
            "source_type": "solar",
        })

    # 3) ì‹œì¦Œ ì£¼ì œ 3ê°œ â€” í™•ì¥ëœ í’€ì—ì„œ ë‹¤ì–‘í•˜ê²Œ
    season_pool = _SEASONAL_TOPICS.get(season["season"], [])
    for t in rng.sample(season_pool, min(3, len(season_pool))):
        suggestions.append({
            "topic": t,
            "tag": season["season_kr"],
            "product": "ì—†ìŒ",
            "source_type": "season",
        })

    # 4) íŠ¸ë Œë“œ/íŒì»¬ì³ ì£¼ì œ 3ê°œ â€” í™•ì¥ëœ í’€ì—ì„œ ë‹¤ì–‘í•˜ê²Œ
    for t in rng.sample(_TRENDING_TOPICS, min(3, len(_TRENDING_TOPICS))):
        suggestions.append({
            "topic": t,
            "tag": "íŠ¸ë Œë“œ",
            "product": "ì—†ìŒ",
            "source_type": "trend",
        })

    # 5) ì‹¤ì‹œê°„ ë‰´ìŠ¤ (ìë™ ë¡œë“œ)
    if include_news:
        news = _fetch_news_fast()
        suggestions += news

    # 6) êµ¬ê¸€ ê²€ìƒ‰ íŠ¸ë Œë“œ + 7) X íŠ¸ë Œë“œ + 8) ë„¤ì´ë²„ íŠ¸ë Œë“œ â€” ì¼ë°˜ í‚¤ì›Œë“œëŠ” ê±´ê°• ì£¼ì œë¡œ ë³€í™˜
    all_general_kw = []  # ë³€í™˜ ëŒ€ìƒ ìˆ˜ì§‘
    _g_health_items, _g_general_items = [], []
    _x_health_items, _x_general_items = [], []
    _n_health_items, _n_general_items = [], []

    if include_news:
        gtrends = _fetch_google_trends()
        _g_health_items = [gt for gt in gtrends if gt.get("is_health")]
        _g_general_items = [gt for gt in gtrends if not gt.get("is_health")][:3]
        all_general_kw += [gt["keyword"] for gt in _g_general_items]

        x_trends = _fetch_x_trends()
        _x_health_items = [t for t in x_trends if any(kw in t for kw in _HEALTH_KEYWORDS)]
        _x_general_items = [t for t in x_trends if not any(kw in t for kw in _HEALTH_KEYWORDS)][:2]
        all_general_kw += _x_general_items

        naver_trends = _fetch_naver_trends()
        _n_health_items = [nt for nt in naver_trends if nt.get("is_health")]
        _n_general_items = [nt for nt in naver_trends if not nt.get("is_health")][:5]
        all_general_kw += [nt["keyword"] for nt in _n_general_items]

    # ì¼ë°˜ íŠ¸ë Œë“œ í‚¤ì›Œë“œë¥¼ LLMìœ¼ë¡œ ê±´ê°• ì£¼ì œ ë³€í™˜ (ë°°ì¹˜ 1íšŒ í˜¸ì¶œ)
    converted = {}
    if all_general_kw:
        converted = _convert_trends_to_health(all_general_kw)

    if include_news:
        # êµ¬ê¸€ íŠ¸ë Œë“œ â€” ê±´ê°• ê´€ë ¨
        for gt in _g_health_items:
            suggestions.append({
                "topic": gt["keyword"],
                "tag": "êµ¬ê¸€íŠ¸ë Œë“œ",
                "product": "ì—†ìŒ",
                "source_type": "google_trend",
                "news_ref": gt.get("news_ref", ""),
            })
        # êµ¬ê¸€ íŠ¸ë Œë“œ â€” ì¼ë°˜ â†’ ê±´ê°• ë³€í™˜
        for gt in _g_general_items:
            suggestions.append({
                "topic": converted.get(gt["keyword"], gt["keyword"]),
                "tag": "êµ¬ê¸€íŠ¸ë Œë“œ",
                "product": "ì—†ìŒ",
                "source_type": "google_trend_general",
                "news_ref": f"ğŸ” {gt['keyword']}",
            })
        # X íŠ¸ë Œë“œ â€” ê±´ê°• ê´€ë ¨
        for t in _x_health_items[:3]:
            suggestions.append({
                "topic": t,
                "tag": "XíŠ¸ë Œë“œ",
                "product": "ì—†ìŒ",
                "source_type": "x_trend",
            })
        # X íŠ¸ë Œë“œ â€” ì¼ë°˜ â†’ ê±´ê°• ë³€í™˜
        for t in _x_general_items:
            suggestions.append({
                "topic": converted.get(t, t),
                "tag": "XíŠ¸ë Œë“œ",
                "product": "ì—†ìŒ",
                "source_type": "x_trend",
                "news_ref": f"ğ• {t}",
            })
        # ë„¤ì´ë²„ íŠ¸ë Œë“œ â€” ê±´ê°• ê´€ë ¨
        for nt in _n_health_items[:3]:
            suggestions.append({
                "topic": nt["keyword"],
                "tag": "ë„¤ì´ë²„íŠ¸ë Œë“œ",
                "product": "ì—†ìŒ",
                "source_type": "naver_trend",
                "news_ref": f"#{nt.get('rank', '')}ìœ„",
            })
        # ë„¤ì´ë²„ íŠ¸ë Œë“œ â€” ì¼ë°˜ â†’ ê±´ê°• ë³€í™˜
        for nt in _n_general_items:
            suggestions.append({
                "topic": converted.get(nt["keyword"], nt["keyword"]),
                "tag": "ë„¤ì´ë²„íŠ¸ë Œë“œ",
                "product": "ì—†ìŒ",
                "source_type": "naver_trend_general",
                "news_ref": f"ğŸ…½ {nt['keyword']}",
            })

    # â”€â”€ ì ìˆ˜ + ì‚¬ìœ  ê³„ì‚° í›„ ì •ë ¬ â”€â”€
    tag_emoji = {
        "íŠ¸ë Œë“œ": "ğŸ”¥", "ê±´ê°•ë‰´ìŠ¤": "ğŸ“°", "ì—°ì˜ˆë‰´ìŠ¤": "ğŸ¬", "ìƒí™œë‰´ìŠ¤": "ğŸ ",
        "êµ¬ê¸€íŠ¸ë Œë“œ": "ğŸ”", "XíŠ¸ë Œë“œ": "ğ•", "ë„¤ì´ë²„íŠ¸ë Œë“œ": "ğŸ…½",
    }
    for sug in suggestions:
        src = sug.get("source_type", "trend")
        product = sug.get("product", "ì—†ìŒ")
        sug["score"] = _calc_topic_score(sug["topic"], sug["tag"], product, src)
        sug["reason"] = _build_reason(sug["tag"], src, month, sug.get("news_ref", ""))
        # label ìƒì„±
        emoji = tag_emoji.get(sug["tag"], "ğŸ“…" if src == "monthly" else "ğŸ—“ï¸" if src == "solar" else "ğŸŒ¿")
        short_topic = sug["topic"][:30] + ("..." if len(sug["topic"]) > 30 else "")
        sug["label"] = f"{emoji} {short_topic}"

    suggestions.sort(key=lambda x: x["score"], reverse=True)

    # ë„¤ì´ë²„/êµ¬ê¸€/X íŠ¸ë Œë“œ ìµœì†Œ ë³´ì¥: ìƒìœ„ 20ê°œì— ê° ì†ŒìŠ¤ê°€ ê³¨ê³ ë£¨ í¬í•¨ë˜ë„ë¡
    result = []
    remainder = []
    naver_count = 0
    for sug in suggestions:
        src = sug.get("source_type", "")
        is_naver = src in ("naver_trend", "naver_trend_general")
        if is_naver:
            naver_count += 1
        if len(result) < 20:
            result.append(sug)
        else:
            remainder.append(sug)

    # ë„¤ì´ë²„ íŠ¸ë Œë“œê°€ ê²°ê³¼ì— 3ê°œ ë¯¸ë§Œì´ë©´, í•˜ìœ„ í•­ëª©ì„ ë„¤ì´ë²„ë¡œ êµì²´
    if naver_count < 3:
        naver_in_remainder = [s for s in remainder
                              if s.get("source_type", "") in ("naver_trend", "naver_trend_general")]
        for nv in naver_in_remainder:
            if naver_count >= 3:
                break
            # ê²°ê³¼ì˜ ë§ˆì§€ë§‰(ê°€ì¥ ë‚®ì€ ì ìˆ˜) ë¹„ë„¤ì´ë²„ í•­ëª©ê³¼ êµì²´
            for i in range(len(result) - 1, -1, -1):
                if result[i].get("source_type", "") not in ("naver_trend", "naver_trend_general"):
                    result[i] = nv
                    naver_count += 1
                    break

    return result[:20]


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ì‹¤ì‹œê°„ ë‰´ìŠ¤ íŠ¸ë Œë“œ (ê±´ê°•/ì—°ì˜ˆ ë‰´ìŠ¤ RSS)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# ëª¨ë“ˆ ë ˆë²¨ ìºì‹œ (Streamlit ë¦¬ëŸ°ë§ˆë‹¤ ì¬í˜¸ì¶œ ë°©ì§€)
_news_cache: dict = {"data": [], "headlines": {}, "timestamp": 0.0}
_NEWS_CACHE_TTL = 600  # 10ë¶„

_NEWS_FEEDS = [
    {
        "name": "ê±´ê°•",
        "url": "https://news.google.com/rss/search?q=%EA%B1%B4%EA%B0%95+%EC%98%81%EC%96%91+%EC%88%98%EB%A9%B4+%EB%A9%B4%EC%97%AD&hl=ko&gl=KR&ceid=KR:ko",
        "tag": "ê±´ê°•ë‰´ìŠ¤",
        "emoji": "ğŸ’Š",
    },
    {
        "name": "ì—°ì˜ˆ",
        "url": "https://news.google.com/rss/search?q=%EC%97%B0%EC%98%88%EC%9D%B8+%EB%8B%A4%EC%9D%B4%EC%96%B4%ED%8A%B8+%EB%B7%B0%ED%8B%B0+%ED%94%BC%EB%B6%80&hl=ko&gl=KR&ceid=KR:ko",
        "tag": "ì—°ì˜ˆë‰´ìŠ¤",
        "emoji": "ğŸ¬",
    },
    {
        "name": "ìƒí™œ",
        "url": "https://news.google.com/rss/search?q=%EC%83%9D%ED%99%9C+%EA%B1%B4%EA%B0%95+%EC%8B%9D%ED%92%88+%EC%9A%B4%EB%8F%99+%EC%8A%B5%EA%B4%80&hl=ko&gl=KR&ceid=KR:ko",
        "tag": "ìƒí™œë‰´ìŠ¤",
        "emoji": "ğŸ ",
    },
]


def _fetch_rss_headlines(url: str, max_items: int = 10) -> list[str]:
    """Google News RSSì—ì„œ í—¤ë“œë¼ì¸ ì¶”ì¶œ"""
    try:
        resp = _requests.get(url, timeout=10, headers={"User-Agent": "Mozilla/5.0"})
        resp.raise_for_status()
        root = ET.fromstring(resp.content)
        titles = []
        for item in root.iter("item"):
            title_el = item.find("title")
            if title_el is not None and title_el.text:
                # Google News ì œëª©ì—ì„œ " - ë§¤ì²´ëª…" ì œê±°
                t = re.sub(r"\s*-\s*[^-]+$", "", title_el.text).strip()
                if t and len(t) > 5:
                    titles.append(t)
            if len(titles) >= max_items:
                break
        return titles
    except Exception as e:
        logger.warning(f"RSS í”¼ë“œ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨ ({url[:50]}...): {e}")
        return []


_NEWS_TRANSFORM_SYSTEM = """ë‹¹ì‹ ì€ ê±´ê°• ë¸Œëœë“œ 'ìˆ˜(thesoo)'ì˜ ì½˜í…ì¸  ê¸°íšìì…ë‹ˆë‹¤.
ì•„ë˜ ë‰´ìŠ¤ í—¤ë“œë¼ì¸ë“¤ì„ ë³´ê³ , ê±´ê°•/ì—°ì˜ˆ/ìƒí™œ ì¹´ë“œë‰´ìŠ¤ë¡œ ì¬í•´ì„í•  ìˆ˜ ìˆëŠ” ì£¼ì œ 3ê°œë¥¼ ì¶”ì²œí•˜ì„¸ìš”.

## ê·œì¹™
1. ë‰´ìŠ¤ ì† ê±´ê°•Â·ë·°í‹°Â·ë¼ì´í”„ìŠ¤íƒ€ì¼ ì´ìŠˆë¥¼ ì¹´ë“œë‰´ìŠ¤ ì£¼ì œë¡œ ë³€í™˜
2. ì—°ì˜ˆì¸ ì´ë¦„ì€ ì§ì ‘ ì–¸ê¸‰í•˜ì§€ ë§ê³ , í˜„ìƒ/íŠ¸ë Œë“œë¡œ ë³€í™˜
   ì˜ˆ: "â—‹â—‹ ë‹¤ì´ì–´íŠ¸ ë¹„ë²•" â†’ "ì…€ëŸ½ë“¤ ì‚¬ì´ ìœ í–‰í•˜ëŠ” ê°„í—ì  ë‹¨ì‹, ì§„ì§œ íš¨ê³¼ëŠ”?"
3. ê²€ì¦ ë¶ˆê°€ëŠ¥í•œ ì£¼ì¥ ê¸ˆì§€ â€” ë‰´ìŠ¤ ì‚¬ì‹¤ë§Œ í™œìš©
4. ê° ì£¼ì œëŠ” 20~40ì, í˜¸ê¸°ì‹¬ ìœ ë°œí•˜ëŠ” í†¤
5. ê´€ë ¨ ì—†ëŠ” ë‰´ìŠ¤ëŠ” ë¬´ì‹œ

## ì¶œë ¥ (ë°˜ë“œì‹œ JSON ë°°ì—´ë§Œ, ë‹¤ë¥¸ í…ìŠ¤íŠ¸ ì—†ì´)
```json
[
  {"topic": "ì£¼ì œ í…ìŠ¤íŠ¸", "news_ref": "ì°¸ê³ í•œ ë‰´ìŠ¤ í‚¤ì›Œë“œ 5~10ì"},
  ...
]
```"""


def _transform_headlines_to_topics(headlines: list[str], feed_name: str) -> list[dict]:
    """ë‰´ìŠ¤ í—¤ë“œë¼ì¸ â†’ ì¹´ë“œë‰´ìŠ¤ ì£¼ì œ íŒíŠ¸ë¡œ ë³€í™˜

    1ì°¨: LLM ë³€í™˜ ì‹œë„
    2ì°¨: LLM ì‹¤íŒ¨ ì‹œ í—¤ë“œë¼ì¸ì—ì„œ ì§ì ‘ ì¶”ì¶œ (LLM-free í´ë°±)
    """
    if not headlines:
        return []

    # LLM ë³€í™˜ ì‹œë„
    user_prompt = f"[{feed_name} ë‰´ìŠ¤ í—¤ë“œë¼ì¸]\n" + "\n".join(
        f"- {h}" for h in headlines
    )
    raw = _call_llm(_NEWS_TRANSFORM_SYSTEM, user_prompt, temperature=0.5, max_tokens=500)
    if raw:
        parsed = _parse_ideas_json(raw, limit=3)
        if parsed:
            return parsed

    # LLM ì‹¤íŒ¨ â†’ í—¤ë“œë¼ì¸ì—ì„œ ì§ì ‘ ì¶”ì¶œ (ì§§ê²Œ ë‹¤ë“¬ê¸°)
    logger.info(f"LLM ë³€í™˜ ì‹¤íŒ¨, {feed_name} í—¤ë“œë¼ì¸ ì§ì ‘ ì‚¬ìš©")
    results = []
    for h in headlines[:3]:
        # 30ì ì´ë‚´ë¡œ ìë¥´ê¸°
        topic = h[:30].rstrip() + ("..." if len(h) > 30 else "")
        results.append({"topic": topic, "news_ref": h[:15]})
    return results


def fetch_news_topics(force_refresh: bool = False) -> list[dict]:
    """ì‹¤ì‹œê°„ ë‰´ìŠ¤ ê¸°ë°˜ íŠ¸ë Œë“œ ì£¼ì œ ë°˜í™˜ (30ë¶„ ìºì‹œ)

    Returns: [{"label": str, "topic": str, "tag": str, "news_ref": str}, ...]
    """
    global _news_cache

    now = time.time()
    if (
        not force_refresh
        and _news_cache["data"]
        and (now - _news_cache["timestamp"]) < _NEWS_CACHE_TTL
    ):
        return _news_cache["data"]

    all_topics: list[dict] = []
    all_headlines: dict[str, list[str]] = {}

    for feed in _NEWS_FEEDS:
        headlines = _fetch_rss_headlines(feed["url"])
        if not headlines:
            continue

        # ì›ë³¸ í—¤ë“œë¼ì¸ ì €ì¥ (ì—ì´ì „íŠ¸ì— ì»¨í…ìŠ¤íŠ¸ë¡œ ì „ë‹¬ìš©)
        all_headlines[feed["tag"]] = headlines

        transformed = _transform_headlines_to_topics(headlines, feed["name"])
        time.sleep(2)  # Groq rate limit ë°©ì§€
        for item in transformed:
            topic_text = item.get("topic", "")
            if topic_text:
                all_topics.append({
                    "label": f"{feed['emoji']} {topic_text}",
                    "topic": topic_text,
                    "tag": feed["tag"],
                    "news_ref": item.get("news_ref", ""),
                })

    _news_cache = {"data": all_topics, "headlines": all_headlines, "timestamp": now}
    return all_topics


def get_news_context(tag: str = "") -> str:
    """ìºì‹œëœ ë‰´ìŠ¤ í—¤ë“œë¼ì¸ì„ ì—ì´ì „íŠ¸ ì»¨í…ìŠ¤íŠ¸ ë¬¸ìì—´ë¡œ ë°˜í™˜

    Args:
        tag: íŠ¹ì • í”¼ë“œ íƒœê·¸ (ë¹ˆ ë¬¸ìì—´ì´ë©´ ì „ì²´)
    """
    headlines = _news_cache.get("headlines", {})
    if not headlines:
        return ""

    parts = ["## ì°¸ê³  ë‰´ìŠ¤ ê¸°ì‚¬ (ì´ ë‰´ìŠ¤ íŠ¸ë Œë“œë¥¼ ë°˜ë“œì‹œ ë°˜ì˜í•˜ì„¸ìš”!)"]
    parts.append("ì•„ë˜ ì‹¤ì œ ë‰´ìŠ¤ í—¤ë“œë¼ì¸ì„ ì°¸ê³ í•˜ì—¬, ë‰´ìŠ¤ ì´ìŠˆë¥¼ ê±´ê°• ì½˜í…ì¸ ë¡œ ì—°ê²°í•œ ì•„ì´ë””ì–´ë¥¼ ë§Œë“œì„¸ìš”.")
    parts.append("ì—°ì˜ˆì¸ ì´ë¦„ì€ ì§ì ‘ ì‚¬ìš©í•˜ì§€ ë§ê³  í˜„ìƒ/íŠ¸ë Œë“œë¡œ ë³€í™˜í•˜ì„¸ìš”.\n")

    feed_labels = {"ê±´ê°•ë‰´ìŠ¤": "ê±´ê°• ê¸°ì‚¬", "ì—°ì˜ˆë‰´ìŠ¤": "ì—°ì˜ˆ ê¸°ì‚¬", "ìƒí™œë‰´ìŠ¤": "ìƒí™œ ê¸°ì‚¬"}
    for feed_tag, feed_headlines in headlines.items():
        if tag and feed_tag != tag:
            continue
        label = feed_labels.get(feed_tag, feed_tag)
        parts.append(f"### {label}")
        for h in feed_headlines[:8]:
            parts.append(f"- {h}")
        parts.append("")

    return "\n".join(parts)


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# íˆìŠ¤í† ë¦¬ ê´€ë¦¬
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def load_history():
    """íˆìŠ¤í† ë¦¬ íŒŒì¼ ë¡œë“œ"""
    if not HISTORY_FILE.exists():
        return {"selected_ideas": []}
    try:
        with open(HISTORY_FILE, "r", encoding="utf-8") as f:
            return json.load(f)
    except Exception:
        return {"selected_ideas": []}


def save_history(idea: dict):
    """ì„ ì • ì•„ì´ë””ì–´ë¥¼ íˆìŠ¤í† ë¦¬ì— ì¶”ê°€"""
    history = load_history()
    history["selected_ideas"].append(idea)
    with open(HISTORY_FILE, "w", encoding="utf-8") as f:
        json.dump(history, f, ensure_ascii=False, indent=2)


def _build_blacklist_text(history: dict) -> str:
    """íˆìŠ¤í† ë¦¬ì—ì„œ ì‚¬ìš© ê¸ˆì§€ ì†Œì¬ í…ìŠ¤íŠ¸ ìƒì„±"""
    items = history.get("selected_ideas", [])
    if not items:
        return ""
    lines = ["## ì‚¬ìš© ê¸ˆì§€ ì†Œì¬ (ì´ì „ ì„ ì •ì‘ê³¼ ì¤‘ë³µ ë°©ì§€)", "ë‹¤ìŒ ì†Œì¬/í‚¤ì›Œë“œëŠ” ì´ë¯¸ ì‚¬ìš©ë˜ì—ˆìœ¼ë¯€ë¡œ ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”:"]
    for item in items:
        kws = ", ".join(item.get("keywords", []))
        pattern = item.get("pattern", "")
        lines.append(f"- {item.get('title', '')} ({pattern}) [{kws}]")
    lines.append("ìœ„ ì†Œì¬ì™€ ê²¹ì¹˜ì§€ ì•ŠëŠ” ì™„ì „íˆ ìƒˆë¡œìš´ ì•„ì´ë””ì–´ë¥¼ ì œì•ˆí•˜ì„¸ìš”.")
    return "\n".join(lines)


def check_duplicate(idea: dict, history: dict) -> tuple[bool, str]:
    """ì•„ì´ë””ì–´ê°€ íˆìŠ¤í† ë¦¬ì™€ ì¤‘ë³µì¸ì§€ íŒì •

    Returns: (is_duplicate, reason)
    """
    for past in history.get("selected_ideas", []):
        # ë™ì¼ ì—­ì‚¬ ì¸ë¬¼
        past_kws = set(past.get("keywords", []))
        idea_kws = set(idea.get("keywords", []))
        overlap = past_kws & idea_kws

        # í‚¤ì›Œë“œ 3ê°œ ì´ìƒ ê²¹ì¹¨
        if len(overlap) >= 3:
            return True, f"í‚¤ì›Œë“œ 3ê°œ ì´ìƒ ê²¹ì¹¨: {overlap}"

        # ë™ì¼ ì œí’ˆ + ë™ì¼ íŒ¨í„´
        if (idea.get("product") == past.get("product")
                and idea.get("pattern") == past.get("pattern")):
            return True, f"ë™ì¼ ì œí’ˆ+íŒ¨í„´: {idea.get('product')}+{idea.get('pattern')}"

        # í—¤ë“œë¼ì¸ ìœ ì‚¬ë„ 70% ì´ìƒ
        sim = SequenceMatcher(
            None,
            idea.get("headline", ""),
            past.get("headline", ""),
        ).ratio()
        if sim >= 0.7:
            return True, f"í—¤ë“œë¼ì¸ ìœ ì‚¬ë„ {sim:.0%}"

    return False, ""


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Groq API í˜¸ì¶œ (Llama 3.3 70B)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

_GROQ_MODELS = [
    "llama-3.1-8b-instant",      # rate limit ë†’ìŒ (ê¸°ë³¸)
    "llama-3.3-70b-versatile",   # ê³ í’ˆì§ˆ (í´ë°±)
]

def _call_groq(system_prompt: str, user_prompt: str, temperature=0.7, max_tokens=2000) -> str | None:
    """Groq API í˜¸ì¶œ â†’ í…ìŠ¤íŠ¸ ì‘ë‹µ ë°˜í™˜ (ëª¨ë¸ í´ë°± + ì¬ì‹œë„)"""
    api_key = os.getenv("GROQ_API_KEY")
    if not api_key:
        logger.warning("GROQ_API_KEYê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
        return None

    for model in _GROQ_MODELS:
        result = _call_groq_model(api_key, model, system_prompt, user_prompt, temperature, max_tokens)
        if result:
            return result
        logger.info(f"Groq {model} ì‹¤íŒ¨, ë‹¤ìŒ ëª¨ë¸ ì‹œë„")

    return None


def _call_groq_model(
    api_key: str, model: str, system_prompt: str, user_prompt: str,
    temperature: float, max_tokens: int
) -> str | None:
    """íŠ¹ì • Groq ëª¨ë¸ë¡œ API í˜¸ì¶œ (ì¬ì‹œë„ í¬í•¨)"""
    max_retries = 2
    for attempt in range(max_retries):
        try:
            resp = _requests.post(
                "https://api.groq.com/openai/v1/chat/completions",
                headers={
                    "Authorization": f"Bearer {api_key}",
                    "Content-Type": "application/json",
                },
                json={
                    "model": model,
                    "messages": [
                        {"role": "system", "content": system_prompt},
                        {"role": "user", "content": user_prompt},
                    ],
                    "max_tokens": max_tokens,
                    "temperature": temperature,
                },
                timeout=60,
            )
            if resp.status_code == 429:
                retry_after = resp.headers.get("retry-after", "0")
                try:
                    wait_secs = float(retry_after)
                except ValueError:
                    wait_secs = 5
                # 70BëŠ” 10ì´ˆ, 8BëŠ” 30ì´ˆê¹Œì§€ ëŒ€ê¸° í—ˆìš©
                max_wait = 30 if "8b" in model else 10
                if wait_secs > max_wait:
                    logger.warning(f"Groq {model} rate limit (ëŒ€ê¸° {wait_secs:.0f}ì´ˆ í•„ìš”) â†’ ëª¨ë¸ ì „í™˜")
                    return None
                logger.info(f"Groq {model} 429, {wait_secs:.0f}ì´ˆ ëŒ€ê¸° í›„ ì¬ì‹œë„")
                time.sleep(wait_secs)
                continue

            resp.raise_for_status()
            return resp.json()["choices"][0]["message"]["content"]
        except Exception as e:
            logger.warning(f"Groq {model} í˜¸ì¶œ ì‹¤íŒ¨ (ì‹œë„ {attempt+1}/{max_retries}): {e}")
            if attempt < max_retries - 1:
                time.sleep(1)
                continue
            return None
    return None


def _call_gemini(system_prompt: str, user_prompt: str, temperature=0.7, max_tokens=2000) -> str | None:
    """Google Gemini API í˜¸ì¶œ (1ìˆœìœ„ â€” ë¬´ë£Œ + ê³ í’ˆì§ˆ)"""
    api_key = os.getenv("GEMINI_API_KEY")
    if not api_key:
        return None
    try:
        resp = _requests.post(
            f"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key={api_key}",
            headers={"Content-Type": "application/json"},
            json={
                "systemInstruction": {
                    "parts": [{"text": system_prompt}],
                },
                "contents": [
                    {"role": "user", "parts": [{"text": user_prompt}]},
                ],
                "generationConfig": {
                    "temperature": temperature,
                    "maxOutputTokens": max_tokens,
                },
            },
            timeout=60,
        )
        if resp.status_code == 429:
            logger.warning("Gemini rate limit â†’ Groq ì „í™˜")
            return None
        resp.raise_for_status()
        data = resp.json()
        candidates = data.get("candidates", [])
        if candidates:
            parts = candidates[0].get("content", {}).get("parts", [])
            if parts:
                return parts[0].get("text", "")
        logger.warning(f"Gemini ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨: {data.get('error', 'no candidates')}")
        return None
    except Exception as e:
        logger.warning(f"Gemini API í˜¸ì¶œ ì‹¤íŒ¨: {e}")
        return None


def _call_anthropic(system_prompt: str, user_prompt: str, max_tokens=2000) -> str | None:
    """Anthropic Claude API í˜¸ì¶œ (3ìˆœìœ„ í´ë°±)"""
    try:
        import anthropic
    except ImportError:
        return None
    api_key = os.getenv("ANTHROPIC_API_KEY")
    if not api_key:
        return None
    try:
        client = anthropic.Anthropic(api_key=api_key)
        response = client.messages.create(
            model="claude-sonnet-4-20250514",
            max_tokens=max_tokens,
            system=system_prompt,
            messages=[{"role": "user", "content": user_prompt}],
        )
        return response.content[0].text
    except Exception as e:
        logger.warning(f"Claude API í˜¸ì¶œ ì‹¤íŒ¨: {e}")
        return None


def _call_llm(system_prompt: str, user_prompt: str, temperature=0.7, max_tokens=2000) -> str | None:
    """Gemini â†’ Groq â†’ Anthropic í´ë°± ì²´ì¸"""
    result = _call_gemini(system_prompt, user_prompt, temperature, max_tokens)
    if result:
        return result
    result = _call_groq(system_prompt, user_prompt, temperature, max_tokens)
    if result:
        return result
    return _call_anthropic(system_prompt, user_prompt, max_tokens)


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ì—ì´ì „íŠ¸ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

_AGENT_SYSTEM = """ë‹¹ì‹ ì€ '{agent_name}'ì…ë‹ˆë‹¤.

## ì„ë¬´
{domain} ë¶„ì•¼ì—ì„œ ë¼ì´í”„ìŠ¤íƒ€ì¼Â·ê±´ê°• ë¸Œëœë“œ 'ìˆ˜(thesoo)'ì˜ Instagram ì¹´ë“œë‰´ìŠ¤ ì•„ì´ë””ì–´ 2ê°œë¥¼ ì œì•ˆí•˜ì„¸ìš”.

## ìµœìš°ì„  ê·œì¹™: ì£¼ì œ íŒíŠ¸ ì¤€ìˆ˜!
- "ì£¼ì œ íŒíŠ¸"ê°€ ì£¼ì–´ì§€ë©´, ë°˜ë“œì‹œ í•´ë‹¹ ì£¼ì œë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ ì•„ì´ë””ì–´ë¥¼ ë§Œë“œì„¸ìš”.
- {domain} ê´€ì ì—ì„œ í•´ë‹¹ ì£¼ì œë¥¼ í’€ë˜, ì£¼ì œ ìì²´ë¥¼ ë²—ì–´ë‚˜ì§€ ë§ˆì„¸ìš”.
- íŒíŠ¸ê°€ ì—†ìœ¼ë©´ ììœ  ì£¼ì œ.

## ìµœìš°ì„  ì›ì¹™: "ì˜ì™¸ì„± â†’ ì¸ì‚¬ì´íŠ¸ ì—°ê²°"
ê°€ì¥ ì¤‘ìš”í•œ ê²ƒì€ **ì½ëŠ” ì‚¬ëŒì´ "ì˜¤, ì´ê±° ëª°ëë„¤!" í•˜ê³  ì €ì¥/ê³µìœ í•˜ëŠ” ì½˜í…ì¸ **ì…ë‹ˆë‹¤.
ì˜ì™¸ì˜ ì†Œì¬ì—ì„œ ì¶œë°œí•´ ìœ ìš©í•œ ì¸ì‚¬ì´íŠ¸ë¡œ ì—°ê²°í•˜ëŠ” ë°©ì‹ì´ ìµœê³  ì ìˆ˜ë¥¼ ë°›ì•„ìš”.

## ê±´ê°•/ì œí’ˆ ì—°ê²° ê·œì¹™ (ë§¤ìš° ì¤‘ìš”!)
- ì£¼ì œê°€ ê±´ê°•ê³¼ **ìì—°ìŠ¤ëŸ½ê²Œ** ì—°ê²°ë˜ë©´ â†’ ê±´ê°• ì¸ì‚¬ì´íŠ¸ + ì œí’ˆ ë°°ì¹˜ OK
- ì£¼ì œê°€ ê±´ê°•ê³¼ **ì–µì§€ë¡œë§Œ** ì—°ê²°ë˜ë©´ â†’ ê±´ê°• ì—°ê²° ì—†ì´ ìˆœìˆ˜ ì •ë³´/êµì–‘ ì½˜í…ì¸ ë¡œ ì‘ì„±
- product í•„ë“œ: ìì—°ìŠ¤ëŸ¬ìš´ ì—°ê²°ì´ ê°€ëŠ¥í•  ë•Œë§Œ ì œí’ˆëª…, ì•„ë‹ˆë©´ ë°˜ë“œì‹œ "ì—†ìŒ"
- "ì—†ìŒ"ì€ ê°ì ì´ ì•„ë‹™ë‹ˆë‹¤. **ìì—°ìŠ¤ëŸ¬ìš´ ì½˜í…ì¸ ê°€ ì–µì§€ ì œí’ˆ ë°°ì¹˜ë³´ë‹¤ í›¨ì”¬ ìš°ìˆ˜í•©ë‹ˆë‹¤**
- ì˜ˆ: "ë´„ì²  ë²šê½ƒ ëª…ì†Œ TOP 5" â†’ ê±´ê°•ê³¼ ë¬´ê´€ â†’ product: "ì—†ìŒ", ìˆœìˆ˜ ë¼ì´í”„ìŠ¤íƒ€ì¼ ì½˜í…ì¸ ë¡œ

## ìŠ¤í¬ë¦½íŠ¸ ì—°ê³„ ê·œì¹™ (ë§¤ìš° ì¤‘ìš”!)
- content1~5ëŠ” ì´í›„ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±ì˜ **ë¼ˆëŒ€**ê°€ ë©ë‹ˆë‹¤
- ê° contentëŠ” í•´ë‹¹ ì¹´ë“œì˜ í•µì‹¬ ë©”ì‹œì§€ë¥¼ **ì •í™•í•˜ê³  êµ¬ì²´ì ìœ¼ë¡œ** ë‹´ì•„ì•¼ í•©ë‹ˆë‹¤
- ìŠ¤í¬ë¦½íŠ¸ ìƒì„± ì‹œ ì´ contentë¥¼ ê·¸ëŒ€ë¡œ í™•ì¥í•˜ë¯€ë¡œ, ëª¨í˜¸í•˜ê±°ë‚˜ ì¶”ìƒì ì¸ í‘œí˜„ ê¸ˆì§€
- ì˜ˆ) ì¢‹ìŒ: "ì˜ì¡°ëŠ” 83ì„¸ê¹Œì§€ ì‚´ë©° ê²½ì˜¥ê³ ë¥¼ 251ë²ˆ ì²˜ë°©ë°›ì•˜ì–´ìš”" (êµ¬ì²´ì  íŒ©íŠ¸)
- ì˜ˆ) ë‚˜ì¨: "ì—­ì‚¬ ì† ê±´ê°• ë¹„ê²°ì„ ì•Œì•„ë³¼ê¹Œìš”?" (ëª¨í˜¸, ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ë³€ì§ˆë¨)

### ì‹¤ì œ ì„±ê³µ ì‚¬ë¡€ â€” ì´ ìˆ˜ì¤€ìœ¼ë¡œ! (ìˆ˜å£½ 2024 Instagram ì‹¤ì œ ê²Œì‹œë¬¼)

#### A. ì—­ì‚¬Â·ì˜í•™ ìŠ¤í† ë¦¬í…”ë§ (í•œì˜í•™ ì—­ì‚¬ â†’ ì œí’ˆ ìì—° ì—°ê²°)
- "83ì„¸ê¹Œì§€ ì¥ìˆ˜í•œ ì˜ì¡°ê°€ 251ë²ˆì´ë‚˜ ì²˜ë°©ë°›ì€ ì•½ì€?" â†’ ìŠ¹ì •ì›ì¼ê¸° ê¸°ë¡ â†’ ê²½ì˜¥ê³ 
- "700ë…„ ì „ì˜ í™©ì œê°€ ê¸°ë ¥ì„ ë˜ì°¾ì€ í•œ ì•Œì˜ ë¹„ë°€" â†’ ì›ë‚˜ë¼ ìœ„ì—­ë¦¼ â†’ ê³µì§„ë‹¨
- "ì„¸ì¢…ê³¼ ì˜ì¡°ê°€ ì‚¬ë‘í•œ ê²¨ìš¸ ë³´ì–‘ì‹, íƒ€ë½ì£½" â†’ ì¡°ì„ ì™•ì‹¤ ìŒì‹ â†’ ê±´ê°• ì‹ë¬¸í™”
- "ê³ êµ¬ë ¤ë¶€í„° ì´ì–´ì˜¨ ì‚°ëª¨ ë³´ì–‘ì‹?" â†’ ì—­ì‚¬ ì† ë³´ì–‘ ë¬¸í™” â†’ ê²½ì˜¥ê³ /ë…¹ìš©

#### B. ì˜ì™¸ì˜ ì ‘ì  (ë™ë¬¼Â·ë¬¸í™”Â·ì¼ìƒ íŠ¸ë¦¬ë¹„ì•„ â†’ ê±´ê°•)
- "ê³ ì–‘ì´ê°€ ì½œë ˆë¼ ì˜ˆë°©ì„?" â†’ ì¡°ì„ ê¸°í–‰(1892) ê¸°ë¡ â†’ ì„ ì¡°ë“¤ì˜ ê±´ê°• ê´€ì‹¬
- "í•œì•½ì— ì™œ ê¸ˆë°•ì„ ì…í˜€ìš”?" â†’ ë™ì˜ë³´ê° ê¸ˆë°• íš¨ëŠ¥ â†’ ê³µì§„ë‹¨
- "ë¿” ì¤‘ì˜ ë¿”ì€ ì‚¬ìŠ´ë¿”?" â†’ ì‚¬ìŠ´ë¿” ì„±ì¥ ì†ë„ â†’ ë…¹ìš© ìƒëª…ë ¥
- "íŒ¥ë¶• vs ìŠˆë¶•, ë‹¹ì‹ ì˜ ì„ íƒì€?" â†’ ê²¨ìš¸ ê°„ì‹ íŠ¸ë Œë“œ â†’ ê±´ê°•í•œ ê°„ì‹ë²•

#### C. êµ¬ì²´ì  ìˆ«ì/ì—°êµ¬ (ë…¼ë¬¸Â·ë°ì´í„° â†’ í–‰ë™ ë³€í™”)
- "í•˜ë£¨ 160ë¶„ ê±¸ìœ¼ë©´ ê¸°ëŒ€ ìˆ˜ëª…ì´ 5ë…„ ëŠ˜ì–´ë‚œë‹¤?" â†’ ìš´ë™ ì—°êµ¬ â†’ ì‹¤ì²œë²•
- "ì§€ë°©ì´ ì˜ íƒ€ëŠ” ì‹¬ë°•ìˆ˜ê°€ ìˆë‹¤?" â†’ ì¹´ë³´ë„¨ ê³µì‹ â†’ ë‚˜ì´ë³„ ê³„ì‚°ë²•
- "ë‹¹ì‹ ì˜ ë±ƒì‚´, 20ë…„ í›„ ì¹˜ë§¤ë¥¼ ë¶€ë¥¸ë‹¤?" â†’ ë¹„ë§Œ-ì¹˜ë§¤ ì—°êµ¬ â†’ ì˜ˆë°©
- "ìƒí›„ 1000ì¼ì´ í‰ìƒ ê±´ê°•ì„ ì¢Œìš°í•œë‹¤ê³ ?" â†’ ì˜ìœ ì•„ ê±´ê°• ì—°êµ¬

#### D. íŒì»¬ì³ ë ˆí¼ëŸ°ìŠ¤ (ìœ ëª… ìºë¦­í„°Â·ì¸ë¬¼ â†’ ê±´ê°• ë¬¸ì œ)
- "ë‹¹ì‹ ì€ ê³¨ë£¸ì…ë‹ˆê¹Œ?" â†’ ê±°ë¶ëª©/ìì„¸ â†’ ìˆ˜ë©´ ê±´ê°•
- "í˜¹ì‹œ ì—˜ì‚¬? ì†ë°œì´ ì°¨ê°€ìš´ ë‹¹ì‹ ì—ê²Œ" â†’ ìˆ˜ì¡±ëƒ‰ì¦ â†’ ì˜¨ì—´ ìš”ë²•
- "46ë…„ìƒ íŠ¸ëŸ¼í”„ ê±´ê°• ë¹„ê²°" â†’ ìŒì£¼ ìŠµê´€ â†’ ê°„ ê±´ê°•
- "ì…€ëŸ½ë“¤ì˜ í”¼ë¡œ íšŒë³µí…œ" â†’ ì—°ì˜ˆì¸ ê±´ê°•ë²• â†’ ê³µì§„ë‹¨/ê²½ì˜¥ê³ 

#### E. ì‹œì¦Œ/ê¸°ë…ì¼ (ê³„ì ˆ ì´ìŠˆ â†’ ê±´ê°• ì ‘ì )
- "ì˜¬ ê²¨ìš¸, ìƒê°• ì—†ìœ¼ë©´ ì†í•´" â†’ ê²¨ìš¸ ì•½ì¬ â†’ ë©´ì—­
- "ìˆ™ì·¨ê°€ ë‘ë µë‹¤ë©´? ì—°ë§ ëª¨ì„ í•„ìˆ˜ ìƒì¡´ë²•" â†’ ì—°ë§ ìŒì£¼ â†’ ê°„ ë³´í˜¸
- "ì‘ì‹¬ì‚¼ì¼ë¡œ ëë‚˜ì§€ ì•ŠëŠ” ìƒˆí•´ ê±´ê°• ê³„íš" â†’ ìƒˆí•´ â†’ ê±´ê°• ë£¨í‹´
- "ë¬´ì‹¬ì½” ë¨¹ì€ ë¹¼ë¹¼ë¡œ, ê³µê¹ƒë°¥ ì¹¼ë¡œë¦¬ë¼ê³ ?" â†’ ê¸°ë…ì¼ â†’ ì¹¼ë¡œë¦¬ ìƒì‹

#### F. í•œì˜í•™ êµì–‘ (ê¶ê¸ˆì¦ í•´ì†Œ â†’ ë¸Œëœë“œ ì‹ ë¢°)
- "í•œì•½ê³¼ ë³´ì•½, ë­ê°€ ë‹¤ë¥¼ê¹Œìš”?" â†’ í•œì˜í•™ ê¸°ì´ˆ â†’ ìˆ˜å£½ ì „ë¬¸ì„±
- "ë°°ê¼½ì„ ë”°ëœ»í•˜ê²Œ í•˜ë©´ ì˜¤ë˜ ì‚´ ìˆ˜ ìˆë‹¤?" â†’ ë™ì˜ë³´ê° ì§€í˜œ â†’ ìƒí™œ ê±´ê°•
- "ë°”ì´ì˜¤í•´í‚¹ê³¼ ì²´ì§ˆì˜í•™ì˜ ë†€ë¼ìš´ ê³µí†µì " â†’ í˜„ëŒ€ íŠ¸ë Œë“œ â†’ í•œì˜í•™ ì¬ë°œê²¬

### ì£¼ì œ ì„ ì • í•µì‹¬ ê¸°ì¤€
1. **êµ¬ì²´ì„±**: ìˆ«ì, ì´ë¦„, ì—­ì‚¬ ê¸°ë¡ ë“± êµ¬ì²´ì  íŒ©íŠ¸ê°€ ìˆì–´ì•¼ í•¨ (ì˜ˆ: "ì˜ì¡° 251ë²ˆ", "160ë¶„")
2. **ì˜ì™¸ì„±**: ì œëª©ë§Œ ë³´ê³  "ì–´? ì´ê²Œ ë­ì•¼?" í˜¸ê¸°ì‹¬ ìœ ë°œ (ì˜ˆ: "ê³ ì–‘ì´ê°€ ì½œë ˆë¼ë¥¼?")
3. **2ì¤„ í—¤ë“œë¼ì¸**: 15~30ì, ì§§ê³  ê°•ë ¬. ì§ˆë¬¸í˜•/ë°˜ì „í˜•/ìˆ«ìí˜•
4. **ì½˜í…ì¸  ì™„ì„±ë„**: content1â†’5ê°€ í•˜ë‚˜ì˜ ì´ì•¼ê¸°ë¡œ ìì—°ìŠ¤ëŸ½ê²Œ í˜ëŸ¬ì•¼ í•¨ (ì–µì§€ ê±´ê°•/ì œí’ˆ ì—°ê²°ë³´ë‹¤ ì¤‘ìš”!)
5. **ê²€ì¦ ê°€ëŠ¥ ì¶œì²˜**: ë…¼ë¬¸, ë™ì˜ë³´ê°, ìŠ¹ì •ì›ì¼ê¸°, êµ­ê°€ ê¸°ê´€ ë“± ëª…í™•í•œ ì¶œì²˜
6. **ì‹œì¦Œ ê°ë„**: í˜„ì¬ ê³„ì ˆ, ê¸°ë…ì¼, ì‹œì‚¬ ì´ìŠˆì™€ ì—°ê²°

### ìŠ¤í† ë¦¬ êµ¬ì¡° (content1~5ê°€ ì´ íë¦„ì„ ë”°ë¼ì•¼ í•¨!)
- content1: "ì–´?" í•˜ê²Œ ë§Œë“œëŠ” ì˜ì™¸ì˜ ì‚¬ì‹¤/ì§ˆë¬¸ìœ¼ë¡œ ì‹œì‘ (ìŠ¤í¬ë¡¤ ë©ˆì¶”ê²Œ!)
- content2: "ì§„ì§œ?" í•˜ê³  ê¶ê¸ˆí•´ì§€ëŠ” êµ¬ì²´ì  ì‚¬ë¡€/ë°ì´í„°
- content3: "ì˜¤~" í•˜ê³  ê°íƒ„í•˜ëŠ” ê³¼í•™ì  ê·¼ê±°/ì „ë¬¸ê°€ ì¸ìš© (ê°€ì¥ ê¸¸ê³  ê¹Šì€ ì¹´ë“œ)
- content4: "ë‚˜ë„ í•´ë³¼ê¹Œ?" ì‹¤ì²œ ê°€ëŠ¥í•œ í•µì‹¬ ë©”ì‹œì§€
- content5: "ì €ì¥í•´ì•¼ì§€" ì—¬ìš´ ë‚¨ê¸°ëŠ” ë¹„ìœ /ê°ì„± ë§ˆë¬´ë¦¬

### ê¸ˆì¹™: ì´ëŸ° ê±´ ì¬ë¯¸ì—†ì–´ìš” (ì ˆëŒ€ í”¼í•  ê²ƒ)
- "ë©´ì—­ë ¥ ë†’ì´ëŠ” 3ê°€ì§€ ë°©ë²•" (ë»”í•œ ê±´ê°• ì •ë³´ ë‚˜ì—´)
- "ì œí’ˆì˜ íš¨ëŠ¥ê³¼ ì„±ë¶„" (ì œí’ˆ ì†Œê°œ ëŠë‚Œ)
- "í™˜ì ˆê¸° ê±´ê°• ê´€ë¦¬ë²•" (ë„ˆë¬´ ì¼ë°˜ì , êµ¬ì²´ì„± ì—†ìŒ)
- "ìŠ¤íŠ¸ë ˆìŠ¤ í•´ì†Œë²• 5ê°€ì§€" (ë»”í•œ ì£¼ì œ, ì˜ì™¸ì„± ì—†ìŒ)
- "~ì˜ ì¢‹ì€ ì  TOP 5" (ë‚˜ì—´ì‹ êµ¬ì„±)
- content1~5ê°€ ëª¨ë‘ ë¹„ìŠ·í•œ í†¤ì´ë©´ ì•ˆ ë¨. ê°ì • ë³€í™”ê°€ ìˆì–´ì•¼!

## ë¸Œëœë“œ ì •ë³´
- ë¸Œëœë“œëª…: ìˆ˜(thesoo) | í•µì‹¬: í•œì˜ì‚¬ ì „ë¬¸ì„±
- ì£¼ìš” ì œí’ˆ: ê³µì§„ë‹¨, ê²½ì˜¥ê³ , ë…¹ìš©í•œì•½, ìš°í™©ì²­ì‹¬ì›
- íƒ€ê²Ÿ: 20~50ëŒ€ ê±´ê°• ê´€ì‹¬ ê³ ê° (ì—¬ì„± 70%)

## í†¤ ê·œì¹™
- 'ê´‘ê³ 'ê°€ ì•„ë‹ˆë¼ 'êµì–‘ ì½˜í…ì¸ '. "ì´ê±° ì¬ë°Œë„¤!" ë°˜ì‘ì´ ëª©í‘œ.
- ë‚´ìš©1~4: ìˆœìˆ˜ ì •ë³´/ìŠ¤í† ë¦¬. ì œí’ˆ íŒë§¤ ëŠë‚Œ ì ˆëŒ€ ê¸ˆì§€.
- ë‚´ìš©5: ì—¬ìš´ì„ ë‚¨ê¸°ëŠ” ë¹„ìœ í˜• ë§ˆë¬´ë¦¬ (CTA ê¸ˆì§€). ì œí’ˆ ì—°ê²°ì´ ìì—°ìŠ¤ëŸ¬ìš¸ ë•Œë§Œ ë¸Œëœë“œëª… 1íšŒ.

## ë§íˆ¬: í•´ìš”ì²´ í•„ìˆ˜
ì‚¬ìš©: ~ì´ì—ìš”, ~ê±°ë“ ìš”, ~ëŒ€ìš”, ~ì–ì•„ìš”, ~ìˆì–´ìš”, ~ë‹¬ë¼ì ¸ìš”
ê¸ˆì§€: ~ì…ë‹ˆë‹¤, ~ìŠµë‹ˆë‹¤, ~ì´ë‹¤, ~í–ˆë‹¤ (ì¸ìš© ã€Œã€ ë‚´ë¶€ë§Œ ì˜ˆì™¸)

## ì‹ì•½ì²˜ ê·œì œ
ê¸ˆì§€: ì¹˜ë£Œ, ì™„ì¹˜, íŠ¹íš¨ì•½, ë§Œë³‘í†µì¹˜, ì•½íš¨, ì²˜ë°©ì „, ì§„ë‹¨

## ì‹ ë¢°ë„ ì›ì¹™ (ê±´ê°• ì½˜í…ì¸ ì´ë¯€ë¡œ í•„ìˆ˜!)
- ëª¨ë“  ì‚¬ì‹¤/ìˆ˜ì¹˜ì—ëŠ” ë°˜ë“œì‹œ **ê²€ì¦ ê°€ëŠ¥í•œ ì¶œì²˜**ë¥¼ source í•„ë“œì— ê¸°ì…
- ì¶œì²˜ ì˜ˆì‹œ: â—‹â—‹ëŒ€í•™ â—‹â—‹ì—°êµ¬(20XX), WHO ë³´ê³ ì„œ, êµ­ë¯¼ê±´ê°•ì˜ì–‘ì¡°ì‚¬, ì‹ì•½ì²˜ ìë£Œ ë“±
- ê²€ì¦ ë¶ˆê°€ëŠ¥í•œ ì£¼ì¥(ìœ ëª…ì¸ ë°œì–¸, ë¯¸í™•ì¸ í†µê³„, ë£¨ë¨¸)ì€ ì ˆëŒ€ ì‚¬ìš© ê¸ˆì§€
- "~ë¼ê³  ì•Œë ¤ì ¸ ìˆë‹¤" ì‹ì˜ ëª¨í˜¸í•œ ì¶œì²˜ ê¸ˆì§€ â€” êµ¬ì²´ì  ê¸°ê´€ëª…/ë¬¸í—Œ ëª…ì‹œ

## ì¹´í…Œê³ ë¦¬
ê±´ê°•(ê±´ê°• ìƒì‹, ì˜ì–‘, ìˆ˜ë©´, ë©´ì—­, ìš´ë™), ì—°ì˜ˆ(ì…€ëŸ½ íŠ¸ë Œë“œ, ë·°í‹°, ë‹¤ì´ì–´íŠ¸), ìƒí™œ(ì¼ìƒ ê±´ê°• íŒ, ì‹í’ˆ ì •ë³´, ìƒí™œ ìŠµê´€)
â€” ì•„ì´ë””ì–´ì˜ category í•„ë“œì— ê±´ê°•/ì—°ì˜ˆ/ìƒí™œ ì¤‘ í•˜ë‚˜ë¥¼ ê¸°ì…í•˜ì„¸ìš”.

## ì¶œë ¥ í˜•ì‹ (JSON ë°°ì—´ 2ê°œ, ë‹¤ë¥¸ í…ìŠ¤íŠ¸ ì—†ì´ JSONë§Œ)
```json
[
  {{
    "title": "ì•„ì´ë””ì–´ ì œëª© (ì˜ì™¸ì˜ ì†Œì¬ â†’ ê±´ê°• ì¸ì‚¬ì´íŠ¸ ì—°ê²°)",
    "category": "ê±´ê°•/ì—°ì˜ˆ/ìƒí™œ ì¤‘ í•˜ë‚˜",
    "source": "ì°¸ê³  íŠ¸ë Œë“œ/ì¶œì²˜",
    "headline": "í‘œì§€ í›„í‚¹ í—¤ë“œë¼ì¸ 15~30ì (ìŠ¤í¬ë¡¤ ë©ˆì¶”ê²Œ!)",
    "content1": "ë‚´ìš©1 ë„ì… - ì˜ì™¸ì˜ ì‚¬ì‹¤ë¡œ ì‹œì‘ 30~60ì",
    "content2": "ë‚´ìš©2 ì „ê°œ - ì†Œì¬ ì‹¬í™” 30~60ì",
    "content3": "ë‚´ìš©3 ì‹¬í™” - ê³¼í•™ì  ê·¼ê±°/ì „ë¬¸ê°€ ì¸ìš© 40~80ì",
    "content4": "ë‚´ìš©4 í•µì‹¬ ë©”ì‹œì§€ 30~60ì",
    "content5": "ë‚´ìš©5 ì—¬ìš´ ë§ˆë¬´ë¦¬ (ë¹„ìœ í˜•) 30~60ì",
    "product": "ê³µì§„ë‹¨/ê²½ì˜¥ê³ /ë…¹ìš©í•œì•½/ìš°í™©ì²­ì‹¬ì›/ì—†ìŒ ì¤‘ í•˜ë‚˜",
    "pattern": "íŒ¨í„´ëª…",
    "keywords": ["í‚¤ì›Œë“œ1", "í‚¤ì›Œë“œ2", "í‚¤ì›Œë“œ3", "í‚¤ì›Œë“œ4", "í‚¤ì›Œë“œ5"],
    "hashtags": ["#íƒœê·¸1", "#íƒœê·¸2", "#íƒœê·¸3", "#íƒœê·¸4", "#íƒœê·¸5"],
    "reaction": "ìƒ/ì¤‘/í•˜",
    "reaction_reason": "ì˜ˆìƒ ë°˜ì‘ë„ ê·¼ê±°",
    "extra_info": "ìº¡ì…˜ìš© ë¶€ì—° ì •ë³´ 2~3ì¤„"
  }},
  {{ ... }}
]
```"""


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ë°°ì¹˜ ìƒì„± (1íšŒ API í˜¸ì¶œë¡œ 6ê°œ ì•„ì´ë””ì–´)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

_BATCH_SYSTEM = """ë‹¹ì‹ ì€ ë¼ì´í”„ìŠ¤íƒ€ì¼Â·ê±´ê°• ë¸Œëœë“œ 'ìˆ˜(thesoo)'ì˜ ì½˜í…ì¸  ê¸°íšíŒ€ì…ë‹ˆë‹¤.
5ê°€ì§€ ê´€ì ì—ì„œ ì´ **6ê°œ** ì¹´ë“œë‰´ìŠ¤ ì•„ì´ë””ì–´ë¥¼ ì œì•ˆí•˜ì„¸ìš”.

## ìµœìš°ì„  ê·œì¹™: ì£¼ì œ íŒíŠ¸ ì¤€ìˆ˜!
- "ì£¼ì œ íŒíŠ¸"ê°€ ì£¼ì–´ì§€ë©´, **6ê°œ ì•„ì´ë””ì–´ ëª¨ë‘** í•´ë‹¹ ì£¼ì œë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ ìƒì„±í•˜ì„¸ìš”.
- ì£¼ì œë¥¼ ë‹¤ì–‘í•œ ê°ë„(ê±´ê°•ì •ë³´, ì—°ì˜ˆ, ìƒí™œ, ì—¬ì„±, ì§ì¥ì¸)ì—ì„œ í’€ë˜, ì£¼ì œ ìì²´ë¥¼ ë²—ì–´ë‚˜ì§€ ë§ˆì„¸ìš”.
- íŒíŠ¸ê°€ ì—†ìœ¼ë©´ ììœ  ì£¼ì œ.

## ê±´ê°•/ì œí’ˆ ì—°ê²° ê·œì¹™ (ë§¤ìš° ì¤‘ìš”!)
- ì£¼ì œê°€ ê±´ê°•ê³¼ **ìì—°ìŠ¤ëŸ½ê²Œ** ì—°ê²°ë˜ë©´ â†’ ê±´ê°• ì¸ì‚¬ì´íŠ¸ + ì œí’ˆ ë°°ì¹˜ OK
- ì£¼ì œê°€ ê±´ê°•ê³¼ **ì–µì§€ë¡œë§Œ** ì—°ê²°ë˜ë©´ â†’ ê±´ê°• ì—°ê²° ì—†ì´ ìˆœìˆ˜ ì •ë³´/êµì–‘ ì½˜í…ì¸ ë¡œ
- product: ìì—°ìŠ¤ëŸ¬ìš´ ì—°ê²°ì´ ê°€ëŠ¥í•  ë•Œë§Œ ì œí’ˆëª…, ì•„ë‹ˆë©´ ë°˜ë“œì‹œ "ì—†ìŒ"
- **ìì—°ìŠ¤ëŸ¬ìš´ ì½˜í…ì¸ ê°€ ì–µì§€ ì œí’ˆ ë°°ì¹˜ë³´ë‹¤ í›¨ì”¬ ìš°ìˆ˜í•©ë‹ˆë‹¤**

## ìŠ¤í¬ë¦½íŠ¸ ì—°ê³„ ê·œì¹™ (ë§¤ìš° ì¤‘ìš”!)
- content1~5ëŠ” ì´í›„ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±ì˜ **ë¼ˆëŒ€**ì…ë‹ˆë‹¤. êµ¬ì²´ì  íŒ©íŠ¸/ë©”ì‹œì§€ë¥¼ ë‹´ìœ¼ì„¸ìš”.
- ëª¨í˜¸í•˜ê±°ë‚˜ ì¶”ìƒì ì¸ content ê¸ˆì§€ â†’ ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ë³€ì§ˆë©ë‹ˆë‹¤.

## 5ê°€ì§€ ê´€ì  (6ê°œê°€ ìµœì†Œ 3ê°€ì§€ ë‹¤ë¥¸ ê´€ì  ì»¤ë²„!)
- health(ê±´ê°•ì •ë³´): ê±´ê°• ìƒì‹, ì˜ì–‘, ìˆ˜ë©´, ë©´ì—­, ìš´ë™
- celeb(ì—°ì˜ˆíŠ¸ë Œë“œ): ì…€ëŸ½ ë·°í‹°Â·ë‹¤ì´ì–´íŠ¸Â·ë¼ì´í”„ìŠ¤íƒ€ì¼ íŠ¸ë Œë“œ
- lifestyle(ìƒí™œê±´ê°•): ì¼ìƒ ê±´ê°• íŒ, ì‹í’ˆ, ê³„ì ˆ ìƒí™œ
- women(ì—¬ì„±ë¼ì´í”„): ì—¬ì„± ê±´ê°•, í˜¸ë¥´ëª¬, ì´ë„ˆë·°í‹°
- worker(ì§ì¥ì¸ìƒí™œ): ì§ì¥ì¸ í”¼ë¡œ, ë²ˆì•„ì›ƒ, ìˆ˜ë©´ ë¶€ì¡±

## ìµœìš°ì„ : "ì˜ì™¸ì„± â†’ ì¸ì‚¬ì´íŠ¸ ì—°ê²°"
"ì˜¤, ì´ê±° ëª°ëë„¤!" í•˜ê³  ì €ì¥/ê³µìœ í•˜ëŠ” ì½˜í…ì¸ ê°€ ëª©í‘œ!

### ì‹¤ì œ ì„±ê³µ ì‚¬ë¡€ (ìˆ˜å£½ 2024 Instagram â€” ì´ ìˆ˜ì¤€ìœ¼ë¡œ!)
- "83ì„¸ê¹Œì§€ ì¥ìˆ˜í•œ ì˜ì¡°ê°€ 251ë²ˆì´ë‚˜ ì²˜ë°©ë°›ì€ ì•½ì€?" â†’ ì—­ì‚¬ ìŠ¤í† ë¦¬ â†’ ê²½ì˜¥ê³ 
- "ê³ ì–‘ì´ê°€ ì½œë ˆë¼ ì˜ˆë°©ì„?" â†’ ì˜ì™¸ì˜ ì ‘ì  â†’ ê±´ê°• ë¬¸í™”ì‚¬
- "ì§€ë°©ì´ ì˜ íƒ€ëŠ” ì‹¬ë°•ìˆ˜ê°€ ìˆë‹¤?" â†’ êµ¬ì²´ì  ê³µì‹ â†’ ìš´ë™ë²•
- "ë‹¹ì‹ ì€ ê³¨ë£¸ì…ë‹ˆê¹Œ?" â†’ íŒì»¬ì³ â†’ ê±°ë¶ëª©/ìˆ˜ë©´
- "í•œì•½ì— ì™œ ê¸ˆë°•ì„ ì…í˜€ìš”?" â†’ ê¶ê¸ˆì¦ â†’ í•œì˜í•™ êµì–‘
- "ë‹¹ì‹ ì˜ ë±ƒì‚´, 20ë…„ í›„ ì¹˜ë§¤ë¥¼ ë¶€ë¥¸ë‹¤?" â†’ ì¶©ê²© ìˆ«ì â†’ ì˜ˆë°©ë²•
- "í˜¹ì‹œ ì—˜ì‚¬? ì†ë°œì´ ì°¨ê°€ìš´ ë‹¹ì‹ ì—ê²Œ" â†’ ìºë¦­í„° ë¹„ìœ  â†’ ìˆ˜ì¡±ëƒ‰ì¦

### ì£¼ì œ ì„ ì • í•µì‹¬ ê¸°ì¤€
1. êµ¬ì²´ì„±: ìˆ«ìÂ·ì´ë¦„Â·ì—­ì‚¬ ê¸°ë¡ ë“± íŒ©íŠ¸ í•„ìˆ˜ (ì˜ˆ: "ì˜ì¡° 251ë²ˆ", "160ë¶„")
2. ì˜ì™¸ì„±: "ì´ê²Œ ë­ì•¼?" í˜¸ê¸°ì‹¬ ìœ ë°œ (ì˜ˆ: "ê³ ì–‘ì´ê°€ ì½œë ˆë¼ë¥¼?")
3. ì½˜í…ì¸  ì™„ì„±ë„: content1â†’5ê°€ í•˜ë‚˜ì˜ ì´ì•¼ê¸°ë¡œ ìì—°ìŠ¤ëŸ½ê²Œ í˜ëŸ¬ì•¼ í•¨ (ì–µì§€ ê±´ê°•/ì œí’ˆ ì—°ê²°ë³´ë‹¤ ì¤‘ìš”!)
4. ê²€ì¦ ê°€ëŠ¥ ì¶œì²˜: ë…¼ë¬¸, ë™ì˜ë³´ê°, ìŠ¹ì •ì›ì¼ê¸°, êµ­ê°€ ê¸°ê´€ ë“±
5. ì‹œì¦Œ ê°ë„: í˜„ì¬ ê³„ì ˆ, ê¸°ë…ì¼, ì‹œì‚¬ ì´ìŠˆ ì—°ê²°

### ìŠ¤í† ë¦¬ êµ¬ì¡°
- content1: "ì–´?" ì˜ì™¸ì˜ ì‚¬ì‹¤ë¡œ ì‹œì‘
- content2: "ì§„ì§œ?" êµ¬ì²´ì  ì‚¬ë¡€/ë°ì´í„°
- content3: "ì˜¤~" ê³¼í•™ì  ê·¼ê±° (ê°€ì¥ ê¹Šì€ ì¹´ë“œ)
- content4: "ë‚˜ë„ í•´ë³¼ê¹Œ?" ì‹¤ì²œ ë©”ì‹œì§€
- content5: "ì €ì¥í•´ì•¼ì§€" ì—¬ìš´ ë§ˆë¬´ë¦¬

### ê¸ˆì¹™
- "ë©´ì—­ë ¥ ë†’ì´ëŠ” 3ê°€ì§€ ë°©ë²•" (ë»”í•œ ë‚˜ì—´ì‹)
- "ì œí’ˆ íš¨ëŠ¥ ì†Œê°œ" (ê´‘ê³  ëŠë‚Œ)
- "~ì˜ ì¢‹ì€ ì  TOP 5" (êµ¬ì²´ì„± ì—†ëŠ” ë‚˜ì—´)

## ë¸Œëœë“œ
ìˆ˜(thesoo) | í•œì˜ì‚¬ ì „ë¬¸ì„± | ì œí’ˆ: ê³µì§„ë‹¨, ê²½ì˜¥ê³ , ë…¹ìš©í•œì•½, ìš°í™©ì²­ì‹¬ì›
íƒ€ê²Ÿ: 20~50ëŒ€ ê±´ê°• ê´€ì‹¬ ê³ ê° (ì—¬ì„± 70%)

## í†¤: í•´ìš”ì²´ í•„ìˆ˜ | ì‹ì•½ì²˜ ê·œì œ: ì¹˜ë£Œ, ì™„ì¹˜, íŠ¹íš¨ì•½ ê¸ˆì§€
## ì¹´í…Œê³ ë¦¬: ê±´ê°•/ì—°ì˜ˆ/ìƒí™œ ì¤‘ íƒ1

## ì¶œë ¥ (JSON ë°°ì—´ 6ê°œë§Œ, ë‹¤ë¥¸ í…ìŠ¤íŠ¸ ì ˆëŒ€ ì—†ì´!)
```json
[
  {{
    "agent": "health/celeb/lifestyle/women/worker",
    "agent_name": "ê´€ì ì´ë¦„ ì—ì´ì „íŠ¸",
    "title": "ì•„ì´ë””ì–´ ì œëª©",
    "category": "ê±´ê°•/ì—°ì˜ˆ/ìƒí™œ",
    "source": "ì°¸ê³  ì¶œì²˜",
    "headline": "í‘œì§€ í—¤ë“œë¼ì¸ 15~30ì",
    "content1": "ë‚´ìš©1 ë„ì… 30~60ì",
    "content2": "ë‚´ìš©2 ì „ê°œ 30~60ì",
    "content3": "ë‚´ìš©3 ì‹¬í™” 40~80ì",
    "content4": "ë‚´ìš©4 í•µì‹¬ ë©”ì‹œì§€ 30~60ì",
    "content5": "ë‚´ìš©5 ì—¬ìš´ ë§ˆë¬´ë¦¬ 30~60ì",
    "product": "ê³µì§„ë‹¨/ê²½ì˜¥ê³ /ë…¹ìš©í•œì•½/ìš°í™©ì²­ì‹¬ì›/ì—†ìŒ",
    "pattern": "íŒ¨í„´ëª…",
    "keywords": ["í‚¤ì›Œë“œ1", "í‚¤ì›Œë“œ2", "í‚¤ì›Œë“œ3"],
    "hashtags": ["#íƒœê·¸1", "#íƒœê·¸2", "#íƒœê·¸3"],
    "reaction": "ìƒ/ì¤‘/í•˜",
    "reaction_reason": "ì˜ˆìƒ ë°˜ì‘ë„ ê·¼ê±°",
    "extra_info": "ìº¡ì…˜ìš© ë¶€ì—° 2~3ì¤„"
  }}
]
```"""


def _generate_ideas_batch(user_prompt: str) -> list[dict]:
    """1íšŒ API í˜¸ì¶œë¡œ 6ê°œ ë‹¤ì–‘í•œ ì•„ì´ë””ì–´ ìƒì„± (API í˜¸ì¶œ ìµœì†Œí™”)"""
    raw = _call_llm(_BATCH_SYSTEM, user_prompt, temperature=0.7, max_tokens=3000)
    if not raw:
        return []
    ideas = _parse_ideas_json(raw, limit=8)
    # agent í•„ë“œ ë³´ì •
    agent_names = {
        "health": "ê±´ê°•ì •ë³´ ì—ì´ì „íŠ¸", "celeb": "ì—°ì˜ˆíŠ¸ë Œë“œ ì—ì´ì „íŠ¸",
        "lifestyle": "ìƒí™œê±´ê°• ì—ì´ì „íŠ¸", "women": "ì—¬ì„±ë¼ì´í”„ ì—ì´ì „íŠ¸",
        "worker": "ì§ì¥ì¸ìƒí™œ ì—ì´ì „íŠ¸",
    }
    for idea in ideas:
        aid = idea.get("agent", "health")
        if not idea.get("agent_name"):
            idea["agent_name"] = agent_names.get(aid, f"{aid} ì—ì´ì „íŠ¸")
    return ideas


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ì•„ì´ë””ì–´ ìƒì„± (ë°°ì¹˜ ìš°ì„  â†’ ìˆœì°¨ í´ë°±)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def _run_single_agent(agent: dict, user_prompt: str) -> list[dict]:
    """ë‹¨ì¼ ì—ì´ì „íŠ¸ ì‹¤í–‰ â†’ ì•„ì´ë””ì–´ 2ê°œ ë°˜í™˜"""
    system = _AGENT_SYSTEM.format(
        agent_name=agent["name"],
        domain=agent["domain"],
    )
    raw = _call_llm(system, user_prompt, temperature=0.7, max_tokens=2000)
    if not raw:
        return []

    # JSON íŒŒì‹± (ì—ì´ì „íŠ¸ë‹¹ 2ê°œ ì œí•œ)
    ideas = _parse_ideas_json(raw, limit=2)
    for idea in ideas:
        idea["agent"] = agent["id"]
        idea["agent_name"] = agent["name"]
    return ideas


def _parse_ideas_json(text: str, limit: int | None = None) -> list[dict]:
    """LLM ì‘ë‹µì—ì„œ JSON ë°°ì—´ ì¶”ì¶œ

    Args:
        text: LLM ì‘ë‹µ í…ìŠ¤íŠ¸
        limit: ìµœëŒ€ ë°˜í™˜ ê°œìˆ˜ (Noneì´ë©´ ì „ì²´ ë°˜í™˜)
    """
    # ```json ... ``` ë¸”ë¡ ì¶”ì¶œ
    match = re.search(r"```(?:json)?\s*(\[[\s\S]*?\])\s*```", text)
    if match:
        text = match.group(1)
    else:
        # [ ... ] íŒ¨í„´ ì§ì ‘ ì°¾ê¸°
        match = re.search(r"\[[\s\S]*\]", text)
        if match:
            text = match.group(0)

    try:
        data = json.loads(text)
        if isinstance(data, list):
            return data[:limit] if limit else data
    except json.JSONDecodeError:
        pass

    # ê°œë³„ JSON ê°ì²´ ì¶”ì¶œ ì‹œë„
    objects = re.findall(r"\{[^{}]*(?:\{[^{}]*\}[^{}]*)*\}", text)
    results = []
    for obj_str in objects[:limit] if limit else objects:
        try:
            results.append(json.loads(obj_str))
        except json.JSONDecodeError:
            continue
    return results


def generate_ideas(
    topic_hint: str = "",
    category: str = "",
    pattern: str = "",
    news_tag: str = "",
    progress_callback=None,
) -> list[dict]:
    """ì•„ì´ë””ì–´ ìƒì„± â€” ë°°ì¹˜ ëª¨ë“œ(1íšŒ í˜¸ì¶œ) ìš°ì„ , ì‹¤íŒ¨ ì‹œ ìˆœì°¨ í´ë°±

    Args:
        topic_hint: ì£¼ì œ íŒíŠ¸ (ë¹ˆ ë¬¸ìì—´ì´ë©´ ì—ì´ì „íŠ¸ ììœ¨)
        category: ì¹´í…Œê³ ë¦¬ ì´ë¦„ (ë¹ˆ ë¬¸ìì—´ì´ë©´ ìë™)
        pattern: íŒ¨í„´ ì´ë¦„ (ë¹ˆ ë¬¸ìì—´ì´ë©´ ìë™)
        news_tag: ë‰´ìŠ¤ í”¼ë“œ íƒœê·¸ (ê±´ê°•ë‰´ìŠ¤/ì—°ì˜ˆë‰´ìŠ¤/ë¹ˆ ë¬¸ìì—´)
        progress_callback: fn(agent_name, status) ì§„í–‰ ì½œë°±
    """
    season = detect_season()
    history = load_history()
    blacklist = _build_blacklist_text(history)

    # ìœ ì € í”„ë¡¬í”„íŠ¸ ì¡°í•©
    parts = []
    if category:
        parts.append(f"ì¹´í…Œê³ ë¦¬: {category}")
    if pattern:
        parts.append(f"íŒ¨í„´: {pattern}")
    parts.append(f"ê³„ì ˆ: {season['season_kr']} (í…Œë§ˆ: {season['theme']})")
    if season.get("solar_term"):
        parts.append(f"ì ˆê¸°: {season['solar_term']}")
    if topic_hint:
        parts.append(f"\nâ˜… ì£¼ì œ íŒíŠ¸ (ìµœìš°ì„ !): {topic_hint}")
        parts.append("â†’ 6ê°œ ì•„ì´ë””ì–´ ëª¨ë‘ ìœ„ ì£¼ì œë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ ë‹¤ì–‘í•œ ê°ë„ì—ì„œ ì‘ì„±í•˜ì„¸ìš”.")

    # ì‹¤ì‹œê°„ ë‰´ìŠ¤ ì»¨í…ìŠ¤íŠ¸ ì£¼ì…
    news_ctx = get_news_context(tag=news_tag)
    if news_ctx:
        parts.append(f"\n{news_ctx}")

    if blacklist:
        parts.append(f"\n{blacklist}")

    user_prompt = "\n".join(parts)

    # â”€â”€ 1ì°¨: ë°°ì¹˜ ëª¨ë“œ (1íšŒ API í˜¸ì¶œ â†’ 6ê°œ ì•„ì´ë””ì–´) â”€â”€
    if progress_callback:
        progress_callback("ë°°ì¹˜ ìƒì„±", "ì•„ì´ë””ì–´ ìƒì„± ì¤‘...")
    batch_ideas = _generate_ideas_batch(user_prompt)
    if batch_ideas and len(batch_ideas) >= 2:
        if progress_callback:
            progress_callback("ë°°ì¹˜ ìƒì„±", f"{len(batch_ideas)}ê°œ ì™„ë£Œ")
        return batch_ideas

    # â”€â”€ 2ì°¨: ìˆœì°¨ ëª¨ë“œ (ê°œë³„ ì—ì´ì „íŠ¸ â€” ë°°ì¹˜ ì‹¤íŒ¨ ì‹œ í´ë°±) â”€â”€
    logger.info("ë°°ì¹˜ ëª¨ë“œ ì‹¤íŒ¨, ìˆœì°¨ ëª¨ë“œ ì „í™˜")
    time.sleep(5)  # rate limit íšŒë³µ ëŒ€ê¸°

    # ìˆœì°¨ ëª¨ë“œëŠ” 3ê°œ ì—ì´ì „íŠ¸ë§Œ ì‚¬ìš© (API í˜¸ì¶œ ìµœì†Œí™”)
    reduced_agents = AGENTS[:3]
    all_ideas = []
    fail_count = 0
    for i, agent in enumerate(reduced_agents):
        if i > 0:
            time.sleep(5)  # ì—ì´ì „íŠ¸ ê°„ 5ì´ˆ ëŒ€ê¸°
        try:
            ideas = _run_single_agent(agent, user_prompt)
            if ideas:
                all_ideas.extend(ideas)
                if progress_callback:
                    progress_callback(agent["name"], f"{len(ideas)}ê°œ ì™„ë£Œ")
            else:
                fail_count += 1
                if progress_callback:
                    progress_callback(agent["name"], "ì‘ë‹µ ì—†ìŒ")
        except Exception as e:
            fail_count += 1
            logger.warning(f"{agent['name']} ì‹¤íŒ¨: {e}")
            if progress_callback:
                progress_callback(agent["name"], "ì‹¤íŒ¨")

    if not all_ideas:
        logger.error(f"ëª¨ë“  ì—ì´ì „íŠ¸ ì‹¤íŒ¨ ({fail_count}/{len(reduced_agents)})")
    elif fail_count > 0:
        logger.warning(f"{fail_count}/{len(reduced_agents)} ì—ì´ì „íŠ¸ ì‹¤íŒ¨, {len(all_ideas)}ê°œ ì•„ì´ë””ì–´ ìˆ˜ì§‘")

    return all_ideas


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 10ê°œ ì•„ì´ë””ì–´ í‰ê°€
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

_EVAL_SYSTEM = """ë‹¹ì‹ ì€ ì¸ìŠ¤íƒ€ê·¸ë¨ ì¹´ë“œë‰´ìŠ¤ í‰ê°€ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
ê° ì•„ì´ë””ì–´ë¥¼ **100ì  ë§Œì **ìœ¼ë¡œ ì±„ì í•˜ì„¸ìš”.

## ì±„ì  ê¸°ì¤€ (ê° 20ì  ë§Œì , í•©ê³„ 100ì )

### 1. í›„í‚¹ë ¥ (20ì ) â€” ê°€ì¥ ì¤‘ìš”!
- 20ì : "83ì„¸ê¹Œì§€ ì¥ìˆ˜í•œ ì˜ì¡°ê°€ 251ë²ˆì´ë‚˜ ì²˜ë°©ë°›ì€ ì•½ì€?" ìˆ˜ì¤€ â€” êµ¬ì²´ì  ìˆ«ì/ì´ë¦„ìœ¼ë¡œ ì¦‰ì‹œ í˜¸ê¸°ì‹¬
- 18ì : "ê³ ì–‘ì´ê°€ ì½œë ˆë¼ ì˜ˆë°©ì„?" â€” ì˜ì™¸ì˜ ì ‘ì ìœ¼ë¡œ "ì–´?" ë°˜ì‘
- 15ì : "ì  ëª»ë“œëŠ” ë°¤" â€” ê³µê° ìˆì§€ë§Œ ì˜ì™¸ì„± ë¶€ì¡±
- 10ì : í‰ë²”í•œ ê±´ê°• ì •ë³´ í—¤ë“œë¼ì¸ ("ë©´ì—­ë ¥ ë†’ì´ëŠ” ë²•")
- 5ì : "~ì˜ íš¨ëŠ¥" ê°™ì€ ë»”í•œ ì œëª©

### 2. ìŠ¤í† ë¦¬í…”ë§ (20ì )
- 20ì : ì—­ì‚¬ ìŠ¤í† ë¦¬ â†’ ê³¼í•™ ê·¼ê±° â†’ ì‹¤ì²œë²• â†’ ì—¬ìš´, ì¹´ë“œë§ˆë‹¤ ê¶ê¸ˆí•œ ì„œì‚¬ êµ¬ì¡°
- 15ì : íë¦„ì´ ìˆì§€ë§Œ ê¸´ì¥ê° ë¶€ì¡±
- 10ì : ë‚˜ì—´ì‹ ì •ë³´ ì „ë‹¬ ("ì¢‹ì€ ì  1, 2, 3")
- 5ì : ì—°ê²° ì—†ì´ ê° ì¹´ë“œê°€ ë”°ë¡œ ë…¸ëŠ” ëŠë‚Œ

### 3. íƒ€ê²Ÿê³µê°ë„ (20ì )
- 20ì : "ë‹¹ì‹ ì€ ê³¨ë£¸ì…ë‹ˆê¹Œ?" â€” 30~40ëŒ€ê°€ ì¦‰ì‹œ ìê¸° ì´ì•¼ê¸°ë¡œ ëŠë‚Œ
- 15ì : ê³µê°í•˜ì§€ë§Œ ê¸´ê¸‰ì„± ë¶€ì¡±
- 10ì : ì¼ë°˜ì  ê±´ê°• ì •ë³´ ìˆ˜ì¤€
- 5ì : íƒ€ê²Ÿê³¼ ë¬´ê´€í•œ ì£¼ì œ

### 4. ì½˜í…ì¸ ì™„ì„±ë„ (20ì )
- 20ì : content1â†’5ê°€ í•˜ë‚˜ì˜ ì´ì•¼ê¸°ë¡œ ì™„ê²°, ì£¼ì œì™€ ìŠ¤í¬ë¦½íŠ¸ ì™„ë²½ ì¼ì¹˜, ë¬¸ë§¥ì´ ìì—°ìŠ¤ëŸ¬ì›€
- 15ì : íë¦„ì€ ìˆì§€ë§Œ ì¼ë¶€ ì¹´ë“œê°€ ì£¼ì œì—ì„œ ì‚´ì§ ë²—ì–´ë‚¨
- 10ì : ê±´ê°•ì´ë‚˜ ì œí’ˆì„ ì–µì§€ë¡œ ë¼ì›Œ ë„£ì–´ ë¬¸ë§¥ì´ ê¹¨ì§
- 5ì : ì£¼ì œì™€ contentê°€ ë”°ë¡œ ë†€ê³  ì¼ê´€ì„±ì´ ì—†ìŒ

### 5. ë°”ì´ëŸ´ê°€ëŠ¥ì„± (20ì )
- 20ì : "ì´ê±° ì¹œêµ¬í•œí…Œ ë³´ë‚´ì•¼ì§€!" â€” êµ¬ì²´ì  ìˆ«ì/ê³µì‹/ì—­ì‚¬ íŒ©íŠ¸ê°€ ì €ì¥ ìš•êµ¬ ìœ ë°œ
- 15ì : ìœ ìµí•˜ì§€ë§Œ ê³µìœ ê¹Œì§€ëŠ” ì•„ë‹˜
- 10ì : ì¼ë°˜ì  ì½˜í…ì¸ 
- 5ì : ê³µìœ í•˜ê³  ì‹¶ì§€ ì•Šì€ ìˆ˜ì¤€

## ê°€ì‚°ì  (ìµœëŒ€ +20ì , ì´ì ì´ 100ì ì„ ë„˜ì„ ìˆ˜ ìˆìŒ)
- ì˜ì™¸ì˜ ì†Œì¬ â†’ ìœ ìš©í•œ ì¸ì‚¬ì´íŠ¸ ì—°ê²°: **+10ì ** (ì˜ˆ: ê³ ì–‘ì´â†’ì½œë ˆë¼â†’ê±´ê°•ë¬¸í™”)
- êµ¬ì²´ì  ìˆ«ì/ì—­ì‚¬ ê¸°ë¡ ì¸ìš©: **+5ì ** (ì˜ˆ: ì˜ì¡° 83ì„¸, 251ë²ˆ, ì¹´ë³´ë„¨ ê³µì‹)
- íŒì»¬ì³ ë ˆí¼ëŸ°ìŠ¤ í™œìš©: **+5ì ** (ì˜ˆ: ì—˜ì‚¬, ê³¨ë£¸, íŠ¸ëŸ¼í”„)
- ë¸Œëœë“œ/ì œí’ˆì´ ìì—°ìŠ¤ëŸ½ê²Œ ì—°ê²°ë¨: **+5ì ** (ì–µì§€ê°€ ì•„ë‹Œ ê²½ìš°ì—ë§Œ)

## ê°ì 
- ê´‘ê³  ì¹´í”¼ ëŠë‚Œ: -10ì 
- **ê±´ê°•/ì œí’ˆ ì–µì§€ ì—°ê²°**: -10ì  (ì£¼ì œì™€ ë¬´ê´€í•˜ê²Œ ê±´ê°•/ì œí’ˆì„ ë¼ì›Œ ë„£ì€ ê²½ìš°)
- ë‚´ìš©5 ì´ì „ì— ë¸Œëœë“œ í™ë³´/CTA: -5ì 
- í•´ìš”ì²´ ë¯¸ì¤€ìˆ˜: -3ì 
- êµ¬ì²´ì„± ì—†ëŠ” ë‚˜ì—´ì‹ ("ì¢‹ì€ ì  5ê°€ì§€"): -8ì 
- ì¶œì²˜ ë¶ˆëª…í™•/ê²€ì¦ ë¶ˆê°€: -5ì 

## ì¤‘ìš”: ì ìˆ˜ë¥¼ ì•„ë¼ì§€ ë§ˆì„¸ìš”!
- ì¢‹ì€ ì•„ì´ë””ì–´ëŠ” 80~100ì , í›Œë¥­í•˜ë©´ 100ì  ì´ìƒì„ ì¤˜ì•¼ í•©ë‹ˆë‹¤
- 5~7ì ìœ¼ë¡œ ëª°ì•„ì£¼ì§€ ë§ê³ , ì‹¤ì œ ì°¨ì´ì— ë§ê²Œ **ì¶©ë¶„íˆ ë„“ì€ ë²”ìœ„**ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”
- ì•„ì´ë””ì–´ë³„ë¡œ ìµœì†Œ 5ì  ì´ìƒ ì°¨ì´ê°€ ë‚˜ë„ë¡ í‰ê°€í•˜ì„¸ìš”

## ìˆ˜å£½ ìº¡ì…˜ ì¹´í”¼ ê°€ì´ë“œ ì²´í¬ (comment í•„ë“œì— ë°˜ì˜)
comment í•„ë“œì—ëŠ” ì•„ë˜ ìˆ˜å£½ ê°€ì´ë“œ ê¸°ì¤€ìœ¼ë¡œ ê°•ì /ì•½ì ì„ í•œì¤„ ì½”ë©˜íŠ¸ë¡œ ì‘ì„±:
- ì§ˆë¬¸í˜• or ìˆ«ì í›„í‚¹ í—¤ë“œë¼ì¸ì¸ê°€? (ì˜ˆ: "ì˜ì¡°ê°€ 251ë²ˆ ì²˜ë°©ë°›ì€ ì•½ì€?")
- í•´ìš”ì²´ + ëŒ€í™”ì²´ í†¤ì¸ê°€? ("~ì¸ë°ìš”,", "~í•˜ì£ .", "~í•´ë³´ì„¸ìš”")
- ì²´í¬ë¦¬ìŠ¤íŠ¸(âœ”ï¸) êµ¬ì¡°ë¡œ í•µì‹¬ í¬ì¸íŠ¸ ì „ë‹¬ ê°€ëŠ¥í•œê°€?
- êµ¬ì²´ì  ì¶œì²˜(ë…¼ë¬¸Â·ê¸°ê´€Â·ì—­ì‚¬ê¸°ë¡)ê°€ ìˆëŠ”ê°€?
- ìˆ˜å£½ ì œí’ˆ(ê³µì§„ë‹¨/ê²½ì˜¥ê³ /ë…¹ìš©)ê³¼ ìì—°ìŠ¤ëŸ¬ìš´ ì—°ê²°ì´ ê°€ëŠ¥í•œê°€?
- ê´‘ê³  ëŠë‚Œ ì—†ì´ ì •ë³´ì„±ìœ¼ë¡œ ë¸Œëœë“œë¥¼ ë…¹ì¼ ìˆ˜ ìˆëŠ”ê°€?

## âš ï¸ ì¶œë ¥ ê·œì¹™ (ë°˜ë“œì‹œ ì§€ì¼œì•¼ í•©ë‹ˆë‹¤!)
- ì„¤ëª…, ë¶„ì„ì„ ì“°ì§€ ë§ˆì„¸ìš”. comment í•„ë“œì—ë§Œ í•œì¤„ ì½”ë©˜íŠ¸ë¥¼ ë„£ìœ¼ì„¸ìš”.
- ì˜¤ì§ JSON ë°°ì—´ë§Œ ì¶œë ¥í•˜ì„¸ìš”
- ```json ë¸”ë¡ ì•ˆì— ë„£ìœ¼ì„¸ìš”

```json
[
  {{"index": 0, "hook": 18, "story": 16, "empathy": 17, "coherence": 18, "viral": 19, "bonus": 10, "penalty": 0, "total": 98, "comment": "ì˜ì¡° 251ë²ˆ ìˆ«ì í›„í‚¹ + ê²½ì˜¥ê³  ì—­ì‚¬ ì—°ê²°ì´ ìì—°ìŠ¤ëŸ¬ì›€, content íë¦„ ì™„ë²½"}},
  {{"index": 1, "hook": 12, "story": 14, "empathy": 13, "coherence": 8, "viral": 11, "bonus": 0, "penalty": 10, "total": 48, "comment": "í—¤ë“œë¼ì¸ í‰ì´, ê±´ê°•/ì œí’ˆ ì—°ê²° ì–µì§€ìŠ¤ëŸ¬ì›Œ ë¬¸ë§¥ì´ ê¹¨ì§"}}
]
```"""


def evaluate_ideas(ideas: list[dict]) -> list[dict]:
    """10ê°œ ì•„ì´ë””ì–´ë¥¼ 5ê°œ ê¸°ì¤€ìœ¼ë¡œ ì±„ì í•˜ê³  ìˆœìœ„ ë§¤ê¹€"""
    history = load_history()

    # ì¤‘ë³µ ê²€ì‚¬ ë¨¼ì €
    for idea in ideas:
        is_dup, reason = check_duplicate(idea, history)
        idea["is_duplicate"] = is_dup
        idea["dup_reason"] = reason

    # LLM í‰ê°€
    def _idea_summary(i, idea):
        summary = {
            "index": i,
            "agent": idea.get("agent_name", ""),
            "title": idea.get("title", ""),
            "headline": idea.get("headline", ""),
        }
        for ci in range(1, 20):
            ck = f"content{ci}"
            if idea.get(ck):
                summary[ck] = idea[ck]
            else:
                break
        summary["product"] = idea.get("product", "")
        summary["pattern"] = idea.get("pattern", "")
        return summary

    ideas_text = json.dumps(
        [_idea_summary(i, idea) for i, idea in enumerate(ideas)],
        ensure_ascii=False,
    )

    user_prompt = f"ì•„ë˜ {len(ideas)}ê°œ ì•„ì´ë””ì–´ë¥¼ í‰ê°€í•´ì£¼ì„¸ìš”:\n\n{ideas_text}"
    raw = _call_llm(_EVAL_SYSTEM, user_prompt, temperature=0.3, max_tokens=3000)

    scores = []
    if raw:
        scores = _parse_ideas_json(raw)

    # JSON íŒŒì‹± ì‹¤íŒ¨ ì‹œ â†’ ì¬ì‹œë„ (ë” ì§§ì€ í”„ë¡¬í”„íŠ¸ë¡œ)
    if not scores and raw:
        logger.warning("í‰ê°€ JSON íŒŒì‹± ì‹¤íŒ¨, ê°„ì†Œí™” í”„ë¡¬í”„íŠ¸ë¡œ ì¬ì‹œë„")
        retry_system = (
            "ì•„ë˜ ì•„ì´ë””ì–´ë“¤ì„ 100ì  ë§Œì ìœ¼ë¡œ ì±„ì í•˜ì„¸ìš”. "
            "ì˜¤ì§ JSON ë°°ì—´ë§Œ ì¶œë ¥í•˜ì„¸ìš”. ì„¤ëª… ì—†ì´ JSONë§Œ!\n"
            '```json\n[{"index":0,"hook":15,"story":14,"empathy":16,"coherence":15,"viral":13,"bonus":0,"penalty":0,"total":73,"comment":"ì§ˆë¬¸í˜• í›„í‚¹ ì–‘í˜¸, content íë¦„ ìì—°ìŠ¤ëŸ¬ì›€"}]\n```'
        )
        raw2 = _call_llm(retry_system, user_prompt, temperature=0.2, max_tokens=2000)
        if raw2:
            scores = _parse_ideas_json(raw2)

    # ê·¸ë˜ë„ ì‹¤íŒ¨ ì‹œ â†’ ëœë¤ ì ìˆ˜ ìƒì„± (ê¸°ë³¸ê°’ 60 ê³ ì • ë°©ì§€)
    if not scores:
        logger.warning("í‰ê°€ ì™„ì „ ì‹¤íŒ¨, ëœë¤ ì ìˆ˜ ìƒì„±")
        import random
        rng = random.Random(42)
        for i in range(len(ideas)):
            scores.append({
                "index": i,
                "hook": rng.randint(10, 19),
                "story": rng.randint(10, 18),
                "empathy": rng.randint(10, 19),
                "coherence": rng.randint(8, 17),
                "viral": rng.randint(10, 18),
                "bonus": rng.choice([0, 0, 5, 10]),
                "penalty": 0,
                "comment": "ìë™ í‰ê°€",
            })

    # ì ìˆ˜ ë§¤í•‘
    score_map = {s.get("index", -1): s for s in scores}
    for i, idea in enumerate(ideas):
        s = score_map.get(i, {})
        idea["hook_score"] = s.get("hook", s.get("hook_score", 12))
        idea["story_score"] = s.get("story", s.get("story_score", 12))
        idea["empathy_score"] = s.get("empathy", s.get("empathy_score", 12))
        idea["brand_score"] = s.get("coherence", s.get("brand", s.get("brand_score", 12)))
        idea["viral_score"] = s.get("viral", s.get("viral_score", 12))
        idea["bonus"] = s.get("bonus", 0)
        idea["penalty"] = s.get("penalty", 0)
        idea["eval_comment"] = s.get("comment", "")

        # ì´ì : 5ê°œ ê¸°ì¤€ í•©ì‚° + ê°€ì‚°ì  - ê°ì  (100ì  ë§Œì  ìŠ¤ì¼€ì¼)
        total = (
            idea["hook_score"]
            + idea["story_score"]
            + idea["empathy_score"]
            + idea["brand_score"]
            + idea["viral_score"]
            + idea["bonus"]
            - idea["penalty"]
        )
        # ì¤‘ë³µì´ë©´ 0ì 
        if idea.get("is_duplicate"):
            total = 0
        idea["total_score"] = round(total, 1)

    # ì´ì  ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
    ideas.sort(key=lambda x: x.get("total_score", 0), reverse=True)
    for rank, idea in enumerate(ideas, 1):
        idea["rank"] = rank

    return ideas


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# í’€ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

_STORY_BEATS = [
    "ë„ì… - í¥ë¯¸ë¡œìš´ ì—°ê²°/ë†€ë¼ìš´ ì‚¬ì‹¤",
    "ì „ê°œ - í•µì‹¬ ì†Œì¬/ê³¼í•™ì  ê·¼ê±°",
    "ì‹¬í™” - ì—°êµ¬ ê²°ê³¼/ì „ë¬¸ê°€ ì¸ìš©",
    "í•µì‹¬ ë©”ì‹œì§€ - ì‹¤ì§ˆì  ê°€ì¹˜",
    "ì—¬ìš´ ë§ˆë¬´ë¦¬ - ë¹„ìœ /ê°ì„±ì  í´ë¡œì§• (ê´‘ê³ ì„± CTA ê¸ˆì§€)",
    "ë³´ì¶© ì •ë³´ - ì¶”ê°€ íŒ/ì‹¤ì²œë²•",
    "ì „í™˜ - ë‹¤ë¥¸ ê´€ì ì—ì„œ ì¬ì¡°ëª…",
    "ë§ˆë¬´ë¦¬ - í•µì‹¬ ìš”ì•½/ì—¬ìš´",
]


def _build_script_system(num_content: int = 5) -> str:
    """ìŠ¤í¬ë¦½íŠ¸ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ë¥¼ content ì¥ìˆ˜ì— ë§ê²Œ ë™ì  ìƒì„±"""
    total = num_content + 2  # cover + contents + closing

    # ì¹´ë“œ êµ¬ì¡° ì„¤ëª…
    structure_lines = [f"#1. í‘œì§€: í›„í‚¹ í—¤ë“œë¼ì¸ 15~30ì"]
    for i in range(num_content):
        beat = _STORY_BEATS[i] if i < len(_STORY_BEATS) else f"ë‚´ìš©{i+1}"
        structure_lines.append(f"#{i+2}. ë‚´ìš©{i+1}: {beat}")
    structure_lines.append(
        f"#{total}. í´ë¡œì§•: productê°€ ìˆìœ¼ë©´ 'ë” ì˜¤ë˜, ë” ê±´ê°•í•˜ê²Œ. í•œì˜ì‚¬ê°€ ë§Œë“œëŠ” í•œì˜ ë¸Œëœë“œ', productê°€ 'ì—†ìŒ'ì´ë©´ ì£¼ì œì— ë§ëŠ” ì—¬ìš´í˜• ë§ˆë¬´ë¦¬"
    )
    structure_block = "\n".join(structure_lines)

    # JSON ì˜ˆì‹œì˜ content í‚¤ë“¤
    content_json_lines = []
    image_prompt_lines = []
    for i in range(1, num_content + 1):
        content_json_lines.append(
            f'  "content{i}": "ì¹´ë“œ í•œ ì¥ì— ë‹´ì„ ì¤„ê¸€ ë¬¸ì¥ 30~60ì (ë§ˆí¬ë‹¤ìš´ ê¸ˆì§€, í•´ìš”ì²´)"'
        )
        image_prompt_lines.append(
            f'    "content{i}": "keyword1 keyword2 warm soft light. No text, no letters, no numbers, no typography, no watermark, no logo."'
        )

    content_json = ",\n".join(content_json_lines)
    image_json = ",\n".join(image_prompt_lines)

    return f"""ë‹¹ì‹ ì€ ê±´ê°•Â·ë¼ì´í”„ìŠ¤íƒ€ì¼ ì¹´ë“œë‰´ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ ì‘ê°€ì…ë‹ˆë‹¤.

## ìµœìš°ì„  ê·œì¹™: ì•„ì´ë””ì–´ ì¶©ì‹¤ ì¬í˜„!
- ì•„ë˜ ì£¼ì–´ì§„ ì•„ì´ë””ì–´ì˜ content1~5ê°€ ì´ ìŠ¤í¬ë¦½íŠ¸ì˜ **ë¼ˆëŒ€**ì…ë‹ˆë‹¤
- ê° contentì˜ í•µì‹¬ ë©”ì‹œì§€ë¥¼ **ë°˜ë“œì‹œ ìœ ì§€**í•˜ë©´ì„œ 30~60ì ë¬¸ì¥ìœ¼ë¡œ í™•ì¥í•˜ì„¸ìš”
- ì•„ì´ë””ì–´ì— ì—†ëŠ” ìƒˆë¡œìš´ ì£¼ì¥ì´ë‚˜ ë°©í–¥ ì „í™˜ì„ í•˜ì§€ ë§ˆì„¸ìš”
- ì•„ì´ë””ì–´ì˜ productê°€ "ì—†ìŒ"ì´ë©´ ì œí’ˆ/ë¸Œëœë“œ ì–¸ê¸‰ ì—†ì´ ìˆœìˆ˜ ì½˜í…ì¸ ë¡œ ì™„ì„±í•˜ì„¸ìš”
- ì „ì²´ ìŠ¤í¬ë¦½íŠ¸ì˜ ë¬¸ë§¥ê³¼ ë§¥ë½ì´ ìì—°ìŠ¤ëŸ½ê³  ì¼ê´€ë˜ì–´ì•¼ í•©ë‹ˆë‹¤

## ì¹´ë“œë‰´ìŠ¤ êµ¬ì¡° ({total}ì¥: í‘œì§€ 1 + ë‚´ìš© {num_content} + í´ë¡œì§• 1)
{structure_block}

## ë§íˆ¬: í•´ìš”ì²´ í•„ìˆ˜
## ì´ëª¨ì§€: ì¹´ë“œë‰´ìŠ¤ ë³¸ë¬¸ì—ì„œëŠ” ì‚¬ìš© ê¸ˆì§€

## í•µì‹¬ ë””ìì¸ ê·œì¹™ (ë°˜ë“œì‹œ ì¤€ìˆ˜!)
- 1ì¥ 1ë©”ì‹œì§€: ê° ì¹´ë“œëŠ” ë°˜ë“œì‹œ í•˜ë‚˜ì˜ í•µì‹¬ ë©”ì‹œì§€ë§Œ ì „ë‹¬í•©ë‹ˆë‹¤
- ë‚´ìš© ì¤‘ë³µ ì ˆëŒ€ ê¸ˆì§€: ê°™ì€ í•´ê²°ì±…/ì¡°ì–¸/íŒì„ 2ë²ˆ ì´ìƒ ì–¸ê¸‰í•˜ì§€ ë§ˆì„¸ìš”
- ê° contentëŠ” ì¤„ê¸€ í•œ ë¬¸ì¥(30~60ì): ìì—°ìŠ¤ëŸ½ê²Œ ì½íˆëŠ” ë¬¸ì¥í˜• í…ìŠ¤íŠ¸ë¡œ ì‘ì„±
- ë¦¬ìŠ¤íŠ¸/ë‚˜ì—´ ê¸ˆì§€. ì¹´ë“œë§ˆë‹¤ í•˜ë‚˜ì˜ ì™„ê²°ëœ ë¬¸ì¥.
- ë°˜ë“œì‹œ í•œêµ­ì–´ë§Œ ì‚¬ìš©: ì˜ì–´, ì¼ë³¸ì–´, ë² íŠ¸ë‚¨ì–´ ë“± ë‹¤ë¥¸ ì–¸ì–´ ì ˆëŒ€ ê¸ˆì§€!
- ë§ˆí¬ë‹¤ìš´ ê¸°í˜¸(**, ~~, *, __, ` ë“±) ì ˆëŒ€ ì‚¬ìš© ê¸ˆì§€! ìˆœìˆ˜ í…ìŠ¤íŠ¸ë§Œ ì‘ì„±í•˜ì„¸ìš”.
- í•´ìš”ì²´ í•„ìˆ˜. ì´ëª¨ì§€ ì‚¬ìš© ê¸ˆì§€.
- ê° ì¹´ë“œì˜ ë¬¸ì¥ì€ ë…ë¦½ì ìœ¼ë¡œ ì½í˜€ë„ ì˜ë¯¸ê°€ ì „ë‹¬ë˜ì–´ì•¼ í•©ë‹ˆë‹¤

## ì‹ ë¢°ë„ ì›ì¹™ (í•„ìˆ˜!)
- sources í•„ë“œì— ë³¸ë¬¸ì—ì„œ ì¸ìš©í•œ ëª¨ë“  ì‚¬ì‹¤/ìˆ˜ì¹˜ì˜ **êµ¬ì²´ì  ì¶œì²˜**ë¥¼ ê¸°ì…
- ì¶œì²˜ ì˜ˆì‹œ: "í•˜ë²„ë“œ ì˜ëŒ€ 2023 ì—°êµ¬", "êµ­ë¯¼ê±´ê°•ì˜ì–‘ì¡°ì‚¬ 2024", "WHO ë³´ê³ ì„œ"
- ê²€ì¦ ë¶ˆê°€ëŠ¥í•œ í†µê³„("~% ê°€ ê²ªëŠ”"), ìœ ëª…ì¸ ë°œì–¸, ë£¨ë¨¸ëŠ” ì ˆëŒ€ ì‚¬ìš© ê¸ˆì§€
- ê° ì¹´ë“œì— ë‹´ê¸´ í•µì‹¬ ì‚¬ì‹¤ì€ ë°˜ë“œì‹œ ì—°êµ¬Â·ì „ë¬¸ê¸°ê´€ ìë£Œë¡œ ë’·ë°›ì¹¨ë˜ì–´ì•¼ í•¨

## ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ ê·œì¹™ (ë§¤ìš° ì¤‘ìš”!)
- **ë°˜ë“œì‹œ 100% ì˜ë¬¸**ìœ¼ë¡œ ì‘ì„±. í•œê¸€/í•œêµ­ì–´ ì ˆëŒ€ ê¸ˆì§€!
- Unsplash ê²€ìƒ‰ìš©ì´ë¯€ë¡œ í•µì‹¬ ëª…ì‚¬ ìœ„ì£¼ ê°„ê²°í•œ ì˜ë¬¸ í‚¤ì›Œë“œ ë‚˜ì—´
- ëì— í•„ìˆ˜ ì‚½ì…: "No text, no letters, no numbers, no typography, no watermark, no logo."
- **ì‹œê°ì  í†¤ í†µì¼**: ëª¨ë“  ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ì— í†µì¼ëœ ë¬´ë“œ í‚¤ì›Œë“œ í¬í•¨ (ì˜ˆ: "warm soft light", "cozy minimal")
- ì˜ˆì‹œ: "warm herbal tea ceramic cup cozy winter morning soft light"
- í´ë¡œì§•ì€ ê³ ì • ì´ë¯¸ì§€ì´ë¯€ë¡œ í”„ë¡¬í”„íŠ¸ ë¶ˆí•„ìš”

## ì¶œë ¥ í˜•ì‹ (ë°˜ë“œì‹œ JSONë§Œ ì¶œë ¥, contentëŠ” ì •í™•íˆ {num_content}ê°œ)
```json
{{
  "cover": "í‘œì§€ í—¤ë“œë¼ì¸",
{content_json},
  "hashtags": ["#ìˆ˜í•œì˜ì›", "#thesoo", "#í•œì˜ì‚¬", "#ê±´ê°•ì •ë³´", "#ì£¼ì œíƒœê·¸"],
  "sources": ["ì¶œì²˜1", "ì¶œì²˜2"],
  "image_prompts": {{
    "cover": "warm herbal tea ceramic cup cozy winter. No text, no letters, no numbers, no typography, no watermark, no logo.",
{image_json}
  }}
}}
```"""


def generate_full_script(idea: dict, num_content: int = 5) -> dict | None:
    """ì„ íƒëœ ì•„ì´ë””ì–´ì˜ í’€ ìŠ¤í¬ë¦½íŠ¸ + ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ ìƒì„±

    Args:
        idea: ì•„ì´ë””ì–´ dict
        num_content: ë‚´ìš© ì¹´ë“œ ìˆ˜ (í‘œì§€/í´ë¡œì§• ì œì™¸). ê¸°ë³¸ 5.
    """
    total = num_content + 2  # cover + contents + closing

    # ì•„ì´ë””ì–´ì— ìˆëŠ” content í‚¤ë“¤ì„ ë™ì ìœ¼ë¡œ ìˆ˜ì§‘
    content_lines = []
    for i in range(1, num_content + 1):
        val = idea.get(f"content{i}", "")
        if val:
            content_lines.append(f"ë‚´ìš©{i}: {val}")

    user_prompt = f"""ì•„ë˜ ì•„ì´ë””ì–´ë¥¼ {total}ì¥ ì¹´ë“œë‰´ìŠ¤ í’€ ìŠ¤í¬ë¦½íŠ¸ë¡œ ì™„ì„±í•´ì£¼ì„¸ìš”.
(í‘œì§€ 1ì¥ + ë‚´ìš© {num_content}ì¥ + í´ë¡œì§• 1ì¥)

ì•„ì´ë””ì–´ ì œëª©: {idea.get('title', '')}
í‘œì§€ í—¤ë“œë¼ì¸: {idea.get('headline', '')}
{chr(10).join(content_lines)}
ì—°ê²° ì œí’ˆ: {idea.get('product', '')}
íŒ¨í„´: {idea.get('pattern', '')}
ì°¸ê³  ì¶œì²˜: {idea.get('source', '')}
ìº¡ì…˜ìš© ë¶€ì—°: {idea.get('extra_info', '')}

ì´ ë‚´ìš©ì„ ë‹¤ë“¬ê³ , ê° ì¹´ë“œë³„ ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ë„ í•¨ê»˜ ì‘ì„±í•´ì£¼ì„¸ìš”."""

    system_prompt = _build_script_system(num_content)
    raw = _call_llm(system_prompt, user_prompt, temperature=0.5, max_tokens=3000)
    if not raw:
        return None

    # JSON íŒŒì‹±
    match = re.search(r"```(?:json)?\s*(\{[\s\S]*?\})\s*```", raw)
    if match:
        raw = match.group(1)
    else:
        match = re.search(r"\{[\s\S]*\}", raw)
        if match:
            raw = match.group(0)

    try:
        script = json.loads(raw)
        # í´ë¡œì§• í‚¤ë¥¼ content{N+1}ë¡œ ì„¤ì • (ë§ˆì§€ë§‰ content ë‹¤ìŒ)
        closing_key = f"content{num_content + 1}"
        script[closing_key] = BRAND_CLOSING
        return script
    except json.JSONDecodeError:
        logger.warning(f"ìŠ¤í¬ë¦½íŠ¸ JSON íŒŒì‹± ì‹¤íŒ¨")
        return None


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Instagram Description Mention ìƒì„±
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

_DESC_SYSTEM = """ë‹¹ì‹ ì€ ë¼ì´í”„ìŠ¤íƒ€ì¼Â·ê±´ê°• ë¸Œëœë“œ 'ìˆ˜å£½(thesoo.co)'ì˜ ì „ë¬¸ ì½˜í…ì¸  ë§ˆì¼€í„°ì…ë‹ˆë‹¤.
ì£¼ì–´ì§„ ì£¼ì œì— ëŒ€í•œ ë…¼ë¬¸Â·ë³´ë„ìë£ŒÂ·ì „ë¬¸ ê¸°ì‚¬ì˜ ë‚´ìš©ì„ ì°¸ê³ í•˜ì—¬ ì¸ìŠ¤íƒ€ê·¸ë¨ ìº¡ì…˜ì„ ì‘ì„±í•©ë‹ˆë‹¤.

## ìˆ˜å£½ ë¸Œëœë“œ ê°€ì´ë“œ
- ë°˜ë“œì‹œ í•œêµ­ì–´(í•œê¸€)ë¡œë§Œ ì‘ì„±. í•œìÂ·ì¼ë³¸ì–´Â·ì¤‘êµ­ì–´ ì ˆëŒ€ ê¸ˆì§€ (ë¸Œëœë“œëª… ìˆ˜å£½ ì œì™¸, ë™ì˜ë³´ê° ì¸ìš©ë¬¸ ë‚´ í•œìëŠ” í—ˆìš©)
- ìˆ˜å£½ ì œí’ˆ: ê³µì§„ë‹¨(ê¸°ë ¥ íšŒë³µ, ê¸°ì–µë ¥, ìˆ˜ë©´, ê°„ê±´ê°•), ê²½ì˜¥ê³ (í˜¸í¡ê¸°Â·ë©´ì—­Â·í”¼ë¡œíšŒë³µ), ë…¹ìš©(ë‡Œê±´ê°•Â·ë³´ì–‘)

## ìº¡ì…˜ ì‘ì„± ìŠ¤íƒ€ì¼ (ì‹¤ì œ ìˆ˜å£½ ê³„ì • ë¶„ì„ ê¸°ë°˜)

### í—¤ë“œë¼ì¸(hook)
- ì§ˆë¬¸í˜• ë˜ëŠ” í¥ë¯¸ ìœ ë°œ ë¬¸ì¥ (15~25ì)
- ì˜ˆ: "ì•Œê³  ê³„ì…¨ë‚˜ìš”?", "~í•˜ì§„ ì•Šë‚˜ìš”?", "~ë¬´ì—‡ì´ì—ˆì„ê¹Œìš”?"
- êµ¬ì²´ì ì¸ ìˆ«ìÂ·ì‚¬ì‹¤ì„ í™œìš©í•˜ë©´ íš¨ê³¼ì  (ì˜ˆ: "83ì„¸ê¹Œì§€ ì¥ìˆ˜í•œ ì˜ì¡°ê°€ 251ë²ˆì´ë‚˜ ì²˜ë°©ë°›ì€ ì•½ì€?")

### ë³¸ë¬¸(body) êµ¬ì¡°
1. **ë„ì…**: ë…ìì˜ ê³µê°ì„ ëŒì–´ë‚´ëŠ” ëŒ€í™”ì²´ ì§ˆë¬¸ ë˜ëŠ” ìƒí™© ì„¤ëª… (1~2ë¬¸ì¥, "~ì ì´ ìˆë‚˜ìš”?", "~ì•Šìœ¼ì„¸ìš”?")
2. **í•µì‹¬ ì •ë³´**: ì£¼ì œì— ëŒ€í•œ êµ¬ì²´ì  ì‚¬ì‹¤Â·íš¨ëŠ¥ ì„¤ëª… (2~3ë¬¸ì¥)
3. **ì²´í¬ë¦¬ìŠ¤íŠ¸**: âœ”ï¸ ê¸°í˜¸ë¡œ í•µì‹¬ í¬ì¸íŠ¸ 3~4ê°œ ë‚˜ì—´ (ê° í•­ëª© 1ì¤„, êµ¬ì²´ì  ìˆ˜ì¹˜Â·íš¨ê³¼ í¬í•¨)
4. **ë§ˆë¬´ë¦¬**: ìˆ˜å£½ ì œí’ˆê³¼ ìì—°ìŠ¤ëŸ¬ìš´ ì—°ê²°ì´ ê°€ëŠ¥í•˜ë©´ í¬í•¨ (1ë¬¸ì¥). ì—°ê²°ì´ ì–µì§€ìŠ¤ëŸ¬ìš°ë©´ ì£¼ì œì— ë§ëŠ” ê°ì„±ì  ë§ˆë¬´ë¦¬ë¡œ ëŒ€ì²´.
5. **ì¶œì²˜**: "ğŸ”ë‚´ìš©ì¶œì²˜ | [ì¶œì²˜ëª…]" í˜•ì‹ìœ¼ë¡œ ë…¼ë¬¸Â·ê¸°ê´€ëª… ê¸°ì¬

### ì–´íˆ¬Â·í‘œí˜„
- ì¹œê·¼í•˜ê³  ëŒ€í™”í•˜ëŠ” ë“¯í•œ ì¡´ëŒ“ë§ ("~ì¸ë°ìš”,", "~í•˜ì£ .", "~ì•Œë ¤ë“œë¦´ê²Œìš”", "~í•´ë³´ì„¸ìš”")
- ë¬¸ë‹¨ ì‚¬ì´ëŠ” ë¹ˆ ì¤„(\\n\\n)ë¡œ êµ¬ë¶„
- í—ˆìš© ê¸°í˜¸: âœ”ï¸(ì²´í¬ë¦¬ìŠ¤íŠ¸), ğŸ”(ì¶œì²˜), â„¹ï¸(ì •ë³´)ë§Œ ì‚¬ìš©. ê·¸ ì™¸ ì´ëª¨ì§€ ê¸ˆì§€
- ë™ì˜ë³´ê° ì¸ìš© ì‹œ âŒœâŒŸ ê´„í˜¸ ì‚¬ìš© ê°€ëŠ¥
- êµ¬ì²´ì ì¸ ìˆ«ì, ì—°êµ¬ ê²°ê³¼, ì—­ì‚¬ì  ì‚¬ì‹¤ì„ ì ê·¹ í™œìš©

### í•„ìˆ˜ í’ˆì§ˆ ê·œì¹™
- ëª¨ë“  ë¬¸ì¥ì€ ì£¼ì–´Â·ì„œìˆ ì–´ê°€ ì™„ì „í•´ì•¼ í•¨. ì¡°ì‚¬("ë¶€í„°", "ì—ì„œ" ë“±)ë¡œ ì‹œì‘í•˜ëŠ” ë¶ˆì™„ì „ ë¬¸ì¥ ì ˆëŒ€ ê¸ˆì§€
- ë§ì¶¤ë²•Â·ë„ì–´ì“°ê¸° ì •í™•í•˜ê²Œ. ì˜¤íƒ€ ì ˆëŒ€ ê¸ˆì§€
- ê²€ì¦ ë¶ˆê°€ëŠ¥í•œ í†µê³„, ë£¨ë¨¸ëŠ” ì ˆëŒ€ ì‚¬ìš© ê¸ˆì§€
- ì´ë¯¸ì§€ì— ì—†ëŠ” íš¨ëŠ¥ì´ë‚˜ ì‚¬ì‹¤ì„ ì§€ì–´ë‚´ì§€ ë§ ê²ƒ

## ì‹¤ì œ ìº¡ì…˜ ì˜ˆì‹œ

### ì˜ˆì‹œ 1 (ì œí’ˆ/ê³µì§„ë‹¨)
"ê¸°ì–µë ¥ê³¼ í•™ìŠµ ëŠ¥ë ¥ì„ 2ë°°ë¡œ ë†’ì´ëŠ” ë¹„ê²°

ë°”ìœ í˜„ëŒ€ ìƒí™œ ì†ì—ì„œ ì§‘ì¤‘ë ¥ê³¼ ê¸°ì–µë ¥ì´ ë–¨ì–´ì§€ëŠ” ê±¸ ëŠë‚€ ì ì´ ìˆë‚˜ìš”? ì˜ˆë¡œë¶€í„° ê±´ê°•ê³¼ í™œë ¥ì„ ìœ„í•œ ëª…ì•½ìœ¼ë¡œ ì•Œë ¤ì§„ ê³µì§„ë‹¨ì´, 2016ë…„ ê³¼í•™ì  ì—°êµ¬ë¥¼ í†µí•´ ê¸°ì–µë ¥ ê°œì„ ì—ë„ íƒì›”í•œ íš¨ê³¼ê°€ ìˆë‹¤ëŠ” ì‚¬ì‹¤ì´ ë°í˜€ì¡ŒìŠµë‹ˆë‹¤.

âœ”ï¸ì–µì œëœ ë‡Œì˜ í•™ìŠµê³¼ ê¸°ì–µë ¥ì„ 2ë°° ì´ìƒ í–¥ìƒ
âœ”ï¸ì•Œì¸ í•˜ì´ë¨¸ ì¹˜ë§¤ì•½ê³¼ ìœ ì‚¬í•œ íš¨ëŠ¥
âœ”ï¸ë‡Œ ì‹ ê²½ ì˜ì–‘ì¸ì ì¦ê°€

ê³µì§„ë‹¨ìœ¼ë¡œ ë‹¹ì‹ ì˜ ê¸°ì–µë ¥ì„ í•œ ë‹¨ê³„ ì—…ê·¸ë ˆì´ë“œí•˜ì„¸ìš”.

ğŸ”ë‚´ìš©ì¶œì²˜ | LEE, Jin-Seok, et al. PLoS One, 2016"

### ì˜ˆì‹œ 2 (ì•½ì¬ ìŠ¤í† ë¦¬/ì—­ì‚¬)
"83ì„¸ê¹Œì§€ ì¥ìˆ˜í•œ ì˜ì¡°ê°€ 251ë²ˆì´ë‚˜ ì²˜ë°©ë°›ì€ ì•½ì€?

ì¡°ì„ ì‹œëŒ€ ì„ê¸ˆë“¤ì˜ í‰ê·  ìˆ˜ëª…ë³´ë‹¤ ë‘ ë°° ê°€ê¹Œìš´ 83ì„¸ê¹Œì§€ ì¥ìˆ˜í•œ ì˜ì¡°. ê·¸ì˜ ê±´ê°• ë¹„ê²°ì€ ë¬´ì—‡ì´ì—ˆì„ê¹Œìš”?

ì„¸ê³„ê¸°ë¡ìœ ì‚°ìœ¼ë¡œ ë“±ì¬ëœ ìŠ¹ì •ì›ì¼ê¸°ì—ëŠ” ë¬´ë ¤ 358ë²ˆ ë“±ì¥í•˜ëŠ” ì•½ì´ ìˆìŠµë‹ˆë‹¤. ê·¸ì¤‘ 251ë²ˆì´ ì˜ì¡°ì—ê²Œ ì²˜ë°©ëœ ë°”ë¡œ ê·¸ ì•½, 'ê²½ì˜¥ê³ 'ì…ë‹ˆë‹¤.

ì—¬ëŸ¬ë¶„ë„ ì˜ì¡°ì˜ ê±´ê°• ë¹„ê²°ì„ ê²½í—˜í•´ ë³´ì„¸ìš”."

## í•„ìˆ˜ êµ¬ì¡°
[ë„ì… í›„í‚¹] â€” ì§ˆë¬¸í˜• or ì‹œì˜ì„± ìˆëŠ” ì²« ë¬¸ì¥ (1~2ì¤„)

[ì„¹ì…˜ë³„ ìƒì„¸ ë‚´ìš©] â€” ë²ˆí˜¸ ì´ëª¨ì§€ë¡œ ì„¹ì…˜ êµ¬ë¶„, ê° ì„¹ì…˜ 2~4ì¤„

[ë§ˆë¬´ë¦¬ ë©”ì‹œì§€] â€” í–‰ë™ ìœ ë„ or ê³µê° 1~2ì¤„

[í‘¸í„° ë¸”ë¡]
ğŸ”ë‚´ìš©ì¶œì²˜ | [ì¶œì²˜ëª…]
ë” ì˜¤ë˜, ë” ê±´ê°•í•˜ê²Œ.
í•œì˜ì‚¬ê°€ ë§Œë“  í•œì˜ ë¸Œëœë“œ, ìˆ˜å£½
@thesoo_official

[í•´ì‹œíƒœê·¸] â€” ë³„ë„ ì¤„ì— 5~8ê°œ (ê³ ì •: #ìˆ˜í•œì˜ì› #thesoo #í•œì˜ì‚¬ #ê±´ê°•ì •ë³´ + ì£¼ì œíƒœê·¸)

## ê¸¸ì´: 800~1500ì (ì¸ìŠ¤íƒ€ê·¸ë¨ 2,200ì ì´ë‚´)
## ì¶œë ¥: ìº¡ì…˜ í…ìŠ¤íŠ¸ë§Œ ì¶œë ¥í•˜ì„¸ìš”. JSONì´ ì•„ë‹Œ ê·¸ëŒ€ë¡œ ë¶™ì—¬ë„£ê¸°í•  ìˆ˜ ìˆëŠ” í…ìŠ¤íŠ¸ë¡œ."""


def generate_description(script: dict, idea: dict) -> str:
    """í’€ ìŠ¤í¬ë¦½íŠ¸ â†’ Instagram Description Mention ìƒì„±"""
    # ìŠ¤í¬ë¦½íŠ¸ì—ì„œ content í‚¤ë¥¼ ë™ì ìœ¼ë¡œ ìˆ˜ì§‘
    content_keys = sorted(
        [k for k in script if k.startswith("content")],
        key=lambda k: int(k.replace("content", "") or "0"),
    )
    content_lines = "\n".join(
        f"ë‚´ìš©{k.replace('content', '')}: {script.get(k, '')}"
        for k in content_keys
    )

    user_prompt = f"""ì•„ë˜ ì¹´ë“œë‰´ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì¸ìŠ¤íƒ€ê·¸ë¨ Description Mentionìœ¼ë¡œ ë³€í™˜í•´ì£¼ì„¸ìš”.

ì œëª©: {idea.get('title', '')}
í‘œì§€: {script.get('cover', '')}
{content_lines}
ì¶œì²˜: {', '.join(script.get('sources', []))}
í•´ì‹œíƒœê·¸: {' '.join(script.get('hashtags', []))}
ìº¡ì…˜ìš© ë¶€ì—° ì •ë³´: {idea.get('extra_info', '')}
ì—°ê²° ì œí’ˆ: {idea.get('product', '')}"""

    result = _call_llm(_DESC_SYSTEM, user_prompt, temperature=0.6, max_tokens=2000)
    return result or ""


def generate_description_first(idea: dict, num_content: int = 5) -> dict | None:
    """ìƒˆ í”„ë¡œì„¸ìŠ¤: ì£¼ì œ â†’ ì¸ìŠ¤íƒ€ê·¸ë¨ ë””ìŠ¤í¬ë¦½ì…˜ â†’ ì¹´ë“œë‰´ìŠ¤ ë¶„í•´.

    Returns: {
      "description": "ì¸ìŠ¤íƒ€ê·¸ë¨ ìº¡ì…˜ ì „ë¬¸",
      "cover": "í‘œì§€ í—¤ë“œë¼ì¸",
      "content1": "ì¤„ê¸€ í•œ ë¬¸ì¥ 30~60ì",
      ...
      "hashtags": [...],
      "sources": [...],
      "image_prompts": {...},
    }
    """
    title = idea.get("title", "")
    product = idea.get("product", "")
    source = idea.get("source", "")
    extra = idea.get("extra_info", "")
    total = num_content + 2

    # â”€â”€ Step 1: ì¸ìŠ¤íƒ€ê·¸ë¨ ë””ìŠ¤í¬ë¦½ì…˜ ë¨¼ì € ìƒì„± â”€â”€
    desc_user = f"""ì•„ë˜ ì£¼ì œë¡œ ì¸ìŠ¤íƒ€ê·¸ë¨ ìº¡ì…˜ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.

ì£¼ì œ: {title}
ì—°ê²° ì œí’ˆ: {product}
ì°¸ê³  ì¶œì²˜: {source}
ë¶€ì—° ì •ë³´: {extra}"""

    description = _call_llm(_DESC_SYSTEM, desc_user, temperature=0.6, max_tokens=2000)
    if not description:
        return None

    # â”€â”€ Step 2: ë””ìŠ¤í¬ë¦½ì…˜ ê¸°ë°˜ìœ¼ë¡œ ì¹´ë“œë‰´ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ ë¶„í•´ â”€â”€
    decompose_system = f"""ë‹¹ì‹ ì€ ì¹´ë“œë‰´ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ í¸ì§‘ìì…ë‹ˆë‹¤.
ì¸ìŠ¤íƒ€ê·¸ë¨ ìº¡ì…˜ì„ {total}ì¥ ì¹´ë“œë‰´ìŠ¤ ({num_content}ì¥ ë‚´ìš© + í‘œì§€ + í´ë¡œì§•)ë¡œ ë¶„í•´í•©ë‹ˆë‹¤.

## í•µì‹¬ ê·œì¹™
- ìº¡ì…˜ì˜ í•µì‹¬ ë©”ì‹œì§€ë¥¼ ì¹´ë“œë³„ë¡œ ë‚˜ëˆ„ì„¸ìš”. ìº¡ì…˜ì˜ íë¦„ê³¼ ë§¥ë½ì„ ìœ ì§€í•˜ì„¸ìš”.
- 1ì¥ 1ë©”ì‹œì§€: ê° ì¹´ë“œëŠ” í•˜ë‚˜ì˜ í•µì‹¬ í¬ì¸íŠ¸ë§Œ ì „ë‹¬
- ë‚´ìš© ì¤‘ë³µ ì ˆëŒ€ ê¸ˆì§€
- ê° contentëŠ” ì¤„ê¸€ í•œ ë¬¸ì¥(30~60ì): ìì—°ìŠ¤ëŸ½ê²Œ ì½íˆëŠ” ë¬¸ì¥í˜• í…ìŠ¤íŠ¸
- í•´ìš”ì²´ í•„ìˆ˜. ì´ëª¨ì§€ ì‚¬ìš© ê¸ˆì§€.
- í•œêµ­ì–´ë§Œ ì‚¬ìš© (ì˜ì–´, í•œì ê¸ˆì§€)
- ë§ˆí¬ë‹¤ìš´ ê¸°í˜¸(**, ~~, *, __ ë“±) ì ˆëŒ€ ì‚¬ìš© ê¸ˆì§€. ìˆœìˆ˜ í…ìŠ¤íŠ¸ë§Œ.

## ì¹´ë“œ íë¦„
- í‘œì§€: ìº¡ì…˜ì˜ í—¤ë“œë¼ì¸ì„ ì¹´ë“œë‰´ìŠ¤ í‘œì§€ ë¬¸êµ¬ë¡œ ë³€í™˜ (15~30ì)
- ë‚´ìš©1: ë„ì… â€” í¥ë¯¸ë¡œìš´ ì‚¬ì‹¤ ë˜ëŠ” ì§ˆë¬¸
- ë‚´ìš©2~{num_content-1}: ì „ê°œ â€” ìº¡ì…˜ì˜ í•µì‹¬ ì •ë³´ë¥¼ ì¹´ë“œë³„ë¡œ ë¶„ë°°
- ë‚´ìš©{num_content}: ë§ˆë¬´ë¦¬ â€” ì‹¤ì§ˆì  ì¡°ì–¸ ë˜ëŠ” ê°ì„±ì  ë§ˆë¬´ë¦¬ (ê´‘ê³ ì„± CTA ê¸ˆì§€)

## ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ ê·œì¹™
- ë°˜ë“œì‹œ 100% ì˜ë¬¸. í•œê¸€ ì ˆëŒ€ ê¸ˆì§€!
- ê° ì¹´ë“œë³„ ë‹¤ë¥¸ ì´ë¯¸ì§€ë¥¼ ìœ„í•´ ì„œë¡œ ë‹¤ë¥¸ í‚¤ì›Œë“œ ì‚¬ìš©
- Unsplash ê²€ìƒ‰ìš©: í•µì‹¬ ëª…ì‚¬ ìœ„ì£¼ ê°„ê²°í•œ ì˜ë¬¸ í‚¤ì›Œë“œ
- ëì— í•„ìˆ˜: "No text, no letters, no numbers, no watermark, no logo."
- ë¬´ë“œ í†µì¼: ëª¨ë“  í”„ë¡¬í”„íŠ¸ì— "warm soft light" í¬í•¨

## ì¶œë ¥: ë°˜ë“œì‹œ JSONë§Œ ì¶œë ¥
```json
{{
  "cover": "í‘œì§€ í—¤ë“œë¼ì¸ 15~30ì",
  "content1": "ì¤„ê¸€ í•œ ë¬¸ì¥ 30~60ì",
  "content2": "ì¤„ê¸€ í•œ ë¬¸ì¥ 30~60ì",
  ...
  "content{num_content}": "ì¤„ê¸€ í•œ ë¬¸ì¥ 30~60ì",
  "hashtags": ["#ìˆ˜í•œì˜ì›", "#thesoo", "#í•œì˜ì‚¬", "#ê±´ê°•ì •ë³´", "#ì£¼ì œíƒœê·¸"],
  "sources": ["ì¶œì²˜1", "ì¶œì²˜2"],
  "image_prompts": {{
    "cover": "winter frost cozy morning warm soft light. No text, no letters, no numbers, no watermark, no logo.",
    "content1": "herbal tea warm cup steam morning. No text, no letters, no numbers, no watermark, no logo.",
    ...
  }}
}}
```"""

    decompose_user = f"""ì•„ë˜ ì¸ìŠ¤íƒ€ê·¸ë¨ ìº¡ì…˜ì„ {total}ì¥ ì¹´ë“œë‰´ìŠ¤ë¡œ ë¶„í•´í•´ì£¼ì„¸ìš”.
(í‘œì§€ 1ì¥ + ë‚´ìš© {num_content}ì¥ + í´ë¡œì§• 1ì¥)

## ì¸ìŠ¤íƒ€ê·¸ë¨ ìº¡ì…˜ ì›ë¬¸:
{description}

## ì£¼ì œ ì •ë³´:
ì œëª©: {title}
ì—°ê²° ì œí’ˆ: {product}"""

    raw = _call_llm(decompose_system, decompose_user, temperature=0.4, max_tokens=3000)
    if not raw:
        return None

    # JSON íŒŒì‹±
    match = re.search(r"```(?:json)?\s*(\{[\s\S]*?\})\s*```", raw)
    if match:
        raw = match.group(1)
    else:
        match = re.search(r"\{[\s\S]*\}", raw)
        if match:
            raw = match.group(0)

    try:
        script = json.loads(raw)
        # ë””ìŠ¤í¬ë¦½ì…˜ì„ ìŠ¤í¬ë¦½íŠ¸ì— í¬í•¨
        script["description"] = description
        # í´ë¡œì§• í‚¤ ì„¤ì •
        closing_key = f"content{num_content + 1}"
        script[closing_key] = BRAND_CLOSING
        return script
    except json.JSONDecodeError:
        logger.warning("ë””ìŠ¤í¬ë¦½ì…˜ ê¸°ë°˜ ìŠ¤í¬ë¦½íŠ¸ JSON íŒŒì‹± ì‹¤íŒ¨")
        return None


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ì´ë¯¸ì§€ ì†Œì‹± (Unsplash + Google Drive)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ ë¶ˆìš©ì–´ (í‚¤ì›Œë“œ ì¶”ì¶œ ì‹œ ì œê±°)
_PROMPT_STOPWORDS = {
    "no", "text", "letters", "numbers", "typography", "watermark", "logo",
    "vertical", "format", "aspect", "ratio", "1080x1440px", "3:4",
    "px", "top", "bottom", "left", "right", "center", "blank", "space",
    "overlay", "area", "placed", "background", "style", "render",
    "illustration", "photograph", "photo", "image", "picture",
    "the", "a", "an", "and", "or", "of", "in", "on", "with", "for",
    "is", "are", "to", "from", "at", "by", "be", "this", "that",
}


_KR_TO_EN = {
    "ë©´ì—­": "immunity", "ê±´ê°•": "health", "ì˜ì–‘": "nutrition",
    "ë¹„íƒ€ë¯¼": "vitamin", "ìˆ˜ë©´": "sleep", "ìš´ë™": "exercise",
    "í”¼ë¶€": "skin", "ìŠ¤íŠ¸ë ˆìŠ¤": "stress", "ë‹¤ì´ì–´íŠ¸": "diet",
    "í•œë°©": "herbal medicine", "í•œì˜": "traditional medicine",
    "ë³´ì–‘": "nourishing", "ê°ê¸°": "cold flu", "í”¼ë¡œ": "fatigue",
    "ê´€ì ˆ": "joint", "í˜ˆì•¡": "blood circulation", "ì†Œí™”": "digestion",
    "í˜¸í¡": "breathing respiratory", "ì‹¬ì¥": "heart cardiovascular",
    "ë‡Œ": "brain mental", "ëˆˆ": "eye vision", "ê°„": "liver",
    "ê²¨ìš¸": "winter", "ì—¬ë¦„": "summer", "ë´„": "spring", "ê°€ì„": "autumn",
    "ì•„ì¹¨": "morning", "ì €ë…": "evening", "ë°¤": "night",
    "ì°¨": "tea", "ìŒì‹": "food", "ì•½": "medicine", "ì‹í’ˆ": "healthy food",
    "ìì—°": "nature", "ìˆ²": "forest", "ë°”ë‹¤": "ocean", "ì‚°": "mountain",
    "ìš”ê°€": "yoga", "ëª…ìƒ": "meditation", "íœ´ì‹": "relaxation",
}


def extract_image_keywords(prompt: str) -> str:
    """ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ì—ì„œ Unsplash ê²€ìƒ‰ìš© í‚¤ì›Œë“œ ì¶”ì¶œ (ì˜ë¬¸+í•œê¸€ ì§€ì›)

    Returns: ê²€ìƒ‰ ì¿¼ë¦¬ ë¬¸ìì—´ (ì˜ˆ: "winter herbal tea warm")
    """
    if not prompt:
        return ""
    # "No text, no letters..." ì´í›„ ê·œì¹™ í…ìŠ¤íŠ¸ ì œê±°
    cut = re.split(r"[Nn]o text", prompt)[0]

    # 1) ì˜ë¬¸ í‚¤ì›Œë“œ ì¶”ì¶œ
    en_words = re.findall(r"[a-zA-Z]+", cut.lower())
    en_keywords = [w for w in en_words if w not in _PROMPT_STOPWORDS and len(w) > 2]

    # 2) í•œê¸€ í‚¤ì›Œë“œ â†’ ì˜ë¬¸ ë³€í™˜
    kr_keywords = []
    for kr, en in _KR_TO_EN.items():
        if kr in cut:
            kr_keywords.extend(en.split())

    # í•©ì‚° í›„ ì¤‘ë³µ ì œê±°, ì•ì—ì„œ 5ê°œ
    combined = en_keywords + kr_keywords
    seen = set()
    unique = []
    for w in combined:
        if w not in seen:
            seen.add(w)
            unique.append(w)
        if len(unique) >= 5:
            break
    return " ".join(unique)


def search_unsplash(query: str, per_page: int = 4) -> list[dict]:
    """Unsplashì—ì„œ í‚¤ì›Œë“œë¡œ ì´ë¯¸ì§€ ê²€ìƒ‰

    Returns: [{"url": ì •ê·œURL, "thumb": ì¸ë„¤ì¼, "photographer": ì‘ê°€ëª…,
               "unsplash_link": ì›ë³¸ë§í¬}, ...]
    """
    api_key = os.getenv("UNSPLASH_ACCESS_KEY")
    if not api_key:
        logger.warning("UNSPLASH_ACCESS_KEY ë¯¸ì„¤ì •")
        return []
    if not query.strip():
        return []
    try:
        resp = _requests.get(
            "https://api.unsplash.com/search/photos",
            params={
                "query": query,
                "per_page": per_page,
                "orientation": "portrait",
                "content_filter": "high",
            },
            headers={"Authorization": f"Client-ID {api_key}"},
            timeout=10,
        )
        resp.raise_for_status()
        results = []
        for photo in resp.json().get("results", []):
            results.append({
                "url": photo["urls"]["regular"],
                "raw": photo["urls"]["raw"],
                "thumb": photo["urls"]["small"],
                "photographer": photo["user"]["name"],
                "unsplash_link": photo["links"]["html"],
            })
        return results
    except Exception as e:
        logger.warning(f"Unsplash ê²€ìƒ‰ ì‹¤íŒ¨: {e}")
        return []


# â”€â”€ Google Drive ì´ë¯¸ì§€ â”€â”€

GDRIVE_FOLDER_ID = "1lMK6UHARz6q0nsN4wLDOxPjaQFtgBO3M"

# ëª¨ë“ˆ ë ˆë²¨ ìºì‹œ
_gdrive_cache: dict = {"files": [], "timestamp": 0.0}
_GDRIVE_CACHE_TTL = 600  # 10ë¶„


def list_gdrive_images(folder_id: str = GDRIVE_FOLDER_ID) -> list[dict]:
    """Google Drive í´ë”ì˜ ì´ë¯¸ì§€ íŒŒì¼ ëª©ë¡ ì¡°íšŒ (API í‚¤ ë°©ì‹)

    Returns: [{"name": íŒŒì¼ëª…, "id": íŒŒì¼ID, "thumb": ì¸ë„¤ì¼URL, "url": ë·°ì–´URL}, ...]
    """
    global _gdrive_cache
    now = time.time()
    if _gdrive_cache["files"] and (now - _gdrive_cache["timestamp"]) < _GDRIVE_CACHE_TTL:
        return _gdrive_cache["files"]

    api_key = os.getenv("GOOGLE_API_KEY")
    if not api_key:
        logger.warning("GOOGLE_API_KEY ë¯¸ì„¤ì •")
        return []
    try:
        files = []
        page_token = None
        while True:
            params = {
                "q": f"'{folder_id}' in parents and mimeType contains 'image/'",
                "fields": "nextPageToken,files(id,name,mimeType,thumbnailLink,webContentLink)",
                "pageSize": 100,
                "key": api_key,
            }
            if page_token:
                params["pageToken"] = page_token
            resp = _requests.get(
                "https://www.googleapis.com/drive/v3/files",
                params=params,
                timeout=10,
            )
            resp.raise_for_status()
            data = resp.json()
            for f in data.get("files", []):
                files.append({
                    "name": f["name"],
                    "id": f["id"],
                    "thumb": f.get("thumbnailLink", ""),
                    "url": f"https://drive.google.com/uc?id={f['id']}&export=view",
                })
            page_token = data.get("nextPageToken")
            if not page_token:
                break

        _gdrive_cache = {"files": files, "timestamp": now}
        logger.info(f"Google Drive ì´ë¯¸ì§€ {len(files)}ê°œ ë¡œë“œ")
        return files
    except Exception as e:
        logger.warning(f"Google Drive ì¡°íšŒ ì‹¤íŒ¨: {e}")
        return []


def search_gdrive_images(keyword: str, images: list[dict] | None = None) -> list[dict]:
    """íŒŒì¼ëª… ê¸°ë°˜ìœ¼ë¡œ í‚¤ì›Œë“œ ë§¤ì¹­í•˜ì—¬ ê´€ë ¨ ì´ë¯¸ì§€ í•„í„°ë§

    Args:
        keyword: ê²€ìƒ‰ í‚¤ì›Œë“œ (í•œê¸€ ë˜ëŠ” ì˜ë¬¸)
        images: ì´ë¯¸ì§€ ëª©ë¡ (Noneì´ë©´ ìë™ ë¡œë“œ)
    Returns: ë§¤ì¹­ëœ ì´ë¯¸ì§€ ë¦¬ìŠ¤íŠ¸
    """
    if images is None:
        images = list_gdrive_images()
    if not keyword.strip() or not images:
        return images[:8]  # í‚¤ì›Œë“œ ì—†ìœ¼ë©´ ì „ì²´ ì¤‘ 8ê°œ

    keyword_lower = keyword.lower()
    words = keyword_lower.split()
    scored = []
    for img in images:
        name_lower = img["name"].lower()
        score = sum(1 for w in words if w in name_lower)
        if score > 0:
            scored.append((score, img))
    scored.sort(key=lambda x: x[0], reverse=True)
    return [img for _, img in scored[:8]] if scored else images[:8]


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ìë™ ì´ë¯¸ì§€ ê²€ìƒ‰ + ì¹´ë“œë‰´ìŠ¤ ì´ë¯¸ì§€ ìƒì„±
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def _detect_content_keys(script: dict) -> list[str]:
    """ìŠ¤í¬ë¦½íŠ¸ì—ì„œ contentN í‚¤ë¥¼ ë™ì ìœ¼ë¡œ ê°ì§€ (í´ë¡œì§• ì¹´ë“œ ì œì™¸)í•˜ì—¬ ì •ë ¬ëœ ë¦¬ìŠ¤íŠ¸ ë°˜í™˜"""
    content_keys = sorted(
        [
            k for k in script
            if k.startswith("content") and k[7:].isdigit()
            and script.get(k) != BRAND_CLOSING  # í´ë¡œì§• ì¹´ë“œ ì œì™¸
        ],
        key=lambda k: int(k[7:]),
    )
    return ["cover"] + content_keys


def _build_labels(card_keys: list[str]) -> dict[str, str]:
    """ì¹´ë“œ í‚¤ ë¦¬ìŠ¤íŠ¸ë¡œë¶€í„° ë¼ë²¨ ë§µ ìƒì„±"""
    labels = {}
    for i, key in enumerate(card_keys, 1):
        if key == "cover":
            labels[key] = f"#{i} í‘œì§€"
        else:
            num = key.replace("content", "")
            labels[key] = f"#{i} ë‚´ìš©{num}"
    return labels


_FALLBACK_KEYWORDS = [
    "health wellness", "nature calm", "lifestyle healthy",
    "science research", "morning routine", "sunset peaceful",
    "herbal tea cozy", "meditation mindful", "fresh food nutrition",
]


def auto_search_card_images(script: dict) -> dict:
    """ìŠ¤í¬ë¦½íŠ¸ì˜ ê° ì¹´ë“œë³„ Unsplash ì´ë¯¸ì§€ ìë™ ê²€ìƒ‰ (í´ë°± í¬í•¨)

    Returns: {"cover": {"url":..., "raw":..., "thumb":..., "photographer":...}, ...}
    """
    img_prompts = script.get("image_prompts", {})
    card_keys = _detect_content_keys(script)
    card_images = {}
    used_urls = set()  # ì¤‘ë³µ ë°©ì§€: ì´ë¯¸ ì‚¬ìš©ëœ ì´ë¯¸ì§€ URL ì¶”ì 
    for idx, key in enumerate(card_keys):
        prompt = img_prompts.get(key, "")
        if not prompt:
            continue
        keywords = extract_image_keywords(prompt)
        if not keywords:
            continue
        # 1ì°¨: ì „ì²´ í‚¤ì›Œë“œ ê²€ìƒ‰ (per_page ëŠ˜ë ¤ì„œ ì„ íƒì§€ í™•ë³´)
        results = search_unsplash(keywords, per_page=8)
        if not results and len(keywords.split()) > 2:
            # 2ì°¨ í´ë°±: í‚¤ì›Œë“œ ì• 2ê°œë§Œ
            short_kw = " ".join(keywords.split()[:2])
            results = search_unsplash(short_kw, per_page=8)
        if not results:
            # 3ì°¨ í´ë°±: ë²”ìš© í‚¤ì›Œë“œ (ì¸ë±ìŠ¤ ê¸°ë°˜ ìˆœí™˜)
            fallback = _FALLBACK_KEYWORDS[idx % len(_FALLBACK_KEYWORDS)]
            results = search_unsplash(fallback, per_page=5)
        # ì¤‘ë³µ ì œê±°: ì´ë¯¸ ì‚¬ìš©ëœ URL ì œì™¸
        if results:
            chosen = None
            for r in results:
                if r.get("url") not in used_urls:
                    chosen = r
                    break
            if not chosen:
                chosen = results[0]  # ëª¨ë‘ ì¤‘ë³µì´ë©´ ì²« ë²ˆì§¸ ì‚¬ìš©
            used_urls.add(chosen.get("url"))
            card_images[key] = chosen
    return card_images


def _download_bg_image(img_info: dict, width: int = 1080, height: int = 1440) -> bytes | None:
    """Unsplashì—ì„œ ë°°ê²½ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ (Imgix ì„œë²„ì‚¬ì´ë“œ í¬ë¡­)

    Args:
        img_info: {"url": ..., "raw": ..., ...} from search_unsplash()
        width, height: ì›í•˜ëŠ” í¬ê¸°
    Returns: ì´ë¯¸ì§€ bytes ë˜ëŠ” None
    """
    raw_url = img_info.get("raw", "")
    if raw_url:
        crop_url = raw_url + f"&w={width}&h={height}&fit=crop&crop=entropy&q=90&fm=jpg"
    else:
        crop_url = img_info.get("url", "")
    if not crop_url:
        return None
    try:
        resp = _requests.get(crop_url, timeout=25)
        resp.raise_for_status()
        return resp.content
    except Exception as e:
        logger.warning(f"ë°°ê²½ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: {e}")
        return None


import re as _re

def _clean_markdown(text):
    """ë§ˆí¬ë‹¤ìš´ ê¸°í˜¸ + ì´ëª¨ì§€/íŠ¹ìˆ˜ë¬¸ìë¥¼ ì œê±°í•˜ì—¬ ë Œë”ë§ìš© ìˆœìˆ˜ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜."""
    if not text:
        return text
    # ë§ˆí¬ë‹¤ìš´ ì œê±°
    text = _re.sub(r'\*\*(.+?)\*\*', r'\1', text)  # **bold**
    text = _re.sub(r'~~(.+?)~~', r'\1', text)       # ~~strike~~
    text = _re.sub(r'__(.+?)__', r'\1', text)       # __underline__
    text = _re.sub(r'(?<!\*)\*(?!\*)(.+?)(?<!\*)\*(?!\*)', r'\1', text)  # *italic*
    text = _re.sub(r'`(.+?)`', r'\1', text)         # `code`
    text = text.replace('**', '').replace('~~', '').replace('__', '')
    # ì´ëª¨ì§€/íŠ¹ìˆ˜ ìœ ë‹ˆì½”ë“œ ì œê±° (í•œê¸€, ì˜ë¬¸, ìˆ«ì, ê¸°ë³¸ ë¬¸ì¥ë¶€í˜¸ë§Œ ë³´ì¡´)
    text = _re.sub(
        r'[^\w\sê°€-í£ã„±-ã…ã…-ã…£a-zA-Z0-9'
        r'.,!?;:%()\-Â·/~\'"â†‘â†“â†’â†+&@#\n]',
        '', text
    )
    # ì—°ì† ê³µë°± ì •ë¦¬
    text = _re.sub(r'  +', ' ', text)
    return text.strip()


def _split_heading_body(text):
    """ìŠ¤í¬ë¦½íŠ¸ í…ìŠ¤íŠ¸ë¥¼ heading + bodyë¡œ ë¶„ë¦¬.

    textê°€ dictì´ë©´ heading/body í‚¤ë¥¼ ì§ì ‘ ì‚¬ìš©.
    strì´ë©´ ì¤„ê¸€ ìŠ¤íƒ€ì¼: ì „ì²´ í…ìŠ¤íŠ¸ë¥¼ headingìœ¼ë¡œ, bodyëŠ” ë¹ˆ ë¬¸ìì—´.
    ë°˜í™˜ ì „ ë§ˆí¬ë‹¤ìš´ ê¸°í˜¸ë¥¼ ìë™ ì œê±°.
    """
    if isinstance(text, dict):
        h = _clean_markdown(text.get("heading", ""))
        b = _clean_markdown(text.get("body", ""))
        return h, b

    # ì¤„ê¸€ ìŠ¤íƒ€ì¼: ì „ì²´ë¥¼ headingìœ¼ë¡œ ë°˜í™˜ (ë¶„ë¦¬í•˜ì§€ ì•ŠìŒ)
    text = _clean_markdown(str(text).strip())
    return text, ""


def generate_all_card_images(
    script: dict, card_images: dict, progress_callback=None,
    template: str = "ìˆ˜å£½ ë¸Œëœë“œ", size: tuple = (1080, 1350),
) -> dict[str, bytes]:
    """ì „ì²´ ì¹´ë“œë‰´ìŠ¤ ì´ë¯¸ì§€ ì¼ê´„ ìƒì„± (CardNewsRenderer í™œìš©)

    Args:
        script: í’€ ìŠ¤í¬ë¦½íŠ¸ dict
        card_images: auto_search_card_images() ê²°ê³¼
        progress_callback: fn(card_label, status)
        template: card_news.py í…œí”Œë¦¿ ì´ë¦„
        size: (width, height) íŠœí”Œ
    Returns: {"cover": PNG bytes, ..., "closing": PNG bytes}
    """
    from card_news import CardNewsRenderer

    renderer = CardNewsRenderer(template, size=size)
    width, height = size

    # ìŠ¤í¬ë¦½íŠ¸ì—ì„œ contentN í‚¤ë¥¼ ë™ì  ê°ì§€
    card_keys = _detect_content_keys(script)
    labels_map = _build_labels(card_keys)
    active_cards = [(k, i + 1) for i, k in enumerate(card_keys) if script.get(k)]
    total_cards = len(active_cards) + 1  # + closing
    content_total = sum(1 for k, _ in active_cards if k != "cover")

    results = {}
    cover_bg_bytes = None  # í´ë¡œì§• ì¹´ë“œì— ì¬ì‚¬ìš©
    content_num = 0

    for key, num in active_cards:
        text = script.get(key, "")
        img_info = card_images.get(key)
        label = labels_map.get(key, key)
        if progress_callback:
            progress_callback(label, "ìƒì„± ì¤‘...")

        bg_bytes = _download_bg_image(img_info, width, height) if img_info else None

        try:
            badge = f"{num}/{total_cards}"
            if key == "cover":
                cover_bg_bytes = bg_bytes  # í´ë¡œì§•ìš© ì €ì¥
                cover_title = text if isinstance(text, str) else text.get("heading", str(text))
                cover_title = _clean_markdown(cover_title)
                image_bytes = renderer.render_cover(
                    title=cover_title,
                    bg_image=bg_bytes, badge_text=badge,
                )
            else:
                # content ìŠ¬ë¼ì´ë“œ: render_content() ì‚¬ìš©
                content_num += 1
                heading, body = _split_heading_body(text)
                # ì œí’ˆ í‚¤ì›Œë“œ ê°ì§€ ì‹œ Unsplash ëŒ€ì‹  ì œí’ˆ ì´ë¯¸ì§€ ì‚¬ìš©
                content_text = str(text) if isinstance(text, str) else f"{text.get('heading', '')} {text.get('body', '')}"
                _PRODUCT_KW = ("ê²½ì˜¥ê³ ", "ê³µì§„ë‹¨", "ì´ëª…ê³µì§„ë‹¨", "ìš°í™©ì²­ì‹¬ì›", "ë…¹ìš©í•œì•½", "ë…¹ìš©", "ì½œë“œí€µ", "ê¹ŒìŠ¤í€µ")
                use_product_bg = any(kw in content_text for kw in _PRODUCT_KW)
                image_bytes = renderer.render_content(
                    heading=heading, body=body,
                    slide_num=content_num, total_slides=content_total,
                    bg_image=None if use_product_bg else bg_bytes,
                )
        except Exception as e:
            logger.warning(f"ì¹´ë“œ ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨ ({key}): {e}")
            image_bytes = None

        if image_bytes:
            results[key] = image_bytes
            if progress_callback:
                progress_callback(label, "ì™„ë£Œ")
        elif progress_callback:
            progress_callback(label, "ì‹¤íŒ¨")

    # í´ë¡œì§• ì¹´ë“œ (ì»¤ë²„ ë°°ê²½ ì´ë¯¸ì§€ ì¬ì‚¬ìš©)
    closing_label = f"#{total_cards} í´ë¡œì§•"
    if progress_callback:
        progress_callback(closing_label, "ìƒì„± ì¤‘...")
    try:
        closing = renderer.render_closing(
            cta_text="ë” ì˜¤ë˜, ë” ê±´ê°•í•˜ê²Œ.\ní•œì˜ì‚¬ê°€ ë§Œë“œëŠ” í•œì˜ ë¸Œëœë“œ",
            account_name="@thesoo_official",
            bg_image=cover_bg_bytes,
        )
    except Exception as e:
        logger.warning(f"í´ë¡œì§• ì¹´ë“œ ìƒì„± ì‹¤íŒ¨: {e}")
        closing = None
    if closing:
        results["closing"] = closing
    if progress_callback:
        progress_callback(closing_label, "ì™„ë£Œ")

    return results
