"""ë¦´ìŠ¤ ì „ìš© ìŠ¤í¬ë¦½íŠ¸ ìƒì„± â€” 1ë¶„ê±´ê°•í†¡.

ë‚˜ë ˆì´ì…˜(TTS)ì— ì í•©í•œ êµ¬ì–´ì²´ ìŠ¤í¬ë¦½íŠ¸ë¥¼ LLMìœ¼ë¡œ ìƒì„±.
í•µì‹¬ ì›ì¹™: ì›ƒê¸°ë©´ì„œ ìœ ìµí•˜ê²Œ! (ë°ˆ + ê³µê° + ì •ë³´)
GIF/ì˜ìƒ ë°°ê²½ì„ ìœ„í•œ media_query í¬í•¨.
"""
from __future__ import annotations

import json
import logging
import re

logger = logging.getLogger(__name__)

from cardnews_generator import _call_llm, suggest_topics  # noqa: E402

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ â€” ìœ ë¨¸ + ë°”ì´ëŸ´ + GIF í™œìš©
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

_REELS_SYSTEM = """ë‹¹ì‹ ì€ "1ë¶„ê±´ê°•í†¡" ì¸ìŠ¤íƒ€ê·¸ë¨ ë¦´ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ ì‘ê°€ì…ë‹ˆë‹¤.
ë‹¹ì‹ ì˜ ì½˜í…ì¸ ëŠ” 1,470ë§Œ ì¡°íšŒë¥¼ ê¸°ë¡í•œ ê²€ì¦ëœ ë°”ì´ëŸ´ ê³µì‹ì„ ë”°ë¦…ë‹ˆë‹¤.

## âš¡ í•µì‹¬ ì›ì¹™: ì›ƒê¸°ë©´ì„œ ìœ ìµí•˜ê²Œ!
- "ã…‹ã…‹ã…‹ ì´ê±° ë‚˜ì–ì•„" í•˜ë©´ì„œ ì¹œêµ¬í•œí…Œ ê³µìœ í•˜ëŠ” ì½˜í…ì¸ 
- ì¬ë¯¸ì—†ìœ¼ë©´ ìŠ¤í¬ë¡¤ë¨ â†’ ìœ ë¨¸ í¼ìŠ¤íŠ¸, ì •ë³´ ì„¸ì»¨ë“œ
- ì§¤ë°©(GIF)ê³¼ í•¨ê»˜ ë´ì•¼ ì¬ë°ŒëŠ” ë°ˆ ìŠ¤íƒ€ì¼
- "ì €ì¥í•´ì•¼ì§€" + "ê³µìœ í•´ì•¼ì§€" ë‘˜ ë‹¤ ìœ ë°œ

## ğŸ­ ìœ ë¨¸ íŒ¨í„´ (ë°˜ë“œì‹œ 2ê°œ ì´ìƒ ì‚¬ìš©!)

### 1. ìê¸°ë™ì¼ì‹œ (ê°€ì¥ íš¨ê³¼ì !)
"ì§€ê¸ˆ ì´ ì˜ìƒ ë³´ë©´ì„œ ì´ë¶ˆ ì†ì— ëˆ„ì›ŒìˆëŠ” ì‚¬ëŒ ì†ë“¤ì–´ ã…‹ã…‹"
"ìƒˆë²½ 2ì‹œì— ìœ íŠœë¸Œ ë³´ë©´ì„œ 'ë‚˜ ì™œ ì•ˆ ìì§€' í•˜ëŠ” ì‚¬ëŒ ì—¬ê¸° ëª¨ì—¬"
"ì•„ ì´ê±° ë“£ê³  ë¬¼ ë²Œì»¥ë²Œì»¥ ë§ˆì‹œëŠ” ì‚¬ëŒ ë¶„ëª… ìˆì„ ê±°ì˜ˆìš” ã…‹ã…‹"

### 2. ê³¼ì¥ ë¦¬ì•¡ì…˜
"ì´ê±° ë“£ê³  ë°”ë¡œ ìŠ¤íŠ¸ë ˆì¹­í•¨ ã„·ã„·"
"í— ì§„ì§œ? ë‚˜ ë§¤ì¼ ì´ëŸ¬ê³  ìˆì—ˆëŠ”ë°?!"
"ì´ê±° ì•Œê³  ë‚˜ì„œ ì ì„ ëª» ì¤ì–´ìš” ì§„ì§œë¡œ"

### 3. ë°ˆ/ì¸í„°ë„· ë¬¸í™” ì°¸ì¡°
"ê·¼ë° ì´ê²Œ ì§„ì§œì„ ã…‹ã…‹ ê³¼í•™ì ìœ¼ë¡œ ì¦ëª…ëì–´ìš”"
"ì•„ ì´ê±´ ì¢€... (ì¶©ê²©) ë‹¤ì‹œ í•œë²ˆ ë§í• ê²Œìš”"
"ì—¥? ê·¸ê²Œ ì•„ë‹ˆì—ˆì–´? í‰ìƒ ì†ì•˜ë„¤ ã…‹ã…‹"

### 4. ë°˜ì „ êµ¬ì¡°
ìƒì‹ â†’ "ê·¼ë° ì‚¬ì‹¤ì€..." â†’ ë°˜ëŒ€ ì •ë³´
"OOì´ ê±´ê°•ì— ì¢‹ë‹¤ê³ ìš”? ë„¤, ê·¼ë° XXí•˜ë©´ ì˜¤íˆë ¤ ë…ì´ì—ìš”"
"ë‹¤ë“¤ ì´ë ‡ê²Œ í•˜ì–ì•„ìš”? ì´ê±° ì™„ì „ ë°˜ëŒ€ë¡œ í•´ì•¼ í•´ìš”"

### 5. ì‹œì²­ì ì €ê²©
"ë°¤ 11ì‹œì— ë°°ë‹¬ìŒì‹ ì£¼ë¬¸í•˜ë ¤ëŠ” ì†ê°€ë½ ë©ˆì¶° âœ‹"
"ì§€ê¸ˆ êµ¬ë¶€ì •í•˜ê²Œ í° ë³´ëŠ” ìì„¸ ê·¸ëŒ€ë¡œ ë©ˆì¶°ë´ìš”"
"ì»¤í”¼ 3ì”ì§¸ ë§ˆì‹œëŠ” ì‚¬ëŒ ì´ê±° ê¼­ ë´ì•¼ í•´ìš”"

## ğŸ”¥ ë°”ì´ëŸ´ ì„±ê³µ ê³µì‹ (ì‹¤ì œ 320ë§Œë·° ë°ì´í„°)

### Hook ì²«ì¤„ ê¸°ë²• (2ê°€ì§€ ì´ìƒ ì¡°í•© í•„ìˆ˜!)
- **ìˆ«ì/í†µê³„** (33%): "ë¬´ë ¤ 83%ê°€...", "2ë¶„ì´ë©´...", "10ë„ ì´ìƒì´ë©´..."
- **ì§ˆë¬¸í˜•** (29%): "ë¶ˆë©´ì¦?", "ì´ê±° í˜¹ì‹œ ë‚˜ë„...?"
- **ì¶©ê²©/ê²½ê³ ** (18%): "ğŸš¨", "í•„ìˆ˜ ì‹œì²­!", "ë‹¹ì¥ ì•ˆ í•˜ë©´..."
- **ê³µê° ì €ê²©** (11%): "ì§€ê¸ˆ êµ¬ë¶€ì •í•˜ê²Œ...", "í•¸ë“œí° ë³´ëŠ” ì‚¬ëŒ..."
- **í–‰ë™ìœ ë„**: "ì €ì¥í•´ë‘ì„¸ìš”!!", "ëê¹Œì§€ ë³´ì„¸ìš”!"

### ë°”ì´ëŸ´ ë²•ì¹™
- ê³µìœ  > ì €ì¥ = ì•Œê³ ë¦¬ì¦˜ í­ë°œ (ê³µìœ  ìœ ë„ê°€ í•µì‹¬)
- ìº¡ì…˜ 200ì ë¯¸ë§Œ = ë°”ì´ëŸ´ 3ë°°
- "~ì¸ë°ìš”", "~ê±°ë“ ìš”", "~ë˜ìš”" êµ¬ì–´ì²´
- ã…‹ã…‹, ì§„ì§œ, ëŒ€ë°•, í— ë“± ì¸í„°ë„· ë§íˆ¬

## ğŸ“ ìŠ¬ë¼ì´ë“œë³„ ê·œì¹™

### narration (TTS í…ìŠ¤íŠ¸)
- í•´ìš”ì²´ êµ¬ì–´ì²´, ì¹œêµ¬ì—ê²Œ ë§í•˜ë“¯
- 15~35ì/ìŠ¬ë¼ì´ë“œ (5~8ì´ˆ)
- ìœ ë¨¸ í‘œí˜„ ì ê·¹ ì‚¬ìš© (ã…‹ã…‹ëŠ” TTSì—ì„œ ìƒëµë˜ë¯€ë¡œ ë¬¸ë§¥ìœ¼ë¡œ ì¬ë¯¸ë¥¼)
- "~ì¸ë°ìš”", "~ê±°ë“ ìš”", "~ì–ì•„ìš”" í•„ìˆ˜

### display_text (í™”ë©´ í…ìŠ¤íŠ¸)
- í•µì‹¬ í‚¤ì›Œë“œ (10~25ì)
- ì¤„ë°”ê¿ˆ(\\n)ìœ¼ë¡œ 2~3ì¤„
- ì´ëª¨ì§€ ì ê·¹ ì‚¬ìš© (ğŸš¨ğŸ’ªâš ï¸ğŸ”¥âŒâœ…ğŸ˜±ğŸ’€ğŸ¤¯)

### media_query (GIF/ì˜ìƒ ê²€ìƒ‰ìš© â€” ì˜ì–´ë¡œ!)
ê° ìŠ¬ë¼ì´ë“œì— ë°˜ë“œì‹œ `media_query` í¬í•¨!
GIF ê²€ìƒ‰ì–´ë¥¼ ì˜ì–´ë¡œ ì‘ì„±í•©ë‹ˆë‹¤:

- **hook**: ë¦¬ì•¡ì…˜/ë†€ëŒ GIF â†’ "shocked face reaction", "mind blown meme"
- **content (ë¬¸ì œ ì œê¸°)**: ê³µê° ìƒí™© â†’ "tired at desk sleeping", "eating junk food late night"
- **content (ì›ì¸/ì„¤ëª…)**: ê³¼í•™/ì˜í•™ â†’ "body anatomy heart", "brain neurons science"
- **content (í•´ê²°ì±…)**: ì‹¤ì²œ ì¥ë©´ â†’ "stretching exercise morning", "drinking water healthy"
- **content (ë¦¬ì•¡ì…˜)**: ë†€ëŒ/ê¹¨ë‹¬ìŒ â†’ "surprised pikachu", "realization moment"
- **closing**: "" (ë¹ˆ ë¬¸ìì—´)

media_query ì˜ˆì‹œ:
- ë†€ë¼ëŠ” ì§¤: "shocked surprised omg reaction"
- ê³µê° ì§¤: "relatable mood same exhausted"
- ìš´ë™ ì§¤: "exercise workout funny fail"
- ìˆ˜ë©´ ì§¤: "sleeping tired insomnia funny"
- ìŒì‹ ì§¤: "eating food delicious guilty"
- ì›ƒê¸´ ë¦¬ì•¡ì…˜: "funny laugh comedy reaction meme"
- ì˜í•™ ì§¤: "doctor medical hospital funny"
- ì¶©ê²© ì§¤: "mind blown explosion wow"

### media_type
- "gif": GIF/ì§¤ë°© ë°°ê²½ (ëŒ€ë¶€ë¶„ì˜ ìŠ¬ë¼ì´ë“œì— ì‚¬ìš©!)
- "video": ì˜ìƒ í´ë¦½ ë°°ê²½ (ìš´ë™ ì‹œì—° ë“± ì‹¤ì‚¬ í•„ìš” ì‹œ)
- "image": ì •ì  ì´ë¯¸ì§€ (íŠ¹ë³„í•œ ê²½ìš°ë§Œ)

## ìŠ¬ë¼ì´ë“œ êµ¬ì„± (ë™ì  â€” ë‚˜ë ˆì´ì…˜ ë¶„ëŸ‰ì— ë§ê²Œ ììœ ë¡­ê²Œ!)
- **hook** (1ì¥): ì²« 3ì´ˆ ì‹œì„  ê°•íƒˆ! ìœ ë¨¸+ê³µê°+ìˆ«ì ì¡°í•©. media_type="gif"
- **content** (ììœ ): ë‚˜ë ˆì´ì…˜ ë‚´ìš©ì— ë§ê²Œ 3~8ì¥. í•˜ë‚˜ì˜ í¬ì¸íŠ¸ë‹¹ 1ì¥. media_type="gif" ë˜ëŠ” "video"
- **closing** (1ì¥): "1ë¶„ê±´ê°•í†¡ì´ì—ˆìŠµë‹ˆë‹¤" + CTA. media_type="image"
- ì´ 30~60ì´ˆ ë¶„ëŸ‰ (ìŠ¬ë¼ì´ë“œë‹¹ 4~8ì´ˆ ë‚˜ë ˆì´ì…˜)
- í•µì‹¬: ë‚´ìš©ì´ ìì—°ìŠ¤ëŸ½ê²Œ ëŠê¸°ëŠ” ë‹¨ìœ„ë¡œ ìŠ¬ë¼ì´ë“œë¥¼ ë‚˜ëˆ„ì„¸ìš”!

## ì¶œë ¥ í˜•ì‹ (JSONë§Œ!)
```json
{{
    "title": "ë¦´ìŠ¤ ì œëª© (30ì ì´ë‚´, ì„íŒ©íŠ¸ ìˆê²Œ)",
    "slides": [
        {{
            "type": "hook",
            "narration": "TTS ë‚˜ë ˆì´ì…˜ (ìœ ë¨¸+ê³µê°+ìˆ«ì ì¡°í•©)",
            "display_text": "ğŸš¨ í™”ë©´ í‘œì‹œ\\nì„íŒ©íŠ¸ í…ìŠ¤íŠ¸",
            "media_query": "shocked surprised omg reaction",
            "media_type": "gif"
        }},
        {{
            "type": "content",
            "narration": "ì¹œêµ¬ì—ê²Œ ë§í•˜ë“¯ ìì—°ìŠ¤ëŸ¬ìš´ ì„¤ëª…",
            "display_text": "í•µì‹¬ í‚¤ì›Œë“œ\\n2~3ì¤„",
            "media_query": "relevant funny gif keywords",
            "media_type": "gif"
        }},
        {{
            "type": "closing",
            "narration": "1ë¶„ê±´ê°•í†¡ì´ì—ˆìŠµë‹ˆë‹¤. íŒ”ë¡œìš°í•˜ê³  ê±´ê°• íŒ ë°›ì•„ê°€ì„¸ìš”!",
            "display_text": "íŒ”ë¡œìš°í•˜ê³ \\nê±´ê°• íŒ ë°›ê¸°! ğŸ’™",
            "media_query": "",
            "media_type": "image"
        }}
    ],
    "hashtags": ["#1ë¶„ê±´ê°•í†¡", "#ê±´ê°•ì •ë³´", "#ê±´ê°•ê¿€íŒ", "#ê±´ê°•", "#ê±´ê°•ì†Œì‹", "#ê±´ê°•ì´ìŠˆ", "#ì˜í•™", ...],
    "description": "Hook ì²«ì¤„\\n\\ní•µì‹¬ 2~3ì¤„\\n\\nì–¸ì  ê°„ ì“¸ë°ê°€ ìˆì–´ìš”, ì„¸ìƒì˜ ëª¨ë“  ê±´ê°• ì´ì•¼ê¸°\\nğŸ‘‰ğŸ‘‰ @1min_health_tok íŒ”ë¡œìš°í•˜ê¸° ğŸ‘ˆğŸ‘ˆ"
}}
```
"""


# ê¸°ë³¸ í•´ì‹œíƒœê·¸
_BASE_HASHTAGS = [
    "#1ë¶„ê±´ê°•í†¡", "#ê±´ê°•ì •ë³´", "#ê±´ê°•ê¿€íŒ", "#ê±´ê°•", "#ê±´ê°•ì†Œì‹", "#ê±´ê°•ì´ìŠˆ", "#ì˜í•™",
]

_SIGNATURE = "ì–¸ì  ê°„ ì“¸ë°ê°€ ìˆì–´ìš”, ì„¸ìƒì˜ ëª¨ë“  ê±´ê°• ì´ì•¼ê¸°"
_CTA = "ğŸ‘‰ğŸ‘‰ @1min_health_tok íŒ”ë¡œìš°í•˜ê¸° ğŸ‘ˆğŸ‘ˆ"


def _ensure_viral_patterns(script: dict) -> dict:
    """ë°”ì´ëŸ´ íŒ¨í„´ + media_query í›„ì²˜ë¦¬ ë³´ì •."""
    # 1. ê¸°ë³¸ í•´ì‹œíƒœê·¸ ë³´ì¥
    tags = script.get("hashtags", [])
    for base_tag in _BASE_HASHTAGS:
        if base_tag not in tags:
            tags.insert(0, base_tag)
    seen = set()
    unique_tags = []
    for t in tags:
        if t not in seen:
            seen.add(t)
            unique_tags.append(t)
    script["hashtags"] = unique_tags[:17]

    # 2. description ì‹œê·¸ë‹ˆì²˜/CTA ë³´ì¥
    desc = script.get("description", "")
    if _SIGNATURE not in desc:
        desc = desc.rstrip() + f"\n\n{_SIGNATURE}"
    if "@1min_health_tok" not in desc:
        desc = desc.rstrip() + f"\n{_CTA}"
    if len(desc) > 250:
        first_line = desc.split("\n")[0]
        desc = f"{first_line}\n\n{_SIGNATURE}\n{_CTA}"
    script["description"] = desc

    # 3. closing ë³´ì •
    slides = script.get("slides", [])
    for s in slides:
        if s.get("type") == "closing":
            if "1ë¶„ê±´ê°•í†¡" not in s.get("narration", ""):
                s["narration"] = "1ë¶„ê±´ê°•í†¡ì´ì—ˆìŠµë‹ˆë‹¤. íŒ”ë¡œìš°í•˜ê³  ê±´ê°• íŒ ë°›ì•„ê°€ì„¸ìš”!"
            s["media_query"] = ""
            s["media_type"] = "image"

    # 4. media_query/media_type ê¸°ë³¸ê°’ ë³´ì¥
    for s in slides:
        if "media_query" not in s:
            # image_promptê°€ ìˆìœ¼ë©´ ê·¸ê±¸ ë³€í™˜
            img_prompt = s.get("image_prompt", "")
            if img_prompt:
                s["media_query"] = img_prompt.replace("No text", "").replace("no letters", "").strip()
            else:
                s["media_query"] = ""
        if "media_type" not in s:
            s["media_type"] = "gif" if s["type"] != "closing" else "image"

    return script


def generate_reels_script(topic: str, num_slides: int | None = None) -> dict | None:
    """ë¦´ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ ìƒì„± (ìœ ë¨¸ + GIF í™œìš©).

    Args:
        topic: ì£¼ì œ (ì˜ˆ: "ê²¨ìš¸ì²  ì¼êµì°¨ ê±´ê°•ê´€ë¦¬")
        num_slides: íŒíŠ¸ìš© (Noneì´ë©´ LLMì´ ë‚˜ë ˆì´ì…˜ ê¸°ë°˜ìœ¼ë¡œ ë™ì  ê²°ì •)

    Returns: ìŠ¤í¬ë¦½íŠ¸ dict or None
    """
    system = _REELS_SYSTEM

    slide_hint = ""
    if num_slides:
        content_count = num_slides - 2
        slide_hint = f"\nëª©í‘œ ìŠ¬ë¼ì´ë“œ ìˆ˜: ì•½ {num_slides}ì¥ (hook 1 + content ~{content_count} + closing 1)"

    user = f"""ë‹¤ìŒ ì£¼ì œë¡œ ë¦´ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.

ì£¼ì œ: {topic}{slide_hint}

âš¡ í•µì‹¬ ì§€ì¹¨:
1. ì›ƒê²¨ì•¼ í•©ë‹ˆë‹¤! ë°ˆ/ì§¤ë°©ê³¼ í•¨ê»˜ ë´ì•¼ ì¬ë°ŒëŠ” ìŠ¤íƒ€ì¼
2. Hookì€ "ìˆ«ì+ê³µê° ì €ê²©+ì¶©ê²©" ìµœì†Œ 2ê°œ ì¡°í•©
3. ê° ìŠ¬ë¼ì´ë“œë§ˆë‹¤ ì–´ìš¸ë¦¬ëŠ” GIFë¥¼ ìƒìƒí•˜ë©´ì„œ media_query ì‘ì„±
4. ë‚˜ë ˆì´ì…˜ì€ ì¹œêµ¬í•œí…Œ ì¹´í†¡í•˜ë“¯ ìì—°ìŠ¤ëŸ½ê²Œ
5. "ì™€ ì´ê±° ì§„ì§œ?" + "ã…‹ã…‹ ì´ê±° ë‚˜ì¸ë°" = ê³µìœ  í­ë°œ
6. description(ìº¡ì…˜)ì€ 200ì ë¯¸ë§Œ
7. ìŠ¬ë¼ì´ë“œ ìˆ˜ëŠ” ë‚˜ë ˆì´ì…˜ ë‚´ìš©ì— ë§ê²Œ ììœ ë¡­ê²Œ ê²°ì •
8. âš ï¸ ì´ ë¶„ëŸ‰ 30~50ì´ˆ! (hook 1 + content 3~5ì¥ + closing 1 = ìµœëŒ€ 7ì¥)
9. display_textì— ì´ëª¨ì§€ ë„£ì§€ ë§ˆì„¸ìš” (í°íŠ¸ ë¯¸ì§€ì›). í…ìŠ¤íŠ¸ë§Œ!

ë°˜ë“œì‹œ JSONë§Œ ì¶œë ¥í•˜ì„¸ìš”."""

    raw = _call_llm(system, user, temperature=0.8, max_tokens=3000)
    if not raw:
        logger.error("ë¦´ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ LLM í˜¸ì¶œ ì‹¤íŒ¨")
        return None

    try:
        match = re.search(r"\{[\s\S]*\}", raw)
        if not match:
            logger.error("ë¦´ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ JSON íŒŒì‹± ì‹¤íŒ¨: JSON ë¸”ë¡ ì—†ìŒ")
            return None
        script = json.loads(match.group(0))
        if "slides" not in script or not isinstance(script["slides"], list):
            logger.error("ë¦´ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ ê²€ì¦ ì‹¤íŒ¨: slides ì—†ìŒ")
            return None
        if len(script["slides"]) < 3:
            logger.error(f"ë¦´ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ ê²€ì¦ ì‹¤íŒ¨: ìŠ¬ë¼ì´ë“œ {len(script['slides'])}ê°œ (ìµœì†Œ 3ê°œ)")
            return None
        script = _ensure_viral_patterns(script)
        return script
    except (json.JSONDecodeError, AttributeError) as e:
        logger.error(f"ë¦´ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ íŒŒì‹± ì‹¤íŒ¨: {e}")
        return None
