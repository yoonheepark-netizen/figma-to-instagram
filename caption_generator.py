import random
import logging

logger = logging.getLogger(__name__)

# í†¤ë³„ í›„í‚¹ ë¬¸ìž¥ í…œí”Œë¦¿ ({kw}ì— í‚¤ì›Œë“œ ì‚½ìž…)
_HOOKS = {
    "ì •ë³´ì„±": [
        "ì•Œê³  ê³„ì…¨ë‚˜ìš”? {kw}ì˜ ë†€ë¼ìš´ íš¨ê³¼!",
        "{kw}, ì´ê²ƒë§Œ ì•Œë©´ ë©ë‹ˆë‹¤ âœ…",
        "ì „ë¬¸ê°€ê°€ ì•Œë ¤ì£¼ëŠ” {kw}ì˜ í•µì‹¬ í¬ì¸íŠ¸",
        "{kw}ì— ëŒ€í•´ ê¼­ ì•Œì•„ì•¼ í•  3ê°€ì§€",
        "ë§Žì€ ë¶„ë“¤ì´ ëª¨ë¥´ëŠ” {kw}ì˜ ë¹„ë°€",
    ],
    "ê°ì„±": [
        "ì˜¤ëŠ˜ë„ {kw}ì™€ í•¨ê»˜í•˜ëŠ” í•˜ë£¨ ðŸŒ¿",
        "{kw}ì´(ê°€) ë‹¹ì‹ ì˜ ì¼ìƒì„ ë°”ê¿”ì¤„ ê±°ì˜ˆìš”",
        "ìž‘ì€ ë³€í™”ê°€ í° ì°¨ì´ë¥¼ ë§Œë“­ë‹ˆë‹¤, {kw}",
        "ë‹¹ì‹ ì„ ìœ„í•œ íŠ¹ë³„í•œ {kw} ì´ì•¼ê¸° ðŸ’›",
        "{kw}, ë§ˆìŒê¹Œì§€ ê±´ê°•í•´ì§€ëŠ” ì‹œê°„",
    ],
    "ìœ ë¨¸": [
        "{kw} ì•ˆ í•˜ë©´ ì†í•´ì¸ ê±° ì•„ì‹œì£ ? ðŸ˜‚",
        "ì¹œêµ¬í•œí…Œ ì•Œë ¤ì£¼ë©´ ê³ ë§ˆì›Œí•  {kw} ê¿€íŒ",
        "{kw} ì‹œìž‘í•˜ë©´ ë©ˆì¶œ ìˆ˜ê°€ ì—†ìŒ ã…‹ã…‹",
        "ì´ê±° ë³´ê³ ë„ {kw} ì•ˆ í•˜ì‹¤ ê±´ê°€ìš”? ðŸ¤”",
        "{kw}ì˜ ì„¸ê³„ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤ ðŸŽ‰",
    ],
    "ì „ë¬¸ì ": [
        "ê·¼ê±° ê¸°ë°˜ {kw} ê°€ì´ë“œ",
        "{kw}: ìµœì‹  ì—°êµ¬ê°€ ë§í•˜ëŠ” íš¨ê³¼ì™€ ë°©ë²•",
        "ë°ì´í„°ë¡œ ì¦ëª…ëœ {kw}ì˜ ì‹¤ì§ˆì  íš¨ê³¼",
        "{kw}ì— ëŒ€í•œ ì „ë¬¸ê°€ ë¶„ì„ ë¦¬í¬íŠ¸",
        "ìž„ìƒ ë°ì´í„°ë¡œ ë³´ëŠ” {kw}ì˜ ì§„ì‹¤",
    ],
}

# í†¤ë³„ CTA (í–‰ë™ ìœ ë„)
_CTAS = {
    "ì •ë³´ì„±": [
        "ë” ê¶ê¸ˆí•˜ì‹œë©´ ëŒ“ê¸€ë¡œ ì§ˆë¬¸í•´ì£¼ì„¸ìš”! ðŸ’¬",
        "ë„ì›€ì´ ë˜ì…¨ë‹¤ë©´ ì €ìž¥í•´ë‘ì„¸ìš” ðŸ“Œ",
        "ì£¼ë³€ì— ë„ì›€ì´ ë  ë¶„ì—ê²Œ ê³µìœ í•´ì£¼ì„¸ìš”!",
        "íŒ”ë¡œìš°í•˜ê³  ê±´ê°• ì •ë³´ ë†“ì¹˜ì§€ ë§ˆì„¸ìš” âœ¨",
    ],
    "ê°ì„±": [
        "ì—¬ëŸ¬ë¶„ì˜ ì´ì•¼ê¸°ë„ ë“¤ë ¤ì£¼ì„¸ìš” ðŸ’¬",
        "ê³µê°ë˜ì…¨ë‹¤ë©´ â¤ï¸ ëˆŒëŸ¬ì£¼ì„¸ìš”",
        "ì†Œì¤‘í•œ ì‚¬ëžŒì—ê²Œ ê³µìœ í•´ë³´ì„¸ìš” ðŸ¤",
        "ì˜¤ëŠ˜ë„ ê±´ê°•í•œ í•˜ë£¨ ë³´ë‚´ì„¸ìš” ðŸ€",
    ],
    "ìœ ë¨¸": [
        "ê³µê°ë˜ë©´ ì¹œêµ¬ íƒœê·¸ ê³ ê³ ! ðŸ‘‡",
        "ì €ìž¥ ì•ˆ í•˜ë©´ ë‚˜ì¤‘ì— í›„íšŒí•©ë‹ˆë‹¤ ðŸ˜¤",
        "ì¢‹ì•„ìš” ëˆ„ë¥´ê³  ê°€ì„¸ìš”~ ì•ˆ ëˆ„ë¥´ë©´ ì„­í•©ë‹ˆë‹¤ ðŸ¥¹",
        "ì´ ì •ë³´ í¼ëœ¨ë ¤ì•¼ í•©ë‹ˆë‹¤, ê³µìœ  í•„ìˆ˜! ðŸ”¥",
    ],
    "ì „ë¬¸ì ": [
        "ì „ë¬¸ ìƒë‹´ì´ í•„ìš”í•˜ì‹œë©´ DM ì£¼ì„¸ìš”.",
        "ë” ìžì„¸í•œ ì •ë³´ëŠ” í”„ë¡œí•„ ë§í¬ì—ì„œ í™•ì¸í•˜ì„¸ìš”.",
        "ê´€ë ¨ ì§ˆë¬¸ì€ ëŒ“ê¸€ë¡œ ë‚¨ê²¨ì£¼ì„¸ìš”, ë‹µë³€ë“œë¦¬ê² ìŠµë‹ˆë‹¤.",
        "íŒ”ë¡œìš°í•˜ì‹œë©´ ì „ë¬¸ ê±´ê°• ì •ë³´ë¥¼ ë°›ì•„ë³´ì‹¤ ìˆ˜ ìžˆìŠµë‹ˆë‹¤.",
    ],
}

# ë³¸ë¬¸ ì—°ê²° í…œí”Œë¦¿
_BODY_TEMPLATES = [
    "{kw1}ê³¼(ì™€) {kw2}ì˜ ì¡°í•©ì€ ìƒê°ë³´ë‹¤ ê°•ë ¥í•©ë‹ˆë‹¤.\n\në§¤ì¼ ì¡°ê¸ˆì”© ì‹¤ì²œí•˜ë©´ í™•ì‹¤í•œ ë³€í™”ë¥¼ ëŠë‚„ ìˆ˜ ìžˆì–´ìš”.",
    "ê±´ê°•í•œ ë¼ì´í”„ìŠ¤íƒ€ì¼ì˜ ì‹œìž‘ì€ {kw1}ë¶€í„°!\n\n{kw2}ê¹Œì§€ í•¨ê»˜í•˜ë©´ ì‹œë„ˆì§€ íš¨ê³¼ê°€ ë°°ê°€ ë©ë‹ˆë‹¤.",
    "{kw1} í•˜ë‚˜ë§Œìœ¼ë¡œë„ ë‹¬ë¼ì§ˆ ìˆ˜ ìžˆì–´ìš”.\n\nì—¬ê¸°ì— {kw2}ì„(ë¥¼) ë”í•˜ë©´? ì™„ë²½í•œ ì¡°í•©ì´ ì™„ì„±ë©ë‹ˆë‹¤ âœ¨",
    "ë§Žì€ ë¶„ë“¤ì´ {kw1}ì˜ ì¤‘ìš”ì„±ì„ ê°„ê³¼í•˜ê³  ìžˆì–´ìš”.\n\nì˜¤ëŠ˜ ì´ ê²Œì‹œë¬¼ì—ì„œ {kw2}ê³¼(ì™€) í•¨ê»˜ í•µì‹¬ì„ ì§šì–´ë“œë¦´ê²Œìš”.",
]


def generate_caption(
    image_urls=None,
    account_name="",
    past_top_captions=None,
    top_keywords=None,
    top_hashtags=None,
    tone="ì •ë³´ì„±",
):
    """ì¸ì‚¬ì´íŠ¸ ë°ì´í„° ê¸°ë°˜ìœ¼ë¡œ Instagram ìº¡ì…˜ê³¼ í•´ì‹œíƒœê·¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

    Args:
        image_urls: (ë¯¸ì‚¬ìš©, í˜¸í™˜ì„± ìœ ì§€)
        account_name: ê³„ì • ì´ë¦„
        past_top_captions: ê³¼ê±° ì„±ê³¼ ì¢‹ì€ ìº¡ì…˜ ë¦¬ìŠ¤íŠ¸
        top_keywords: ì„±ê³¼ ì¢‹ì€ í‚¤ì›Œë“œ ë¦¬ìŠ¤íŠ¸
        top_hashtags: ì„±ê³¼ ì¢‹ì€ í•´ì‹œíƒœê·¸ ë¦¬ìŠ¤íŠ¸
        tone: ìº¡ì…˜ í†¤ ("ì •ë³´ì„±", "ê°ì„±", "ìœ ë¨¸", "ì „ë¬¸ì ")

    Returns:
        dict: {"caption": str, "hashtags": str, "full": str}
    """
    # í‚¤ì›Œë“œ ì¤€ë¹„
    keywords = list(top_keywords) if top_keywords else []
    if not keywords:
        keywords = ["ê±´ê°•", "ì›°ë¹™", "ë¼ì´í”„ìŠ¤íƒ€ì¼"]
    random.shuffle(keywords)
    kw1, kw2 = keywords[0], keywords[1 % len(keywords)]

    # 1) í›„í‚¹ ë¬¸ìž¥
    hooks = _HOOKS.get(tone, _HOOKS["ì •ë³´ì„±"])
    hook = random.choice(hooks).format(kw=kw1)

    # 2) ë³¸ë¬¸
    body = random.choice(_BODY_TEMPLATES).format(kw1=kw1, kw2=kw2)

    # 3) CTA
    ctas = _CTAS.get(tone, _CTAS["ì •ë³´ì„±"])
    cta = random.choice(ctas)

    caption = f"{hook}\n\n{body}\n\n{cta}"

    # í•´ì‹œíƒœê·¸ ìƒì„±
    tags = set()
    if top_hashtags:
        for t in top_hashtags[:8]:
            tags.add(t.lstrip("#"))
    # í‚¤ì›Œë“œ ê¸°ë°˜ í•´ì‹œíƒœê·¸ ì¶”ê°€
    for kw in keywords[:5]:
        tags.add(kw)
    # ê¸°ë³¸ í•´ì‹œíƒœê·¸ ë³´ì¶©
    defaults = ["ê±´ê°•", "ê±´ê°•ê´€ë¦¬", "ê±´ê°•ì •ë³´", "í—¬ìŠ¤ì¼€ì–´", "ì›°ë¹™",
                 "ê±´ê°•ìŠµê´€", "ë°ì¼ë¦¬", "ì¼ìƒ", "ê¿€íŒ", "ì¶”ì²œ"]
    for d in defaults:
        if len(tags) >= 12:
            break
        tags.add(d)

    hashtags = " ".join(f"#{t}" for t in list(tags)[:15])

    full = f"{caption}\n\n{hashtags}"
    return {"caption": caption, "hashtags": hashtags, "full": full}
