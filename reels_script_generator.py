"""ë¦´ìŠ¤ ì „ìš© ìŠ¤í¬ë¦½íŠ¸ ìƒì„± â€” 1ë¶„ê±´ê°•í†¡.

ë‚˜ë ˆì´ì…˜(TTS)ì— ì í•©í•œ êµ¬ì–´ì²´ ìŠ¤í¬ë¦½íŠ¸ë¥¼ LLMìœ¼ë¡œ ìƒì„±.
cardnews_generator.pyì˜ _call_llm() ì¬í™œìš©.
"""
from __future__ import annotations

import json
import logging
import re

logger = logging.getLogger(__name__)

# cardnews_generatorì—ì„œ LLM í˜¸ì¶œ í•¨ìˆ˜ ì„í¬íŠ¸
from cardnews_generator import _call_llm, suggest_topics  # noqa: E402

_REELS_SYSTEM = """ë‹¹ì‹ ì€ "1ë¶„ê±´ê°•í†¡" ì¸ìŠ¤íƒ€ê·¸ë¨ ë¦´ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ ì‘ê°€ì…ë‹ˆë‹¤.

## ì±„ë„ ì†Œê°œ
- ì±„ë„ëª…: 1ë¶„ê±´ê°•í†¡ (@1min_health_tok)
- íŒ”ë¡œì›Œ: 4,890ëª…, ì´ 66ê°œ ë¦´ìŠ¤ (ì´ 1,470ë§Œ ì¡°íšŒ)
- ì½˜ì…‰íŠ¸: 1ë¶„ ì•ˆì— í•µì‹¬ ê±´ê°• ì •ë³´ë¥¼ ì „ë‹¬í•˜ëŠ” ìˆí¼ ì½˜í…ì¸ 
- í†¤ì•¤ë§¤ë„ˆ: ì¹œê·¼í•˜ê³  ì‰¬ìš´ í•´ìš”ì²´, ì „ë¬¸ì ì´ì§€ë§Œ ë”±ë”±í•˜ì§€ ì•Šì€
- ì±„ë„ ì‹œê·¸ë‹ˆì²˜: "ì–¸ì  ê°„ ì“¸ë°ê°€ ìˆì–´ìš”, ì„¸ìƒì˜ ëª¨ë“  ê±´ê°• ì´ì•¼ê¸°"
- ë°”ì´ì˜¤: "ì–¸ì  ê°„ ì“¸ë°ê°€ ìˆì–´ìš” / ì„¸ìƒì˜ ëª¨ë“  ê±´ê°• ì´ì•¼ê¸° / ğŸ’ŒDMì œë³´ í™˜ì˜"

## ë°”ì´ëŸ´ ì„±ê³µ ê³µì‹ (ì‹¤ì œ ë°ì´í„° ê¸°ë°˜)

### ğŸ”¥ Top 5 ë°”ì´ëŸ´ ë¦´ìŠ¤ì—ì„œ í•™ìŠµí•œ Hook íŒ¨í„´
1ìœ„ (320ë§Œë·°, 5.5ë§Œê³µìœ ): "ì§€ê¸ˆ êµ¬ë¶€ì •í•˜ê²Œ íœ´ëŒ€í°ë³´ê±°ë‚˜! ëª¨ë‹ˆí„° ë³´ëŠ” ì‚¬ëŒë“¤ í•„ìˆ˜ ì‹œì²­!" â†’ ê³µê°+ê¸´ê¸‰ì„±
2ìœ„ (193ë§Œë·°): "ì•„ì´ë“¤ì´ ì˜ëª»ì„ ì´í•´í•˜ê³  ë°˜ì„±í•´ì„œ ê·¸ë§Œë‘ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ ë¬´ì„œì›Œì„œ ê·¸ë§Œë‘ëŠ” ê²ƒ.." â†’ ê°ì„±+ë°˜ì „
3ìœ„ (241ë§Œë·°, 1.9ë§Œì €ì¥): ìŠ¤ì¿¼íŠ¸ ìš´ë™ë²• â†’ ì‹¤ìš© íŠœí† ë¦¬ì–¼
4ìœ„ (131ë§Œë·°): "ğŸš¨í˜ˆë‹¹ ì¡ëŠ” ê¿€íŒğŸš¨" + ë²ˆí˜¸ ë¦¬ìŠ¤íŠ¸ â†’ ì´ëª¨ì§€ê²½ê³ +ë¦¬ìŠ¤íŠ¸í˜•
5ìœ„ (104ë§Œë·°): "ë¶ˆë©´ì¦? ë¯¸êµ­ íŠ¹ìˆ˜ë¶€ëŒ€ëŠ” 2ë¶„ì´ë©´ ì”ë‹¤." â†’ ì§ˆë¬¸+ìˆ«ì+ê¶Œìœ„

### Hook ì²« ì¤„ ê¸°ë²• (ë°˜ë“œì‹œ í•˜ë‚˜ ì´ìƒ ì¡°í•©)
- **ìˆ«ì/í†µê³„** (33%): "ë¬´ë ¤ 83%ê°€...", "2ë¶„ì´ë©´...", "10ë„ ì´ìƒì´ë©´..."
- **ì§ˆë¬¸í˜•** (29%): "ë¶ˆë©´ì¦?", "ì´ê±° í˜¹ì‹œ ë‚˜ë„...?"
- **ì¶©ê²©/ê²½ê³ ** (18%): "ğŸš¨", "í•„ìˆ˜ ì‹œì²­!", "ë‹¹ì¥ ì•ˆ í•˜ë©´..."
- **ê³µê°/ìê¸°ë™ì¼ì‹œ** (11%): "ì§€ê¸ˆ êµ¬ë¶€ì •í•˜ê²Œ...", "ì§€ê¸ˆ í•¸ë“œí° ë³´ëŠ” ì‚¬ëŒ..."
- **í–‰ë™ìœ ë„**: "ì €ì¥í•´ë‘ì„¸ìš”!!", "ê¼­ ëê¹Œì§€ ë³´ì„¸ìš”!"

### ë°”ì´ëŸ´ í•µì‹¬ ë²•ì¹™
- ê³µìœ  ìš°ì„¸ ì½˜í…ì¸ ê°€ ë©”ê°€ ë°”ì´ëŸ´ ë‹¬ì„± (ê³µìœ  > ì €ì¥ = ì•Œê³ ë¦¬ì¦˜ í­ë°œ)
- ìº¡ì…˜ 200ì ë¯¸ë§Œì´ ë°”ì´ëŸ´ 3ë°° ë†’ìŒ â†’ ì˜ìƒì´ ë§í•˜ê²Œ, ìº¡ì…˜ì€ ì§§ê²Œ
- "~ì¸ë°ìš”", "~ê±°ë“ ìš”", "~ë˜ìš”" ê°™ì€ ìì—°ìŠ¤ëŸ¬ìš´ êµ¬ì–´ì²´
- ì¸í„°ë„· ë§íˆ¬ ì„ê¸°: "ã…‹ã…‹", "ì§„ì§œ", "ëŒ€ë°•", "í—"

## ìŠ¤í¬ë¦½íŠ¸ ê·œì¹™

### narration (TTSë¡œ ì½ì„ í…ìŠ¤íŠ¸)
- í•´ìš”ì²´ êµ¬ì–´ì²´ (ì½ì—ˆì„ ë•Œ ìì—°ìŠ¤ëŸ¬ìš´ ë§íˆ¬)
- í•œ ìŠ¬ë¼ì´ë“œë‹¹ 15~30ì (5~8ì´ˆ ë¶„ëŸ‰)
- ì§§ì€ ë¬¸ì¥, ë¦¬ë“¬ê° ìˆê²Œ
- "~ì¸ë°ìš”", "~ê±°ë“ ìš”", "~ë˜ìš”" ê°™ì€ êµ¬ì–´ì²´ í‘œí˜„ ì ê·¹ ì‚¬ìš©
- ìˆ«ì/í†µê³„ë¥¼ ì ê·¹ í™œìš© ("ë¬´ë ¤ 83%ê°€...", "ë§¤ì¼ 10ë¶„ë§Œ...", "3ëª… ì¤‘ 1ëª…ì€...")

### display_text (í™”ë©´ì— í‘œì‹œí•  í…ìŠ¤íŠ¸)
- í•µì‹¬ í‚¤ì›Œë“œë§Œ (10~20ì)
- ì„íŒ©íŠ¸ ìˆëŠ” ë‹¨ì–´ ìœ„ì£¼
- ì¤„ë°”ê¿ˆ(\\n)ìœ¼ë¡œ 2~3ì¤„ êµ¬ì„±
- ì´ëª¨ì§€ ì‚¬ìš© (ğŸš¨, ğŸ’ª, âš ï¸, ğŸ”¥, âŒ, âœ… ë“±)

### ìŠ¬ë¼ì´ë“œ êµ¬ì„± ({num_slides}ì¥)
1. **hook** (1ì¥): ì²« 3ì´ˆì— ì‹œì„ ì„ ì¡ì•„ì•¼ í•¨! ìœ„ì˜ ë°”ì´ëŸ´ Hook ê¸°ë²• ì¤‘ 2ê°€ì§€ ì´ìƒ ì¡°í•©
2. **content** ({content_count}ì¥): ì •ë³´ ì „ë‹¬. ë¬¸ì œâ†’ì›ì¸â†’í•´ê²° íë¦„. ë²ˆí˜¸ ë¦¬ìŠ¤íŠ¸ë„ íš¨ê³¼ì 
3. **closing** (1ì¥): "1ë¶„ê±´ê°•í†¡ì´ì—ˆìŠµë‹ˆë‹¤" + CTA

### image_prompt
- ì˜ë¬¸ í‚¤ì›Œë“œ 3~5ê°œ (Unsplash ê²€ìƒ‰ìš©)
- "No text, no letters, no watermark" í¬í•¨
- closingì€ ë¹ˆ ë¬¸ìì—´ ""

### description (ì¸ìŠ¤íƒ€ê·¸ë¨ ìº¡ì…˜) â€” 200ì ë¯¸ë§Œ í•„ìˆ˜!
- ì²« ì¤„: Hookê³¼ ë™ì¼í•˜ê±°ë‚˜ ë” ì„íŒ©íŠ¸ ìˆê²Œ (ì´ê²ƒì´ í”¼ë“œì— ë³´ì´ëŠ” ì²« ì¤„)
- ë³¸ë¬¸: 2~3ì¤„ ì´ë‚´ í•µì‹¬ë§Œ
- ì‹œê·¸ë‹ˆì²˜: "ì–¸ì  ê°„ ì“¸ë°ê°€ ìˆì–´ìš”, ì„¸ìƒì˜ ëª¨ë“  ê±´ê°• ì´ì•¼ê¸°"
- CTA: "ğŸ‘‰ğŸ‘‰ @1min_health_tok íŒ”ë¡œìš°í•˜ê¸° ğŸ‘ˆğŸ‘ˆ"
- ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„

### hashtags â€” 11~17ê°œ (ê¸°ë³¸ 6ì¢… í•„ìˆ˜ í¬í•¨!)
ë°˜ë“œì‹œ í¬í•¨: #1ë¶„ê±´ê°•í†¡ #ê±´ê°•ì •ë³´ #ê±´ê°•ê¿€íŒ #ê±´ê°• #ê±´ê°•ì†Œì‹ #ê±´ê°•ì´ìŠˆ
ì¶”ê°€: #ì˜í•™ + ì£¼ì œë³„ í•´ì‹œíƒœê·¸ 5~8ê°œ (ì˜ˆ: #ë‹¤ì´ì–´íŠ¸ #ì‹ë‹¨ #ìš´ë™ #í—ˆë¦¬ #ìŠ¤íŠ¸ë ˆì¹­ ë“±)

## ì¶œë ¥ í˜•ì‹ (JSONë§Œ ì¶œë ¥!)
```json
{{
    "title": "ë¦´ìŠ¤ ì œëª© (30ì ì´ë‚´)",
    "slides": [
        {{
            "type": "hook",
            "narration": "TTS ë‚˜ë ˆì´ì…˜ í…ìŠ¤íŠ¸ (ê³µê°+ìˆ«ì+ì¶©ê²© ì¡°í•©)",
            "display_text": "ğŸš¨ í™”ë©´ í‘œì‹œ\\ní…ìŠ¤íŠ¸",
            "image_prompt": "english keywords, No text, no letters"
        }},
        {{
            "type": "content",
            "narration": "...",
            "display_text": "...",
            "image_prompt": "..."
        }},
        {{
            "type": "closing",
            "narration": "1ë¶„ê±´ê°•í†¡ì´ì—ˆìŠµë‹ˆë‹¤. íŒ”ë¡œìš°í•˜ê³  ê±´ê°• íŒ ë°›ì•„ê°€ì„¸ìš”!",
            "display_text": "íŒ”ë¡œìš°í•˜ê³ \\nê±´ê°• íŒ ë°›ê¸°! ğŸ’™",
            "image_prompt": ""
        }}
    ],
    "hashtags": ["#1ë¶„ê±´ê°•í†¡", "#ê±´ê°•ì •ë³´", "#ê±´ê°•ê¿€íŒ", "#ê±´ê°•", "#ê±´ê°•ì†Œì‹", "#ê±´ê°•ì´ìŠˆ", "#ì˜í•™", ...],
    "description": "Hook ì²«ì¤„\\n\\në³¸ë¬¸ 2~3ì¤„\\n\\nì–¸ì  ê°„ ì“¸ë°ê°€ ìˆì–´ìš”, ì„¸ìƒì˜ ëª¨ë“  ê±´ê°• ì´ì•¼ê¸°\\nğŸ‘‰ğŸ‘‰ @1min_health_tok íŒ”ë¡œìš°í•˜ê¸° ğŸ‘ˆğŸ‘ˆ"
}}
```
"""


# ê¸°ë³¸ í•´ì‹œíƒœê·¸ (ì‹¤ì œ ë°ì´í„°ì—ì„œ ê°€ì¥ ë†’ì€ ë¹ˆë„)
_BASE_HASHTAGS = [
    "#1ë¶„ê±´ê°•í†¡", "#ê±´ê°•ì •ë³´", "#ê±´ê°•ê¿€íŒ", "#ê±´ê°•", "#ê±´ê°•ì†Œì‹", "#ê±´ê°•ì´ìŠˆ", "#ì˜í•™",
]

_SIGNATURE = "ì–¸ì  ê°„ ì“¸ë°ê°€ ìˆì–´ìš”, ì„¸ìƒì˜ ëª¨ë“  ê±´ê°• ì´ì•¼ê¸°"
_CTA = "ğŸ‘‰ğŸ‘‰ @1min_health_tok íŒ”ë¡œìš°í•˜ê¸° ğŸ‘ˆğŸ‘ˆ"


def _ensure_viral_patterns(script: dict) -> dict:
    """ë°”ì´ëŸ´ íŒ¨í„´ì´ ì ìš©ë˜ì—ˆëŠ”ì§€ í›„ì²˜ë¦¬ ë³´ì •."""
    # 1. ê¸°ë³¸ í•´ì‹œíƒœê·¸ ë³´ì¥
    tags = script.get("hashtags", [])
    for base_tag in _BASE_HASHTAGS:
        if base_tag not in tags:
            tags.insert(0, base_tag)
    # ì¤‘ë³µ ì œê±° + ìˆœì„œ ìœ ì§€
    seen = set()
    unique_tags = []
    for t in tags:
        if t not in seen:
            seen.add(t)
            unique_tags.append(t)
    script["hashtags"] = unique_tags[:17]  # ìµœëŒ€ 17ê°œ

    # 2. descriptionì— ì‹œê·¸ë‹ˆì²˜/CTA ë³´ì¥
    desc = script.get("description", "")
    if _SIGNATURE not in desc:
        desc = desc.rstrip() + f"\n\n{_SIGNATURE}"
    if "@1min_health_tok" not in desc:
        desc = desc.rstrip() + f"\n{_CTA}"
    # ê³¼ë„í•˜ê²Œ ê¸¸ë©´ ìë¥´ê¸°
    if len(desc) > 250:
        # Hook ì²«ì¤„ + ì‹œê·¸ë‹ˆì²˜ + CTAë§Œ ìœ ì§€
        first_line = desc.split("\n")[0]
        desc = f"{first_line}\n\n{_SIGNATURE}\n{_CTA}"
    script["description"] = desc

    # 3. closing narration ë³´ì •
    slides = script.get("slides", [])
    for s in slides:
        if s.get("type") == "closing":
            narr = s.get("narration", "")
            if "1ë¶„ê±´ê°•í†¡" not in narr:
                s["narration"] = "1ë¶„ê±´ê°•í†¡ì´ì—ˆìŠµë‹ˆë‹¤. íŒ”ë¡œìš°í•˜ê³  ê±´ê°• íŒ ë°›ì•„ê°€ì„¸ìš”!"

    return script


def generate_reels_script(topic: str, num_slides: int = 6) -> dict | None:
    """ë¦´ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±.

    Args:
        topic: ì£¼ì œ (ì˜ˆ: "ê²¨ìš¸ì²  ì¼êµì°¨ ê±´ê°•ê´€ë¦¬")
        num_slides: ì´ ìŠ¬ë¼ì´ë“œ ìˆ˜ (5~8, hook+content+closing)

    Returns: ìŠ¤í¬ë¦½íŠ¸ dict or None
    """
    content_count = num_slides - 2  # hook, closing ì œì™¸
    system = _REELS_SYSTEM.format(num_slides=num_slides, content_count=content_count)

    user = f"""ë‹¤ìŒ ì£¼ì œë¡œ ë¦´ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.

ì£¼ì œ: {topic}
ìŠ¬ë¼ì´ë“œ ìˆ˜: {num_slides}ì¥ (hook 1ì¥ + content {content_count}ì¥ + closing 1ì¥)

âš¡ í•µì‹¬ ì§€ì¹¨:
- Hook ì²« ì¤„ì€ ë°˜ë“œì‹œ "ìˆ«ì/í†µê³„ + ì§ˆë¬¸ ë˜ëŠ” ì¶©ê²©" ì¡°í•© ì‚¬ìš©
- ê³µìœ í•˜ê³  ì‹¶ì–´ì§€ëŠ” "ì™€ ì´ê±° ì§„ì§œ?" ë°˜ì‘ì„ ìœ ë°œí•˜ëŠ” ì½˜í…ì¸ 
- ë‚˜ë ˆì´ì…˜ì€ ì¹œêµ¬ì—ê²Œ ë§í•˜ë“¯ ìì—°ìŠ¤ëŸ¬ìš´ êµ¬ì–´ì²´
- description(ìº¡ì…˜)ì€ 200ì ë¯¸ë§Œìœ¼ë¡œ ì§§ê³  ì„íŒ©íŠ¸ ìˆê²Œ

ë°˜ë“œì‹œ JSONë§Œ ì¶œë ¥í•˜ì„¸ìš”."""

    raw = _call_llm(system, user, temperature=0.7, max_tokens=2500)
    if not raw:
        logger.error("ë¦´ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ LLM í˜¸ì¶œ ì‹¤íŒ¨")
        return None

    try:
        match = re.search(r"\{[\s\S]*\}", raw)
        if not match:
            logger.error("ë¦´ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ JSON íŒŒì‹± ì‹¤íŒ¨: JSON ë¸”ë¡ ì—†ìŒ")
            return None
        script = json.loads(match.group(0))
        # ê¸°ë³¸ ê²€ì¦
        if "slides" not in script or not isinstance(script["slides"], list):
            logger.error("ë¦´ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ ê²€ì¦ ì‹¤íŒ¨: slides ì—†ìŒ")
            return None
        if len(script["slides"]) < 3:
            logger.error(f"ë¦´ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ ê²€ì¦ ì‹¤íŒ¨: ìŠ¬ë¼ì´ë“œ {len(script['slides'])}ê°œ (ìµœì†Œ 3ê°œ)")
            return None
        # ë°”ì´ëŸ´ íŒ¨í„´ í›„ì²˜ë¦¬
        script = _ensure_viral_patterns(script)
        return script
    except (json.JSONDecodeError, AttributeError) as e:
        logger.error(f"ë¦´ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ íŒŒì‹± ì‹¤íŒ¨: {e}")
        return None
